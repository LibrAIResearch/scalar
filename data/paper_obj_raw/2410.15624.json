{
  "title": "Test-time Adaptation for Cross-modal Retrieval with Query Shift",
  "abstract": "The success of most existing cross-modal retrieval methods heavily relies on\nthe assumption that the given queries follow the same distribution of the\nsource domain. However, such an assumption is easily violated in real-world\nscenarios due to the complexity and diversity of queries, thus leading to the\nquery shift problem. Specifically, query shift refers to the online query\nstream originating from the domain that follows a different distribution with\nthe source one. In this paper, we observe that query shift would not only\ndiminish the uniformity (namely, within-modality scatter) of the query modality\nbut also amplify the gap between query and gallery modalities. Based on the\nobservations, we propose a novel method dubbed Test-time adaptation for\nCross-modal Retrieval (TCR). In brief, TCR employs a novel module to refine the\nquery predictions (namely, retrieval results of the query) and a joint\nobjective to prevent query shift from disturbing the common space, thus\nachieving online adaptation for the cross-modal retrieval models with query\nshift. Expensive experiments demonstrate the effectiveness of the proposed TCR\nagainst query shift. The code will be released upon acceptance.",
  "paper_id": "http://arxiv.org/abs/2410.15624v1",
  "markdown_content": "\\\\etocdepthtag\n\n.tocmtchapter\n\\\\etocsettagdepthmtchaptersubsubsection\n\\\\etocsettagdepthmtappendixnone\n\n\n\n# Test-time Adaptation for Cross-modal    Retrieval with Query Shift\n\nHaobin Li1‚ÄÉPeng Hu1‚ÄÉQianjun Zhang2‚ÄÉXi Peng1,3‚ÄÉXitingLiu4‚ÄÉMouxing Yang1\n\nCollege of Computer Science, Sichuan University, China.1‚ÄÉSouthwest Jiaotong University, China.2\n\nState Key Laboratory of Hydraulics and Mountain River Engineering, Sichuan University, China.3\n\nGeorgia Institute of Technology, USA.4\n\n{haobinli.gm, penghu.ml, pengx.gm, liu.xt0617, yangmouxing}@gmail.com, zqjblue@163.com\nCorresponding author.\n\n###### Abstract\n\nThe success of most existing cross-modal retrieval methods heavily relies on the assumption that the given queries follow the same distribution of the source domain.\nHowever, such an assumption is easily violated in real-world scenarios due to the complexity and diversity of queries, thus leading to the query shift problem.\nSpecifically, query shift refers to the online query stream originating from the domain that follows a different distribution with the source one.\nIn this paper, we observe that query shift would not only diminish the uniformity (namely, within-modality scatter) of the query modality but also amplify the gap between query and gallery modalities.\nBased on the observations, we propose a novel method dubbed Test-time adaptation for Cross-modal Retrieval (TCR).\nIn brief, TCR employs a novel module to refine the query predictions (namely, retrieval results of the query) and a joint objective to prevent query shift from disturbing the common space, thus achieving online adaptation for the cross-modal retrieval models with query shift.\nExpensive experiments demonstrate the effectiveness of the proposed TCR against query shift.\nThe code will be released upon acceptance.\n\n## 1 Introduction\n\nGiven queries of interest, cross-modal retrieval (Faghri et al., [2017](https://ar5iv.org/html/2410.15624#bib.bib9 \"\"); Lee et al., [2018](https://ar5iv.org/html/2410.15624#bib.bib21 \"\"); Yan et al., [2023](https://ar5iv.org/html/2410.15624#bib.bib46 \"\"); Wang et al., [2023](https://ar5iv.org/html/2410.15624#bib.bib44 \"\")) try to associate some relevant samples from the gallery set across various modalities, supporting numerous applications such as intelligent surveillance and search engine.\nThe key to cross-modal retrieval is learning a well-established common space, hoping to distinguish different instances within the same modality while gathering the same instance across different modalities.\nRecently, the pre-trained models (Jia et al., [2021](https://ar5iv.org/html/2410.15624#bib.bib16 \"\"); Yang et al., [2022](https://ar5iv.org/html/2410.15624#bib.bib47 \"\"); Li et al., [2023](https://ar5iv.org/html/2410.15624#bib.bib23 \"\"); Huang et al., [2024](https://ar5iv.org/html/2410.15624#bib.bib15 \"\")) have emerged as the dominant paradigm for cross-modal retrieval.\nAs shown in Fig. [1](https://ar5iv.org/html/2410.15624#S1.F1 \"Figure 1 ‚Ä£ 1 Introduction ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a), after acquiring generic knowledge from the source domain, the pre-trained models can either perform zero-shot retrieval in the target domains or be fine-tuned on domain-specific data for customization.\n\nDespite the promising performance of the pre-trained models, their success heavily relies on the assumption that the given queries exactly follow the same distribution from the source domain, which is hard to satisfy in real-world applications.\nSpecifically, as shown in Fig. [1](https://ar5iv.org/html/2410.15624#S1.F1 \"Figure 1 ‚Ä£ 1 Introduction ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(b), inquirers might embrace different cultural backgrounds or enjoy their individual preferences, resulting in the online query stream derived from either scarce or highly personalized domains.\nClearly, such out-of-domain queries violate the identical distribution assumption and thus lead to the query shift problem.\nAs a result, the existing cross-modal retrieval models fail to handle the query shift and inevitably suffer from significant performance degradation, leaving an urgent need to develop an online adaptation method for addressing the query shift problem.\n\n![Refer to caption](https://ar5iv.org/html/2410.15624/assets/x1.png)Figure 1:\n(a) Dominant Paradigm:\nthe pre-trained models embrace powerful zero-shot retrieval capacity and could be fine-tuned on domain-specific data for customization, which has emerged as the dominant paradigm for cross-modal retrieval.\n(b) Query Shift:\nthe performance of the paradigm would be significantly degraded when encountering the query shift problem.\nOn the one hand, collecting sufficient data to tailor the pre-trained models for scarce domains is daunting and even impossible.\nOn the other hand, as the saying goes, ‚ÄúDifferent strokes for different folks‚Äù, even fine-tuned models cannot accommodate all personalized domains.\n(c) Observations: we study the query shift problem for cross-modal retrieval and reveal the following observations.\nNamely, query shift not only diminishes the uniformity of the query modality but also amplifies the modality gap between the query and gallery modalities, undermining the well-structured common space inherited from pre-trained models.\n\nAs one of the most effective paradigms in reconciling distribution shifts, Test-Time Adaptation (TTA) methods (Wang et al., [2021](https://ar5iv.org/html/2410.15624#bib.bib43 \"\"); Press et al., [2023](https://ar5iv.org/html/2410.15624#bib.bib38 \"\"); Niu et al., [2024](https://ar5iv.org/html/2410.15624#bib.bib34 \"\")) work by continually updating the given source model using the online target data stream.\nAlthough achieving great success, it is intractable to adopt existing TTA methods for cross-modal retrieval with query shift due to the following two reasons.\nOn the one hand, most existing TTA methods focus on the unimodal setting while overlooking the complexity of the query shift in the cross-modal setting.\nMore specifically, the query shift in the cross-modal setting would not only affect the intra-modality distribution but also hinder the cross-modal alignment.\nOn the other hand, most existing TTA methods are specifically designed for the recognition task, which would struggle with the heavy noise from the query predictions if simply applied to the retrieval task.\nIntuitively, for a given sample or query, it has a random probability of 1/K1ùêæ1/K or 1/N1ùëÅ1/N to be correctly associated with the desirable category or cross-modal counterpart in the recognition task or retrieval task, where KùêæK and NùëÅN denote the class number and candidate number, respectively, with N‚â´Kmuch-greater-thanùëÅùêæN\\\\gg K.\n\nTo specifically develop a TTA method for cross-modal retrieval with the query shift, we first present two key observations as illustrated in Fig. [1](https://ar5iv.org/html/2410.15624#S1.F1 \"Figure 1 ‚Ä£ 1 Introduction ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(c).\nTo summarize, we conclude that the query shift would diminish the uniformity of the query modality, prohibiting discrimination between diverse queries in the common space.\nMoreover, query shift would amplify the modality gap between query and gallery modalities, undermining the well-constructed common space established by the pre-trained models.\n\nBased on the above observations, we propose achieving robust cross-modal retrieval against the query shift by endowing the existing TTA methods with the capacity to manipulate both the modality uniformity and modality gap.\nTo be specific, we propose a novel method, dubbed Test-time adaptation for Cross-modal Retrieval (TCR), which consists of a novel query prediction refinement module and a novel joint objective function.\nFirst, the query prediction refinement module is adopted to refine the retrieval results of the existing TTA methods and thus obtain the retrieval-favorable predictions for queries.\nAfter that, the joint objective is employed on the refined query predictions to achieve online adaptation for cross-modal retrieval models under query shift.\nMore specifically, the joint objective function is composed of three individual losses that embrace the following merits.\nTo enhance the uniformity of the query modality, the intra-modality uniformity learning loss performs contrast between queries and their respective centers, thus guaranteeing the discrimination between queries.\nTo rectify the modality gap between the query and gallery modalities, the inter-modality gap learning loss narrows the difference between the query and gallery modalities with the plausible constraint estimated from off-the-shelf models, thus inheriting the well-established common space.\nTo prevent overfitting on noisy query predictions, the noise-robust adaptation loss amplifies the contribution of high-confident predictions while alleviating the noisy ones with a self-adaptive threshold.\nThe major contributions of this work could be summarized as follows.\n\n- ‚Ä¢\n\n\nTo the best of our knowledge, this work could be one of the first studies on the query shift problem, revealing its underlying impacts on cross-modal retrieval. Specifically, the query shift would not only diminish the uniformity of the query modality but also amplify the modality gap between query and gallery modalities, undermining the well-established common space derived from the source model.\n\n- ‚Ä¢\n\n\nWe propose a novel test-time adaptation method named TCR. TCR first employs a novel module to refine the query predictions, thus supporting the existing TTA methods for cross-modal retrieval. Then, TCR adopts a novel objective function that can not only manipulate both the modality uniformity and modality gap but also prevent the model from overfitting noisy query predictions, thus achieving robust cross-modal retrieval with query shift.\n\n- ‚Ä¢\n\n\nExtensive experiments verify the effectiveness of the proposed method. Furthermore, we benchmark the existing TTA methods on cross-modal retrieval with query shift across six widely-used image-text datasets, hoping to facilitate the study of test-time adaptation beyond unimodal tasks.\n\n\n## 2 Related Work\n\nIn this section, we briefly review two topics related to this\nwork, i.e., domain adaptation for cross-modal retrieval and test-time adaptation.\n\n### 2.1 Domain Adaptation for Cross-modal Retrieval\n\nCross-modal retrieval aims to establish a well-structured common space, where semantically-relevant candidates could be prioritized for the queries.\nHowever, most existing cross-modal retrieval methods implicitly assume that the given queries follow the same distribution as the source data.\nUnfortunately, such an ideal assumption is easily violated due to the complexity of real-world applications, leading to the query shift problem as discussed in Introduction.\nTo address the problem, some Unsupervised Domain Adaptation (UDA) methods have been proposed to reconcile the distribution differences for robust cross-modal retrieval.\nBased on the way to achieve robustness against query shift, these approaches could be roughly grouped into the following three categories:\ni) pseudo-labeling methods (Munro et al., [2021](https://ar5iv.org/html/2410.15624#bib.bib31 \"\"); Hao et al., [2023](https://ar5iv.org/html/2410.15624#bib.bib14 \"\")), which first select the most relevant cross-modal pairs as positives while treating the irrelevant pairs as negatives and then conduct metric learning upon the pairs to adapt the model for target domains;\nii) domain alignment methods (Peng & Chi, [2019](https://ar5iv.org/html/2410.15624#bib.bib36 \"\")), which mitigate distribution discrepancies between the target and source domains by resorting to the maximum mean discrepancy minimization or mutual information minimization approaches;\niii) prototype-based methods (Liu et al., [2021a](https://ar5iv.org/html/2410.15624#bib.bib27 \"\"); Chen et al., [2021](https://ar5iv.org/html/2410.15624#bib.bib7 \"\")), which first constructs different sets of prototypes to represent various domains and then achieves domain adaptation by minimizing the KL divergence between the corresponding prototype sets.\n\nDespite the promising performance, the existing domain adaptation works for cross-modal retrieval require accessing the entire target domain.\nAs a result, these works cannot achieve adaptation for the online query stream, limiting their practicability in real-time scenarios such as search engine.\nDifferent from them, this paper proposes a new adaptation method for addressing the query shift problem, which could be one of the first online adaptation approaches for cross-modal retrieval.\n\n### 2.2 Test-time adaptation\n\nTest-time Adaptation (TTA) has emerged as a promising avenue for domain adaptation, which aims to reconcile the distribution shifts in an online manner.\nTowards achieving this goal, some Test-Time Training (TTT) approaches (Sun et al., [2020](https://ar5iv.org/html/2410.15624#bib.bib42 \"\"); Liu et al., [2021b](https://ar5iv.org/html/2410.15624#bib.bib28 \"\"); Gandelsman et al., [2022](https://ar5iv.org/html/2410.15624#bib.bib10 \"\")) have been proposed, which require modifying the training process of the source model and adding an auxiliary self-supervised task.\nAs a result, the source model could be adapted by performing the self-supervised task on the online target data stream.\nTo avoid the reduplicated training cost of the source model, Fully Test-Time Adaptation Wang et al. ( [2021](https://ar5iv.org/html/2410.15624#bib.bib43 \"\")) paradigm has been proposed, which could be coarsely divided into the following three categories: i) online TTA methods (Yuan et al., [2024](https://ar5iv.org/html/2410.15624#bib.bib49 \"\"); Chen et al., [2022](https://ar5iv.org/html/2410.15624#bib.bib6 \"\")), which continually update the normalization layers by resorting to the unsupervised objectives, such as entropy minimization or its variants. ii) robust TTA methods (Lee et al., [2024](https://ar5iv.org/html/2410.15624#bib.bib20 \"\"); Zancato et al., [2023](https://ar5iv.org/html/2410.15624#bib.bib50 \"\")), which strive to improve the robustness against noisy predictions, mixed distribution shifts, label shifts, and so on. iii) TTA beyond recognition, which focuses on the tasks including but not limited to image restoration (Gou et al., [2024](https://ar5iv.org/html/2410.15624#bib.bib11 \"\")), multimodal recognition (Yang et al., [2024](https://ar5iv.org/html/2410.15624#bib.bib48 \"\")), and multimodal segmentation (Cao et al., [2023](https://ar5iv.org/html/2410.15624#bib.bib2 \"\")).\n\nIn this paper, we focus on online TTA for achieving robust cross-modal retrieval against query shift.\nAmong existing approaches, DISC (Ma et al., [2024](https://ar5iv.org/html/2410.15624#bib.bib30 \"\")) is most relevant to our work, while having significantly different motivations.\nIn brief, DISC is designed to adapt the pre-trained image hashing models against the distribution shift for achieving effective retrieval in the target domain.\nDifferent from DISC, our work focuses on addressing the query shift problem for cross-modal retrieval, which is less-touched by the existing studies.\nMoreover, unlike DISC that requires accessing the source data to train the hashing model, our TCR could adapt the off-the-shelf pre-trained models without using the source data.\n\n![Refer to caption](https://ar5iv.org/html/2410.15624/assets/x2.png)Figure 2:\nOverview of the proposed TCR.\nFor the given online queries, the modality-specific encoders are employed to project the query and gallery samples into the latent space established by the source model.\nThe obtained query embeddings and gallery embeddings are passed into the query prediction refinement module.\nIn the module, TCR first selects the most similar gallery sample for each query and obtain the query-gallery pairs.\nAfter that, the pairs with higher uniformity and lower modality gap are chosen to estimate the filtering threshold of query predictions and modality gap of the source model as the constraints for the adaptation.\nFinally, three loss functions are employed to achieve robust adaptation for cross-modal retrieval with query shift.\n\n## 3 Method\n\nIn this section, we introduce the proposed Test-time adaptation for Cross-modal Retrieval (TCR) to handle the query shift problem for cross-modal retrieval.\nThe section is structured as follows.\nIn Section [3.1](https://ar5iv.org/html/2410.15624#S3.SS1 \"3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we present the formal definition of the query shift problem and design a simple baseline to facilitate TTA for cross-modal retrieval.\nIn Section [3.2](https://ar5iv.org/html/2410.15624#S3.SS2 \"3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we propose the query prediction refinement module to derive the retrieval-favorable query predictions.\nIn Section [3.3](https://ar5iv.org/html/2410.15624#S3.SS3 \"3.3 Intra-modality Uniformity Learning ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")- [3.5](https://ar5iv.org/html/2410.15624#S3.SS5 \"3.5 Noise-robust Adaptation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we design a novel joint objective function to achieve robust cross-modal retrieval against query shift.\n\n### 3.1 Notations and Problem Formulation\n\nWithout loss of generality, we take two modalities as a showcase to elaborate on the query shift problem.\nLet fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}} denote the multimodal model pre-trained on the source-domain data ùíüSsubscriptùíüùëÜ\\\\mathcal{D}\\_{S}, which consists of two modality-specific encoders, i.e., fŒòsQsubscriptùëìsubscriptsuperscriptŒòùëÑùë†f\\_{\\\\Theta^{Q}\\_{s}} and fŒòsGsubscriptùëìsubscriptsuperscriptŒòùê∫ùë†f\\_{\\\\Theta^{G}\\_{s}}.\nFor a given query ùê±iQsubscriptsuperscriptùê±ùëÑùëñ\\\\mathbf{x}^{Q}\\_{i} from the target domain data ùíüT={ùêóQ={ùê±iQ}i=1NQ,ùêóG={ùê±jG}j=1NG}subscriptùíüùëáformulae-sequencesuperscriptùêóùëÑsuperscriptsubscriptsuperscriptsubscriptùê±ùëñùëÑùëñ1superscriptùëÅùëÑsuperscriptùêóùê∫superscriptsubscriptsuperscriptsubscriptùê±ùëóùê∫ùëó1superscriptùëÅùê∫\\\\mathcal{D}\\_{T}=\\\\left\\\\{\\\\mathbf{X}^{Q}=\\\\{\\\\mathbf{x}\\_{i}^{Q}\\\\}\\_{i=1}^{N^{Q}},\\\\mathbf{X}^{G}=\\\\{\\\\mathbf{x}\\_{j}^{G}\\\\}\\_{j=1}^{N^{G}}\\\\right\\\\}, cross-modal retrieval aims to associate the corresponding sample ùê±jGsubscriptsuperscriptùê±ùê∫ùëó\\\\mathbf{x}^{G}\\_{j} from the gallery set ùêóGsuperscriptùêóùê∫\\\\mathbf{X}^{G} by resorting to the common space established by fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}}, where QùëÑQ and Gùê∫G denotes as query modality and gallery modality for clarity in the following.\nIn real-world applications, the given queries are usually from the distribution distinct with the source-domain data, i.e., ùí´‚Äã(ùíüT)‚àºÃ∏ùí´‚Äã(ùíüS)not-similar-toùí´subscriptùíüùëáùí´subscriptùíüùëÜ\\\\mathcal{P}\\\\left(\\\\mathcal{D}\\_{T}\\\\right)\\\\not\\\\sim\\\\mathcal{P}\\\\left(\\\\mathcal{D}\\_{S}\\\\right), where ùí´‚Äã(ùíü)ùí´ùíü\\\\mathcal{P}\\\\left(\\\\mathcal{D}\\\\right) denotes the distribution of the given data ùíüùíü\\\\mathcal{D}.\nAs a result, such a query shift problem would lead to the performance degradation of fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}} as verified in the experiments.\n\nTo achieve online adaptation for fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}} with query shift, we first propose a simple baseline that endows the unimodal-recognition-oriented TTA approaches with the capacity to handle the cross-modal retrieval task.\nTo be specific, we formulate the retrieval task as a query prediction process in analogy with the recognition task that assigns the given samples to their corresponding categories.\nFormally, for a given online batch of queries with size BùêµB, the corresponding query predictions could be defined as\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ùê©=Softmax‚Å°(ùê≥Q‚Äã(ùêôG)T/œÑ),ùê©Softmaxsuperscriptùê≥ùëÑsuperscriptsuperscriptùêôùê∫ùëáùúè\\\\mathbf{p}=\\\\operatorname{Softmax}\\\\left(\\\\mathbf{z}^{Q}\\\\left(\\\\mathbf{Z}^{G}\\\\right)^{T}/\\\\tau\\\\right), |  | (1) |\n\nwhere œÑùúè\\\\tau is the temperature that controls the trade-off between the smoothness and sharpness of the predictions, ùê≥Q=fŒòsQ‚Äã(ùê±Q)‚àà‚ÑùB√óDsuperscriptùê≥ùëÑsubscriptùëìsubscriptsuperscriptŒòùëÑùë†superscriptùê±ùëÑsuperscript‚Ñùùêµùê∑\\\\mathbf{z}^{Q}=f\\_{\\\\Theta^{Q}\\_{s}}(\\\\mathbf{x}^{Q})\\\\in\\\\mathbb{R}^{B\\\\times D} and ùêôG=fŒòsG‚Äã(ùêóG)‚àà‚ÑùNG√óDsuperscriptùêôùê∫subscriptùëìsubscriptsuperscriptŒòùê∫ùë†superscriptùêóùê∫superscript‚ÑùsuperscriptùëÅùê∫ùê∑\\\\mathbf{Z}^{G}=f\\_{\\\\Theta^{G}\\_{s}}(\\\\mathbf{X}^{G})\\\\in\\\\mathbb{R}^{N^{G}\\\\times D} are the ‚Ñì‚Äã2‚Ñì2\\\\ell 2-normalized embeddings with the dimensionality of Dùê∑D for the given query and gallery samples, respectively.\nThanks to the above formulation, most existing TTA methods could be adopted to handle the query shift challenge with the following objective,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | minŒò~‚Å°‚ÑíT‚ÄãT‚ÄãA‚Äã(ùê©),subscript~Œòsubscript‚Ñíùëáùëáùê¥ùê©\\\\min\\_{\\\\tilde{\\\\Theta}}\\\\mathcal{L}\\_{TTA}\\\\left(\\\\mathbf{p}\\\\right), |  | (2) |\n\nwhere Œò~‚äÜŒòs~ŒòsubscriptŒòùë†\\\\tilde{\\\\Theta}\\\\subseteq\\\\Theta\\_{s} is the learnable parameters.\nHowever, such a simple formulation of query prediction would result in either model underfitting or overfitting even with carefully tuning of œÑùúè\\\\tau due to the variable gallery sizes, as verified in Table [3](https://ar5iv.org/html/2410.15624#S4.T3 \"Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Fig. [4](https://ar5iv.org/html/2410.15624#S4.F4 \"Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a).\nFurthermore, such a simple baseline overlooks the underlying influences behind the query shift problem and thus fails to achieve promising performance as discussed in Introduction.\nOn the one hand, the existing TTA methods cannot explicitly manipulate the intra-modality uniformity and inter-modality gap.\nOn the other hand, these methods struggle to account for the heavy noise from the query prediction.\n\nAs a remedy, we propose Test-time adaptation for Cross-modal Retrieval (TCR).\nAs shown in Fig. [2](https://ar5iv.org/html/2410.15624#S2.F2 \"Figure 2 ‚Ä£ 2.2 Test-time adaptation ‚Ä£ 2 Related Work ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), for the given online batch of queries, TCR first employs the novel query prediction refinement module to obtain the retrieval-favorable predictions ùê©^^ùê©\\\\hat{\\\\mathbf{p}}.\nAfter that, the following joint objective consisting of three novel loss functions is adopted to achieve robust cross-modal retrieval against the query shift, i.e.,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | minŒò~‚Å°‚Ñí‚Äã(ùê©^),subscript~Œò‚Ñí^ùê©\\\\min\\_{\\\\tilde{\\\\Theta}}\\\\mathcal{L}\\\\left(\\\\hat{\\\\mathbf{p}}\\\\right), |  | (3) |\n\nwhere ‚Ñí=‚ÑíM‚ÄãU+‚ÑíM‚ÄãG+‚ÑíN‚ÄãA‚Ñísubscript‚ÑíùëÄùëàsubscript‚ÑíùëÄùê∫subscript‚ÑíùëÅùê¥\\\\mathcal{L}=\\\\mathcal{L}\\_{MU}+\\\\mathcal{L}\\_{MG}+\\\\mathcal{L}\\_{NA}, with ‚ÑíM‚ÄãUsubscript‚ÑíùëÄùëà\\\\mathcal{L}\\_{MU}, ‚ÑíM‚ÄãGsubscript‚ÑíùëÄùê∫\\\\mathcal{L}\\_{MG}, and ‚ÑíN‚ÄãAsubscript‚ÑíùëÅùê¥\\\\mathcal{L}\\_{NA} denote the intra-modality uniformity learning loss, inter-modality gap learning loss, and the noise-robust adaptation loss, respectively.\nIn the following, we will elaborate on each loss individually.\n\n### 3.2 Query Prediction Refinement\n\nIn this section, we introduce the query prediction refinement module which involves refining the prediction for the given queries and estimating the constraints to support the optimization of Eq. [3](https://ar5iv.org/html/2410.15624#S3.E3 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\n\n#### 3.2.1 Candidate Selection\n\nTo break the dilemma of vanilla query prediction formulation in Eq. [1](https://ar5iv.org/html/2410.15624#S3.E1 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we propose selecting a subset of candidates from the gallery and then establishing new query predictions for the given queries.\nMathematically, for each given query ùê±iQsubscriptsuperscriptùê±ùëÑùëñ\\\\mathbf{x}^{Q}\\_{i}, the corresponding candidate in the gallery is obtain via\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ùê±iG‚Ä≤=ùí©‚Äã(ùê±iQ),subscriptsuperscriptùê±superscriptùê∫‚Ä≤ùëñùí©subscriptsuperscriptùê±ùëÑùëñ\\\\mathbf{x}^{G^{\\\\prime}}\\_{i}=\\\\mathcal{N}(\\\\mathbf{x}^{Q}\\_{i}), |  | (4) |\n\nwhere ùí©‚Äã(‚ãÖ)ùí©‚ãÖ\\\\mathcal{N}(\\\\cdot) denotes the selection manner, and we adopt the nearest neighborhood selection in the common space for simplicity.\nIn other words, we retrieve the most similar sample from the gallery set for each query and thus obtain query-candidate pairs (ùê≥Q,ùê≥G‚Ä≤)superscriptùê≥ùëÑsuperscriptùê≥superscriptùê∫‚Ä≤(\\\\mathbf{z}^{Q},\\\\mathbf{z}^{G^{\\\\prime}}).\nConsequently, the refined query predictions for the online-batched queries ùê±Qsuperscriptùê±ùëÑ\\\\mathbf{x}^{Q} could be formulated as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ùê©^=Softmax‚Å°(ùê≥Q‚Äã(ùêôG‚Ä≤)T/œÑ),^ùê©Softmaxsuperscriptùê≥ùëÑsuperscriptsuperscriptùêôsuperscriptùê∫‚Ä≤ùëáùúè\\\\mathbf{\\\\hat{p}}=\\\\operatorname{Softmax}\\\\left(\\\\mathbf{z}^{Q}\\\\left(\\\\mathbf{Z}^{G^{\\\\prime}}\\\\right)^{T}/\\\\tau\\\\right), |  | (5) |\n\nwhere ùêôG‚Ä≤superscriptùêôsuperscriptùê∫‚Ä≤\\\\mathbf{Z}^{G^{\\\\prime}} are the embeddings of the selected candidates for ùê±Qsuperscriptùê±ùëÑ\\\\mathbf{x}^{Q}.\nThe query prediction refinement manner embraces the following two merits.\nOn the one hand, the query prediction refinement manner could exclude some irrelevant samples in the gallery, thus preventing the model from overfitting to some extent.\nOn the other hand, the excluded irrelevant samples would avoid looking for a needle in a bottle of hay for queries, thus alleviating the model underfitting issue.\n\n#### 3.2.2 Constraint Estimation\n\nIt is widely acknowledged that source data could effectively regulate the domain adaptation process (Long et al., [2017](https://ar5iv.org/html/2410.15624#bib.bib29 \"\"); Kang et al., [2019](https://ar5iv.org/html/2410.15624#bib.bib18 \"\")), thus circumventing the catastrophic forgetting issue.\nDue to the unavailability of the source data in the test-time adaptation, we propose further choosing some source-domain-like data from the selected query-candidate pairs to estimate desirable constraints that support the optimization of Eq. [3](https://ar5iv.org/html/2410.15624#S3.E3 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nTo this end, we first design a criterion for choosing the query-candidate pair (ùê≥iQ,ùê≥iG‚Ä≤)superscriptsubscriptùê≥ùëñùëÑsuperscriptsubscriptùê≥ùëñsuperscriptùê∫‚Ä≤(\\\\mathbf{z}\\_{i}^{Q},\\\\mathbf{z}\\_{i}^{G^{\\\\prime}}), i.e.,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | SI=2‚Äã(‚Äñùê≥iQ‚àíùê≥iG‚Ä≤‚Äñ)‚àí(‚Äñùê≥iQ‚àíùê≥¬ØQ‚Äñ+‚Äñùê≥iG‚Ä≤‚àíùê≥¬ØG‚Ä≤‚Äñ),SI2normsuperscriptsubscriptùê≥ùëñùëÑsuperscriptsubscriptùê≥ùëñsuperscriptùê∫‚Ä≤normsuperscriptsubscriptùê≥ùëñùëÑsuperscript¬Øùê≥ùëÑnormsuperscriptsubscriptùê≥ùëñsuperscriptùê∫‚Ä≤superscript¬Øùê≥superscriptùê∫‚Ä≤\\\\text{SI}=2\\\\left(\\\\\\|\\\\mathbf{z}\\_{i}^{Q}-\\\\mathbf{z}\\_{i}^{G^{\\\\prime}}\\\\\\|\\\\right)-\\\\left(\\\\\\|\\\\mathbf{z}\\_{i}^{Q}-\\\\overline{\\\\mathbf{z}}^{Q}\\\\\\|+\\\\\\|\\\\mathbf{z}\\_{i}^{G^{\\\\prime}}-\\\\overline{\\\\mathbf{z}}^{G^{\\\\prime}}\\\\\\|\\\\right), |  | (6) |\n\nwhere ùê≥¬ØQ=1B‚Äã‚àëiBùê≥iQsuperscript¬Øùê≥ùëÑ1ùêµsuperscriptsubscriptùëñùêµsuperscriptsubscriptùê≥ùëñùëÑ\\\\overline{\\\\mathbf{z}}^{Q}=\\\\frac{1}{B}\\\\sum\\_{i}^{B}\\\\mathbf{z}\\_{i}^{Q} and ùê≥¬ØG‚Ä≤=1B‚Äã‚àëiBùê≥iG‚Ä≤superscript¬Øùê≥superscriptùê∫‚Ä≤1ùêµsuperscriptsubscriptùëñùêµsuperscriptsubscriptùê≥ùëñsuperscriptùê∫‚Ä≤\\\\overline{\\\\mathbf{z}}^{G^{\\\\prime}}=\\\\frac{1}{B}\\\\sum\\_{i}^{B}\\\\mathbf{z}\\_{i}^{G^{\\\\prime}} are the centers of the given queries and the selected candidates, respectively.\nIn the implementation, we choose 30%percent3030\\\\% query-candidate pairs with the smallest SI value, namely, (ùê≥Qm,ùê≥Gm‚Ä≤)superscriptùê≥subscriptùëÑùëösuperscriptùê≥subscriptsuperscriptùê∫‚Ä≤ùëö(\\\\mathbf{z}^{Q\\_{m}},\\\\mathbf{z}^{G^{\\\\prime}\\_{m}}) of size MùëÄM, as the source-domain-like data.\nClearly, a low value of the criterion has the incentive to select the query-candidate pairs with the small modality gap and high intra-modality uniformity, which have higher probability to be source-domain-like, as verified in Fig. [3](https://ar5iv.org/html/2410.15624#S4.F3 \"Figure 3 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\n\nBased on the selected source-domain-like data, we propose estimating the modality gap of the source model as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ŒîS=‚Äñ1M‚Äã‚àëiMùê≥iQm‚àí1M‚Äã‚àëjMùê≥jGm‚Ä≤‚Äñ,subscriptŒîùëÜnorm1ùëÄsuperscriptsubscriptùëñùëÄsubscriptsuperscriptùê≥subscriptùëÑùëöùëñ1ùëÄsuperscriptsubscriptùëóùëÄsubscriptsuperscriptùê≥superscriptsubscriptùê∫ùëö‚Ä≤ùëó\\\\Delta\\_{S}=\\\\left\\\\\\|\\\\frac{1}{M}\\\\sum\\_{i}^{M}\\\\mathbf{z}^{Q\\_{m}}\\_{i}-\\\\frac{1}{M}\\\\sum\\_{j}^{M}\\\\mathbf{z}^{G\\_{m}^{\\\\prime}}\\_{j}\\\\right\\\\\\|, |  | (7) |\n\nwhere ùê≥iQmsubscriptsuperscriptùê≥subscriptùëÑùëöùëñ\\\\mathbf{z}^{Q\\_{m}}\\_{i} and ùê≥jGm‚Ä≤subscriptsuperscriptùê≥superscriptsubscriptùê∫ùëö‚Ä≤ùëó\\\\mathbf{z}^{G\\_{m}^{\\\\prime}}\\_{j} denote the iùëñi-th query sample and the jùëój-th gallery sample in the query-candidate pairs, respectively.\nAs the another by-product, a desirable threshold that could filter the noise in the query predictions ùê©^^ùê©\\\\hat{\\\\mathbf{p}} could be adaptively determined as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | Em=maxi=1,‚Ä¶,M‚Å°E‚Äã(ùê±iQm),subscriptùê∏ùëösubscriptùëñ1‚Ä¶ùëÄùê∏superscriptsubscriptùê±ùëñsubscriptùëÑùëöE\\_{m}=\\\\max\\_{i=1,\\\\dots,M}E\\\\left(\\\\mathbf{x}\\_{i}^{Q\\_{m}}\\\\right), |  | (8) |\n\nwhere E‚Äã(‚ãÖ)ùê∏‚ãÖE\\\\left(\\\\cdot\\\\right) indicates the entropy based on the refined query predictions.\n\n### 3.3 Intra-modality Uniformity Learning\n\nAs discussed in Introduction, query shift would diminish the uniformity of the query modality, resulting in confused queries with lower discrimination in the common space.\nTo address the problem, we propose to perform the contrast between queries and their respective centers, thus explicitly enlarging the intra-modality uniformity.\nMathematically, the loss function of intra-modality uniformity learning is defined as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ‚ÑíM‚ÄãU=1B‚Äã‚àëiBe‚Äãx‚Äãp‚Äã(‚àí‚Äñùê≥iQ‚àíùê≥¬ØQ‚Äñ/t)subscript‚ÑíùëÄùëà1ùêµsuperscriptsubscriptùëñùêµùëíùë•ùëùnormsuperscriptsubscriptùê≥ùëñùëÑsuperscript¬Øùê≥ùëÑùë°\\\\mathcal{L}\\_{MU}=\\\\frac{1}{B}\\\\sum\\_{i}^{B}exp\\\\left(-\\\\\\|\\\\mathbf{z}\\_{i}^{Q}-\\\\overline{\\\\mathbf{z}}^{Q}\\\\\\|/t\\\\right) |  | (9) |\n\nwhere tùë°t is the trade-off parameter to control the uniformity that is fixed as 101010 in the experiments.\n\n### 3.4 Inter-modality Gap Leaning\n\nAs discussed in Introduction, query shift would amplify the modality gap between query and gallery modalities, disrupting the cross-modal alignment established by the source model.\nTo remedy this, we propose to rectify the difference between the query and gallery modalities to the estimated modality gap of the source model in Eq. [7](https://ar5iv.org/html/2410.15624#S3.E7 \"In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nFormally, the inter-modality gap learning loss is defined as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ‚ÑíM‚ÄãG=(ŒîT‚àíŒîS)2,subscript‚ÑíùëÄùê∫superscriptsubscriptŒîùëásubscriptŒîùëÜ2\\\\mathcal{L}\\_{MG}=\\\\left(\\\\Delta\\_{T}-\\\\Delta\\_{S}\\\\right)^{2}, |  | (10) |\n\nwhere ŒîT=‚Äñùê≥¬ØQ‚àíùê≥¬ØG‚Ä≤‚ÄñsubscriptŒîùëánormsuperscript¬Øùê≥ùëÑsuperscript¬Øùê≥superscriptùê∫‚Ä≤\\\\Delta\\_{T}=\\\\left\\\\\\|\\\\overline{\\\\mathbf{z}}^{Q}-\\\\overline{\\\\mathbf{z}}^{G^{\\\\prime}}\\\\right\\\\\\| denotes the modality gap of the target domain.\nThe key idea behind ‚ÑíM‚ÄãGsubscript‚ÑíùëÄùê∫\\\\mathcal{L}\\_{MG} is that the modality gap rectification would take advantage of well-aligned multimodal common space from the source model, thus boosting retrieval performance.\nNotably, as observed in Liang et al. ( [2022](https://ar5iv.org/html/2410.15624#bib.bib25 \"\")), over-eliminating the modality gap would not improve or even degrade the performance of the multimodal model.\nTherefore, we believe the proposed loss that rectifies the modality gap of the target model to a plausible constraint in a non-monotonic manner is reasonable.\nThe experimental results in Fig. [3](https://ar5iv.org/html/2410.15624#S4.F3 \"Figure 3 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") could support the claims.\n\n### 3.5 Noise-robust Adaptation\n\nTo achieve robustness against the heavy noise on the query predictions, we propose the following noise-robust adaptation loss,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ‚ÑíN‚ÄãA=1‚àëiùïÄ{S‚Äã(ùê±iQ)‚â†0}‚Äã‚àëi=1NQS‚Äã(ùê±iQ)‚ÄãE‚Äã(ùê±iQ),where‚ÄãS‚Äã(ùê±iQ)=max‚Å°(1‚àíE‚Äã(ùê±iQ)Em,0),formulae-sequencesubscript‚ÑíùëÅùê¥1subscriptùëñsubscriptùïÄùëÜsuperscriptsubscriptùê±ùëñùëÑ0superscriptsubscriptùëñ1superscriptùëÅùëÑùëÜsuperscriptsubscriptùê±ùëñùëÑùê∏superscriptsubscriptùê±ùëñùëÑwhereùëÜsuperscriptsubscriptùê±ùëñùëÑ1ùê∏superscriptsubscriptùê±ùëñùëÑsubscriptùê∏ùëö0\\\\mathcal{L}\\_{NA}=\\\\frac{1}{\\\\sum\\_{i}\\\\mathbb{I}\\_{\\\\{S(\\\\mathbf{x}\\_{i}^{Q})\\\\neq 0\\\\}}}\\\\sum\\_{i=1}^{N^{Q}}S(\\\\mathbf{x}\\_{i}^{Q})E(\\\\mathbf{x}\\_{i}^{Q}),\\ \\\\text{where}\\ S(\\\\mathbf{x}\\_{i}^{Q})=\\\\max\\\\left(1-\\\\frac{E(\\\\mathbf{x}\\_{i}^{Q})}{E\\_{m}},0\\\\right), |  | (11) |\n\nwhere Emsubscriptùê∏ùëöE\\_{m} is the self-adaptive threshold estimated in Eq. [8](https://ar5iv.org/html/2410.15624#S3.E8 \"In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), and ùïÄ{‚ãÖ}subscriptùïÄ‚ãÖ\\\\mathbb{I}\\_{\\\\{\\\\cdot\\\\}} is an indicator function evaluating to 111i.f.f. the condition is satisfied.\nIt is worth noting that existing TTA methods like EATA (Niu et al., [2022](https://ar5iv.org/html/2410.15624#bib.bib32 \"\")) and SAR (Niu et al., [2023](https://ar5iv.org/html/2410.15624#bib.bib33 \"\")) are highly sensitive to the manually determined thresholds, resulting in either none or all query predictions being treated as noise.\nIn contrast, the proposed ‚ÑíN‚ÄãAsubscript‚ÑíùëÅùê¥\\\\mathcal{L}\\_{NA} not only employs a self-adaptive threshold to filter out noise but also employs various confidence scores for query predictions to facilitate the optimization.\n\n## 4 Experiments\n\nIn this section, we verify the effectiveness of TCR in handling the query shift problem for the image-text retrieval task.\nThis section is organized as follows.\nIn Section [4.1](https://ar5iv.org/html/2410.15624#S4.SS1 \"4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we present the implementation details and experiment settings of TCR.\nIn Section [4.2](https://ar5iv.org/html/2410.15624#S4.SS2 \"4.2 Comparisons with State-of-the-arts ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we conduct extensive comparison experiments to verify the performance superiority of TCR.\nIn Section [4.3](https://ar5iv.org/html/2410.15624#S4.SS3 \"4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we perform a series of analytic studies, ablation studies, and visualization analyses, to provide a comprehensive understanding of TCR.\n\nTable 1: Comparisons with state-of-the-art methods on COCO-C benchmark under query shift on the image modality with maximum severity level regarding the Recall@1 metric. The best results are marked in bold.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  | Noise | Blur | Weather | Digital |  |\n| Query Shift | Gauss. | Shot | Impul. | Speckle | Defoc. | Glass | Motion | Zoom | Snow | Frost | Fog | Brit. | Contr. | Elastic | Pixel | JPEG | Avg. |\n| BLIP ViT-B/16 | 43.4 | 46.3 | 43.2 | 57.3 | 43.3 | 68.0 | 39.7 | 8.4 | 32.3 | 52.2 | 57.0 | 66.8 | 36.0 | 41.3 | 20.6 | 63.7 | 45.0 |\n| ‚àô‚àô\\\\bullet~{}Tent | 41.6 | 40.5 | 37.9 | 54.0 | 44.7 | 65.1 | 39.6 | 8.3 | 31.9 | 48.7 | 56.3 | 66.5 | 31.8 | 40.3 | 19.2 | 62.3 | 43.0 |\n| ‚àô‚àô\\\\bullet~{}EATA | 41.4 | 50.3 | 35.7 | 63.1 | 49.8 | 72.2 | 46.2 | 6.9 | 45.6 | 56.7 | 62.5 | 71.4 | 43.6 | 51.3 | 25.6 | 67.0 | 49.3 |\n| ‚àô‚àô\\\\bullet~{}SAR | 42.3 | 51.5 | 37.5 | 61.8 | 40.3 | 71.5 | 32.8 | 6.2 | 38.0 | 56.2 | 59.1 | 70.6 | 31.1 | 53.5 | 17.5 | 66.4 | 46.0 |\n| ‚àô‚àô\\\\bullet~{}READ | 45.8 | 48.4 | 37.2 | 59.9 | 44.5 | 71.8 | 46.6 | 11.5 | 39.9 | 49.9 | 58.4 | 70.3 | 35.8 | 45.0 | 18.8 | 66.2 | 46.9 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 47.9 | 53.5 | 46.8 | 63.4 | 42.9 | 72.1 | 36.7 | 3.2 | 37.5 | 59.7 | 66.4 | 71.2 | 40.3 | 49.0 | 13.1 | 67.6 | 48.2 |\n| ‚àô‚àô\\\\bullet~{}Ours | 53.2 | 56.2 | 54.8 | 64.6 | 58.0 | 73.7 | 56.4 | 32.2 | 56.5 | 64.1 | 71.0 | 73.4 | 57.9 | 63.7 | 41.8 | 68.4 | 59.1 |\n| BLIP ViT-L/16 | 50.3 | 51.8 | 51.1 | 61.6 | 53.7 | 72.1 | 49.4 | 14.5 | 44.0 | 57.5 | 61.8 | 70.5 | 37.3 | 50.6 | 32.0 | 70.5 | 51.8 |\n| ‚àô‚àô\\\\bullet~{}Tent | 46.3 | 49.3 | 46.7 | 58.4 | 52.2 | 71.8 | 47.5 | 12.3 | 41.9 | 56.2 | 60.9 | 69.7 | 35.7 | 48.3 | 29.4 | 69.6 | 49.8 |\n| ‚àô‚àô\\\\bullet~{}EATA | 46.2 | 53.5 | 49.5 | 63.8 | 56.5 | 73.8 | 52.6 | 18.4 | 50.6 | 59.1 | 64.5 | 72.1 | 40.7 | 55.4 | 43.5 | 70.7 | 54.4 |\n| ‚àô‚àô\\\\bullet~{}SAR | 45.9 | 50.2 | 47.3 | 63.1 | 51.1 | 73.8 | 47.2 | 11.6 | 40.8 | 58.9 | 60.7 | 71.6 | 33.6 | 54.0 | 34.4 | 70.5 | 50.9 |\n| ‚àô‚àô\\\\bullet~{}READ | 38.1 | 48.0 | 43.3 | 63.5 | 43.6 | 73.4 | 43.6 | 22.0 | 44.5 | 56.5 | 62.2 | 71.9 | 32.9 | 49.6 | 27.5 | 70.6 | 49.5 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 39.9 | 50.2 | 43.5 | 63.8 | 50.4 | 74.0 | 52.4 | 5.4 | 49.5 | 59.3 | 62.8 | 71.8 | 34.0 | 54.7 | 34.4 | 69.7 | 51.0 |\n| ‚àô‚àô\\\\bullet~{}Ours | 58.2 | 60.7 | 59.8 | 66.6 | 61.5 | 74.9 | 60.3 | 36.8 | 59.0 | 65.2 | 72.1 | 73.5 | 56.3 | 65.7 | 50.2 | 71.6 | 62.0 |\n\nTable 2: Comparisons with state-of-the-art methods on COCO-C benchmark under query shift on the text modality with maximum severity level regarding the Recall@1 metric.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  | Character-level | Word-level | Sentence-level |  |\n| Query Shift | OCR | CI | CR | CS | CD | SR | RI | RS | RD | IP | Formal | Casual | Passive | Active | Backtrans | Avg. |\n| BLIP ViT-B/16 | 31.4 | 11.3 | 9.4 | 18.9 | 11.4 | 43.6 | 51.5 | 50.3 | 50.6 | 56.8 | 56.6 | 56.2 | 54.9 | 56.8 | 54.2 | 40.9 |\n| ‚àô‚àô\\\\bullet~{}Tent | 31.4 | 11.0 | 9.5 | 17.7 | 11.3 | 43.2 | 51.3 | 50.3 | 50.6 | 56.6 | 56.2 | 56.0 | 54.9 | 56.9 | 53.9 | 40.7 |\n| ‚àô‚àô\\\\bullet~{}EATA | 33.1 | 11.9 | 10.5 | 18.4 | 12.0 | 44.9 | 53.0 | 51.6 | 50.3 | 56.2 | 56.8 | 56.8 | 56.0 | 56.8 | 54.3 | 41.5 |\n| ‚àô‚àô\\\\bullet~{}SAR | 31.8 | 11.6 | 9.9 | 18.5 | 11.7 | 43.6 | 51.5 | 50.3 | 50.6 | 56.8 | 56.5 | 56.2 | 54.9 | 56.8 | 54.2 | 41.0 |\n| ‚àô‚àô\\\\bullet~{}READ | 32.3 | 11.4 | 9.6 | 18.2 | 11.2 | 44.3 | 52.9 | 51.7 | 51.1 | 57.6 | 57.1 | 56.7 | 55.9 | 57.1 | 54.7 | 41.4 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 31.4 | 11.3 | 9.4 | 17.9 | 11.4 | 43.6 | 51.5 | 50.3 | 50.6 | 56.8 | 56.5 | 56.2 | 54.9 | 56.7 | 54.2 | 40.9 |\n| ‚àô‚àô\\\\bullet~{}Ours | 34.1 | 13.7 | 11.8 | 19.5 | 13.2 | 45.3 | 53.8 | 51.8 | 51.5 | 57.3 | 57.1 | 56.8 | 56.0 | 57.3 | 54.7 | 42.3 |\n| BLIP ViT-L/16 | 34.5 | 12.3 | 11.1 | 19.7 | 12.9 | 46.0 | 54.4 | 54.0 | 53.5 | 59.4 | 59.1 | 58.8 | 57.8 | 59.4 | 56.7 | 43.3 |\n| ‚àô‚àô\\\\bullet~{}Tent | 34.0 | 12.3 | 11.0 | 19.6 | 12.9 | 46.5 | 54.2 | 53.8 | 53.4 | 59.4 | 59.1 | 58.8 | 57.6 | 58.9 | 56.5 | 43.2 |\n| ‚àô‚àô\\\\bullet~{}EATA | 35.6 | 13.3 | 11.3 | 20.3 | 13.2 | 47.2 | 55.4 | 54.2 | 53.8 | 59.2 | 59.1 | 59.4 | 57.9 | 59.4 | 56.8 | 43.7 |\n| ‚àô‚àô\\\\bullet~{}SAR | 34.5 | 13.1 | 11.2 | 20.3 | 13.1 | 46.7 | 54.4 | 54.0 | 53.5 | 59.5 | 59.1 | 58.8 | 57.8 | 59.4 | 56.7 | 43.5 |\n| ‚àô‚àô\\\\bullet~{}READ | 35.3 | 12.2 | 10.9 | 19.1 | 12.7 | 47.3 | 55.1 | 55.0 | 53.3 | 59.7 | 59.3 | 59.1 | 58.1 | 59.6 | 56.7 | 43.6 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 34.5 | 12.3 | 11.1 | 19.7 | 12.9 | 46.7 | 54.4 | 54.0 | 53.5 | 59.5 | 59.1 | 58.8 | 57.8 | 59.4 | 56.7 | 43.4 |\n| ‚àô‚àô\\\\bullet~{}Ours | 36.8 | 14.7 | 13.4 | 21.3 | 14.3 | 47.9 | 56.3 | 54.8 | 53.9 | 59.5 | 59.4 | 59.0 | 58.2 | 59.6 | 56.9 | 44.4 |\n\n### 4.1 Implementation Details and Experiment Settings\n\nTCR is a general TTA framework that could endow most existing pre-trained models with robustness against the query shift.\nTherefore, we select CLIP (Radford et al., [2021](https://ar5iv.org/html/2410.15624#bib.bib40 \"\")) and BLIP (Li et al., [2022](https://ar5iv.org/html/2410.15624#bib.bib22 \"\")) as the source models since they are the widely adopted vision-language models for image-text retrieval task.\nFollowing Lee et al. ( [2018](https://ar5iv.org/html/2410.15624#bib.bib21 \"\")), we adopt two testing protocols, namely, image-to-text retrieval (a.k.a. TR) and text-to-image retrieval (a.k.a. IR).\nDuring the adaptation process, TCR performs the objective function for each coming mini-batch of queries, and the batch size is set as 646464.\nFollowing Niu et al. ( [2023](https://ar5iv.org/html/2410.15624#bib.bib33 \"\")); Wang et al. ( [2021](https://ar5iv.org/html/2410.15624#bib.bib43 \"\")), TCR updates the parameters within the normalization layers in the query-specific encoder fŒòsQsubscriptùëìsubscriptsuperscriptŒòùëÑùë†f\\_{\\\\Theta^{Q}\\_{s}}using the AdamW optimizer.\nTo be more specific, the learnable parameters in Œò~~Œò\\\\tilde{\\\\Theta} (Eq. [3](https://ar5iv.org/html/2410.15624#S3.E3 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")) correspond to the Layer Normalization (LN) layers in our implementation.\nBesides, the temperature hyper-parameter œÑùúè\\\\tau in Eq. [1](https://ar5iv.org/html/2410.15624#S3.E1 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and uniformity learning hyper-parameter tùë°t in Eq. [9](https://ar5iv.org/html/2410.15624#S3.E9 \"In 3.3 Intra-modality Uniformity Learning ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") are fixed as 0.020.020.02 and 101010 for all experiments, respectively.\n\nTo investigate the influence of cross-modal retrieval with query shift, we employ the following two settings for extensive evaluations (see more details in Appendix [B.1](https://ar5iv.org/html/2410.15624#A2.SS1 \"B.1 More Details about the Benchmarks ‚Ä£ Appendix B More Implementation Details ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")).\n\n- ‚Ä¢\n\n\nQuery Shift (QS):\nIn this setting, only the queries come from different distributions with the source-domain data.\nFollowing Qiu et al. ( [2023](https://ar5iv.org/html/2410.15624#bib.bib39 \"\")), we introduce 16 types of corruptions to the image modality and 15 types to the text modality across widely-used image-text retrieval datasets, COCO (Lin et al., [2014](https://ar5iv.org/html/2410.15624#bib.bib26 \"\")) and Flickr (Plummer et al., [2015](https://ar5iv.org/html/2410.15624#bib.bib37 \"\")).\nAs a result, the COCO-C and Flickr-C benchmarks are constructed, which would result in distribution shifts on either the image or text modalities.\nTo guarantee the controlled study on QS, we first fine-tune the pre-trained model on either the COCO (Lin et al., [2014](https://ar5iv.org/html/2410.15624#bib.bib26 \"\")) or Flickr (Plummer et al., [2015](https://ar5iv.org/html/2410.15624#bib.bib37 \"\")) dataset, namely, treating them as the source domains.\nAfter that, evaluations are conducted on the COCO-C or Flickr-C benchmarks, namely, treating them as the target domain.\n\n- ‚Ä¢\n\n\nQuery-Gallery Shift (QGS):\nIn this setting, both the query and gallery samples are drawn from distributions different from the source-domain data.\nTo this end, evaluations are directly conducted on the pre-trained model upon several widely-used image-text retrieval datasets from various domains, including Fashion-Gen (Rostamzadeh et al., [2018](https://ar5iv.org/html/2410.15624#bib.bib41 \"\")) from the e-commerce domain, CUHK-PEDES (Li et al., [2017](https://ar5iv.org/html/2410.15624#bib.bib24 \"\")) and ICFG-PEDES (Ding et al., [2021](https://ar5iv.org/html/2410.15624#bib.bib8 \"\")) from the person re-identification (ReID) domain, and COCO, Flickr, and Nocaps (Agrawal et al., [2019](https://ar5iv.org/html/2410.15624#bib.bib1 \"\")) from the natural image domain.\nIn other words, the source model would encounter distribution shifts on both image and text modalities during adaptation.\n\n\nTable 3: Comparisons with state-of-the-art methods on benchmarks under Query-Gallery shifts regarding the Recall@1 metric. In the table, ‚ÄúID‚Äù, ‚ÄúND‚Äù and ‚ÄúOD‚Äù refer to ‚ÄúIn-Domain‚Äù, ‚ÄúNear-Domain‚Äù and ‚ÄúOut-Domain‚Äù, respectively.\nBesides, ‚ÄúTR@1‚Äù / ‚ÄúIR@1‚Äù represent Recall@1 for image-to-text retrieval / text-to-image retrieval.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  | Base2Flickr | Base2COCO | Base2Fashion | Base2Nocaps(ID) | Base2Nocaps(ND) | Base2Nocaps(OD) |  |\n| Query Shift | TR@1 | IR@1 | TR@1 | IR@1 | TR@1 | IR@1 | TR@1 | IR@1 | TR@1 | IR@1 | TR@1 | IR@1 | Avg. |\n| CLIP ViT-B/16 | 80.2 | 61.5 | 52.5 | 33.0 | 8.5 | 13.2 | 84.9 | 61.4 | 75.4 | 49.2 | 73.8 | 55.8 | 54.1 |\n| ‚àô‚àô\\\\bullet~{}Tent | 81.4 | 64.0 | 48.8 | 27.6 | 5.6 | 10.7 | 85.1 | 61.7 | 74.6 | 48.6 | 71.8 | 56.1 | 53.0 |\n| ‚àô‚àô\\\\bullet~{}EATA | 80.4 | 63.4 | 52.1 | 34.8 | 8.1 | 12.0 | 84.7 | 62.0 | 75.1 | 52.3 | 74.1 | 56.9 | 54.7 |\n| ‚àô‚àô\\\\bullet~{}SAR | 80.3 | 62.2 | 51.8 | 33.9 | 8.0 | 13.3 | 84.7 | 61.3 | 75.4 | 51.3 | 73.7 | 56.1 | 54.3 |\n| ‚àô‚àô\\\\bullet~{}READ | 80.6 | 64.4 | 46.0 | 35.7 | 5.8 | 11.2 | 85.1 | 63.0 | 75.0 | 52.1 | 73.5 | 57.0 | 54.1 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 80.1 | 64.0 | 51.5 | 33.4 | 6.9 | 10.9 | 84.4 | 62.2 | 75.1 | 52.0 | 73.2 | 57.3 | 54.3 |\n| ‚àô‚àô\\\\bullet~{}Ours | 82.4 | 64.8 | 52.9 | 36.5 | 8.9 | 14.0 | 85.1 | 63.5 | 75.7 | 54.0 | 74.4 | 58.0 | 55.9 |\n| BLIP ViT-B/16 | 70.0 | 68.3 | 59.3 | 45.4 | 19.9 | 26.1 | 88.2 | 74.9 | 79.3 | 63.6 | 81.9 | 67.8 | 62.1 |\n| ‚àô‚àô\\\\bullet~{}Tent | 81.9 | 68.5 | 61.7 | 41.7 | 14.1 | 26.1 | 88.5 | 75.4 | 82.6 | 64.1 | 82.7 | 68.9 | 63.0 |\n| ‚àô‚àô\\\\bullet~{}EATA | 82.3 | 69.4 | 64.2 | 47.9 | 12.8 | 25.2 | 87.8 | 75.1 | 82.8 | 63.9 | 81.5 | 67.9 | 63.4 |\n| ‚àô‚àô\\\\bullet~{}SAR | 81.7 | 68.3 | 63.5 | 46.6 | 17.9 | 26.1 | 88.2 | 75.6 | 81.0 | 65.4 | 81.2 | 69.3 | 63.7 |\n| ‚àô‚àô\\\\bullet~{}READ | 80.0 | 69.9 | 62.1 | 46.4 | 5.6 | 24.1 | 87.3 | 75.1 | 80.6 | 63.9 | 80.7 | 67.9 | 62.0 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 83.5 | 69.9 | 65.0 | 47.3 | 12.2 | 24.1 | 89.2 | 75.6 | 83.7 | 65.7 | 84.3 | 69.4 | 64.2 |\n| ‚àô‚àô\\\\bullet~{}Ours | 86.8 | 70.3 | 68.9 | 48.9 | 23.6 | 30.3 | 89.7 | 76.0 | 86.3 | 66.1 | 87.2 | 69.5 | 67.0 |\n\n### 4.2 Comparisons with State-of-the-arts\n\nIn this section, We compare TCR with five SOTA TTA methods (Tent (Wang et al., [2021](https://ar5iv.org/html/2410.15624#bib.bib43 \"\")), EATA (Niu et al., [2022](https://ar5iv.org/html/2410.15624#bib.bib32 \"\")), SAR (Niu et al., [2023](https://ar5iv.org/html/2410.15624#bib.bib33 \"\")), READ (Yang et al., [2024](https://ar5iv.org/html/2410.15624#bib.bib48 \"\")), and DeYO (Lee et al., [2024](https://ar5iv.org/html/2410.15624#bib.bib20 \"\"))) under both the QS and QGS settings.\nAmong the baseline methods, Tent is the vanilla TTA approach with an entropy-based objective, while the others enhance Tent by incorporating specially designed noise-robust loss functions.\nFor a fair comparison, we select the optimal temperature (Eq.1) for the TTA baselines upon each dataset according to Fig. [4](https://ar5iv.org/html/2410.15624#S4.F4 \"Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a).\nThe results on the QS setting and QGS setting are summarized in Tables [1](https://ar5iv.org/html/2410.15624#S4.T1 \"Table 1 ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), [2](https://ar5iv.org/html/2410.15624#S4.T2 \"Table 2 ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), [7](https://ar5iv.org/html/2410.15624#A3.T7 \"Table 7 ‚Ä£ Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), [8](https://ar5iv.org/html/2410.15624#A3.T8 \"Table 8 ‚Ä£ Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Tables [3](https://ar5iv.org/html/2410.15624#S4.T3 \"Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), [4](https://ar5iv.org/html/2410.15624#S4.T4 \"Table 4 ‚Ä£ 4.2 Comparisons with State-of-the-arts ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), respectively.\nFrom the results, one could have the following observations and conclusions.\n\n- ‚Ä¢\n\n\nExisting TTA methods only achieve marginal performance improvements over the base model, which could be attributed to the inability on manipulating both modality uniformity and the modality gap.\nIn contrast, TCR could rectify the modality gap and enlarge the modality uniformity, thus significantly outperforming all the baselines across various pre-trained model types and sizes.\n\n- ‚Ä¢\n\n\nTCR demonstrates greater robustness against more severe shift types like ‚ÄúZoom‚Äù and ‚ÄúPixel‚Äù (see Table [1](https://ar5iv.org/html/2410.15624#S4.T1 \"Table 1 ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Table [7](https://ar5iv.org/html/2410.15624#A3.T7 \"Table 7 ‚Ä£ Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")), whereas most baseline methods experience significant performance degradation under these challenging distribution shifts.\nMoreover, in Table [3](https://ar5iv.org/html/2410.15624#S4.T3 \"Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), the more significant performance improvements on ‚ÄúBase2Nocaps‚Äù with ‚ÄúND‚Äù and ‚ÄúOD‚Äù compared to that with ‚ÄúID‚Äù also verify the conclusion.\n\n- ‚Ä¢\n\n\nAs the size of the gallery set increases in Table [3](https://ar5iv.org/html/2410.15624#S4.T3 \"Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") (from ‚ÄúBase2Flickr‚Äù to ‚ÄúBase2COCO‚Äù to ‚ÄúBase2Fashion‚Äù), existing TTA methods suffer from increasing performance degradation, eventually performing even worse than the base model. This supports our claim in Section [3.1](https://ar5iv.org/html/2410.15624#S3.SS1 \"3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") that TTA methods struggle to accommodate well for cross-modal retrieval tasks due to the excessively large gallery set.\nIn contrast, our method consistently achieves performance improvements across various gallery sizes.\n\n\nTable 4:\nComparisons with state-of-the-art methods on ReID benchmarks under Query-Gallery shifts regarding the Recall@1 metric.\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | CUHK2ICFG | ICFG2CUHK |  |\n| Query Shift | IR@1 | IR@1 | Avg. |\n| CLIP ViT-B/16 | 33.3 | 41.0 | 37.2 |\n| ‚àô‚àô\\\\bullet~{}Tent | 33.5 | 41.9 | 37.7 |\n| ‚àô‚àô\\\\bullet~{}EATA | 33.3 | 42.2 | 37.8 |\n| ‚àô‚àô\\\\bullet~{}SAR | 33.3 | 42.2 | 37.8 |\n| ‚àô‚àô\\\\bullet~{}READ | 33.0 | 42.3 | 37.7 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 33.3 | 42.2 | 37.8 |\n| ‚àô‚àô\\\\bullet~{}Ours | 37.3 | 42.4 | 39.9 |\n\n### 4.3 Ablation and Analytic Study\n\nIn this section, all the experiments are conducted under the ‚ÄúBase2COCO‚Äù setting using the BLIP ViT-B/16 model unless otherwise stated.\n\nAnalytic Studies on Intra-modality Uniformity and Inter-modality Gap.\nAs pointed out in Introduction, the query shift would diminish the intra-modality uniformity and amplify the inter-modality gap.\nFor an in-depth understanding, we conduct analytic experiments to investigate how the two characteristics affect the retrieval performance.\nTo examine the influence of the intra-modality uniformity, we manually scale the latent distance between different queries.\nMathematically, the scaling operation is defined as follows.\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | (ùê≥iQ)scale =ùêô¬ØQ+Œªscale‚Äã(ùê≥iQ‚àíùêô¬ØQ),superscriptsuperscriptsubscriptùê≥ùëñùëÑscale superscript¬ØùêôùëÑsuperscriptùúÜscalesuperscriptsubscriptùê≥ùëñùëÑsuperscript¬ØùêôùëÑ(\\\\mathbf{z}\\_{i}^{Q})^{\\\\text{scale }}=\\\\overline{\\\\mathbf{Z}}^{Q}+\\\\lambda^{\\\\text{scale}}\\\\left(\\\\mathbf{z}\\_{i}^{Q}-\\\\overline{\\\\mathbf{Z}}^{Q}\\\\right), |  | (12) |\n\n![Refer to caption](https://ar5iv.org/html/2410.15624/assets/x3.png)Figure 3: Observation of the intra-modality uniformity and inter-modality gap.\nThe increasing ŒªscalesuperscriptùúÜscale\\\\lambda^{\\\\operatorname{scale}} indicates the growing intra-modality uniformity while the decreasing ŒªoffsetsuperscriptùúÜoffset\\\\lambda^{\\\\operatorname{offset}} indicates the narrowing inter-modality gap.\nNotably, Œªscale=1.0superscriptùúÜscale1.0\\\\lambda^{\\\\operatorname{scale}}=1.0 and Œªoffset=0superscriptùúÜoffset0\\\\lambda^{\\\\operatorname{offset}}=0 represent no scaling and no offset, respectively.\n\nwhere ùêô¬ØQ=1NQ‚Äã‚àëi=1NQùê≥iQsuperscript¬ØùêôùëÑ1superscriptùëÅùëÑsuperscriptsubscriptùëñ1superscriptùëÅùëÑsuperscriptsubscriptùê≥ùëñùëÑ\\\\overline{\\\\mathbf{Z}}^{Q}=\\\\frac{1}{N^{Q}}\\\\sum\\_{i=1}^{N^{Q}}\\\\mathbf{z}\\_{i}^{Q} is the center of queries, ŒªscalesuperscriptùúÜscale\\\\lambda^{\\\\text{scale}} is the scaling factor.\nAs illustrated in Fig. [3](https://ar5iv.org/html/2410.15624#S4.F3 \"Figure 3 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a),\nincreasing the intra-modality uniformity in the query modality would improve the performance, but not vice versa.\nSuch a phenomenon indicates that higher uniformity would guarantee the discrimination between queries and thus boost performance.\nTo examine the influence of the inter-modality gap, following Liang et al. ( [2022](https://ar5iv.org/html/2410.15624#bib.bib25 \"\")), we manually move every query embedding towards closing the modality gap. Formally,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | (ùê≥iQ)offset=ùê≥iQ‚àíŒªoffset‚Äã(ùêô¬ØQ‚àíùêô¬ØG),superscriptsuperscriptsubscriptùê≥ùëñùëÑoffsetsuperscriptsubscriptùê≥ùëñùëÑsuperscriptùúÜoffsetsuperscript¬ØùêôùëÑsuperscript¬Øùêôùê∫(\\\\mathbf{z}\\_{i}^{Q})^{\\\\text{offset}}=\\\\mathbf{z}\\_{i}^{Q}-\\\\lambda^{\\\\text{offset}}\\\\left(\\\\overline{\\\\mathbf{Z}}^{Q}-\\\\overline{\\\\mathbf{Z}}^{G}\\\\right), |  | (13) |\n\nwhere ùêô¬ØG=1NG‚Äã‚àëi=1NGùê≥iGsuperscript¬Øùêôùê∫1superscriptùëÅùê∫superscriptsubscriptùëñ1superscriptùëÅùê∫superscriptsubscriptùê≥ùëñùê∫\\\\overline{\\\\mathbf{Z}}^{G}=\\\\frac{1}{N^{G}}\\\\sum\\_{i=1}^{N^{G}}\\\\mathbf{z}\\_{i}^{G} is the center of the gallery samples, ŒªoffsetsuperscriptùúÜoffset\\\\lambda^{\\\\text{offset}} controls the offset of the embeddings.\nFrom the results in Fig. [3](https://ar5iv.org/html/2410.15624#S4.F3 \"Figure 3 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(b), one could observe that monotonously eliminating the modality gap would not always improve the performance.\nIn contrast, the estimated modality gap from the pre-trained model is a plausible criterion for modality gap rectification.\nNote that the embeddings are all ‚Ñì‚Äã2‚Ñì2\\\\ell 2-normalized after scaling or shifting.\n\nTable 5: Ablation study of the loss functions, where ‚Äù ‚úì‚úì\\\\checkmark ‚Äù denotes the loss is adopted.\n\n|     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- |\n| ‚ÑíN‚ÄãAsubscript‚ÑíùëÅùê¥\\\\mathcal{L}\\_{NA} | ‚ÑíM‚ÄãUsubscript‚ÑíùëÄùëà\\\\mathcal{L}\\_{MU} | ‚ÑíE‚ÄãM‚ÄãGsubscript‚Ñíùê∏ùëÄùê∫\\\\mathcal{L}\\_{EMG} | TR@1 | IR@1 | Avg. |\n|  |  |  | 59.3 | 45.4 | 52.4 |\n| ‚úì‚úì\\\\checkmark |  |  | 67.4 | 47.8 | 57.9 |\n|  | ‚úì‚úì\\\\checkmark |  | 64.9 | 46.7 | 55.8 |\n|  |  | ‚úì‚úì\\\\checkmark | 64.3 | 46.3 | 55.3 |\n| ‚úì‚úì\\\\checkmark | ‚úì‚úì\\\\checkmark |  | 67.8 | 48.3 | 58.2 |\n| ‚úì‚úì\\\\checkmark |  | ‚úì‚úì\\\\checkmark | 68.1 | 48.4 | 58.4 |\n|  | ‚úì‚úì\\\\checkmark | ‚úì‚úì\\\\checkmark | 66.3 | 47.8 | 57.1 |\n| ‚úì‚úì\\\\checkmark | ‚úì‚úì\\\\checkmark | ‚úì‚úì\\\\checkmark | 68.9 | 48.9 | 58.9 |\n\nAblation studies.\nTo verify the effectiveness of each design, we investigate the loss terms of TCR in Table [5](https://ar5iv.org/html/2410.15624#S4.T5 \"Table 5 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), resulting in the following conclusions.\nFirst, ‚ÑíN‚ÄãAsubscript‚ÑíùëÅùê¥\\\\mathcal{L}\\_{NA} boosts performance through the query prediction refinement module and self-adaptive loss, e.g., TCR improves R@1 by 9.2% and 14.6% on text and image retrieval, compared to Tent in Table [3](https://ar5iv.org/html/2410.15624#S4.T3 \"Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nSecond, both the designed intra-modality uniformity learning module and inter-modality gap learning module would enhance robustness against query shift.\nThird, TCR achieves optimal performance when all the loss terms are employed.\nMoreover, we carry out experiments to verify the effectiveness of the proposed query prediction refinement module in Section [3.5](https://ar5iv.org/html/2410.15624#S3.SS5 \"3.5 Noise-robust Adaptation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nAs shown in Fig. [4](https://ar5iv.org/html/2410.15624#S4.F4 \"Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a), we observe that: i) selecting an appropriate temperature for the existing TTA approach across various datasets is challenging; ii) even a low temperature (e.g., 1‚Äãe‚àí41ùëí41e-4) is a better setting across all datasets, the performance degrades as a low temperature tends to make model overfitting on noisy query prediction.\nIn contrast, the query prediction refinement module not only stabilizes the temperature setting for all the datasets but also prevents the model from either underfitting or overfitting by excluding some irrelevant samples in the gallery.\n\nVisualization Result.\nTo qualitatively study the effectiveness of TCR, we conduct the t-SNE visualization on both the query and gallery embeddings before and after the TTA process.\nFrom the results in Fig. [4](https://ar5iv.org/html/2410.15624#S4.F4 \"Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(c), one could observe that the samples in the query modality enjoy more scatter and the difference between the query and gallery modalities narrows after the TTA process.\nIn other words, TCR achieves better robustness against query shift by rectifying the intra-modality uniformity and the inter-modality gap.\n\n![Refer to caption](https://ar5iv.org/html/2410.15624/assets/x4.png)Figure 4: Finer-grained Ablation studies. (a) The parameter analysis of œÑùúè\\\\tau (Eq. [1](https://ar5iv.org/html/2410.15624#S3.E1 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Eq. [5](https://ar5iv.org/html/2410.15624#S3.E5 \"In 3.2.1 Candidate Selection ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")) on the vanilla TTA method Tent w/ (solid line) and w/o (dotted line) the query prediction refinement module. (b) The parameter analysis of tùë°t in Eq. [9](https://ar5iv.org/html/2410.15624#S3.E9 \"In 3.3 Intra-modality Uniformity Learning ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"). (c) The t-SNE visualization of TR on the query and gallery embeddings after employing the proposed TCR.\n\n## 5 Conclusion\n\nIn this paper, we develop a new test-time adaptation method, dubbed TCR, to achieve robust cross-modal retrieval against the query shift problem.\nIn brief, TCR first employs a novel module to refine the query predictions.\nAfter that, TCR adopts a novel joint objective to prevent the model adaptation from overfitting noise while simultaneously manipulating the intra-modality uniformity and inter-modality gap to preserve the well-established common space from the source model.\nExtensive experiments not only verify the effectiveness of TCR but also reveal the importance of each designs.\nIn the future, we plan to explore more potential scenarios contaminated with query shift and extend TCR to address the corresponding issues.\n\n## References\n\n- Agrawal et al. (2019)\nHarsh Agrawal, Karan Desai, Yufei Wang, Xinlei Chen, Rishabh Jain, Mark Johnson, Dhruv Batra, Devi Parikh, Stefan Lee, and Peter Anderson.\n\nNocaps: Novel object captioning at scale.\n\nIn _CVPR_, 2019.\n\n- Cao et al. (2023)\nHaozhi Cao, Yuecong Xu, Jianfei Yang, Pengyu Yin, Shenghai Yuan, and Lihua Xie.\n\nMulti-modal continual test-time adaptation for 3d semantic segmentation.\n\nIn _CVPR_, 2023.\n\n- Caron et al. (2020)\nMathilde Caron, Ishan Misra, Julien Mairal, Priya Goyal, Piotr Bojanowski, and Armand Joulin.\n\nUnsupervised learning of visual features by contrasting cluster assignments.\n\nIn _NeurIPS_, 2020.\n\n- Cartella et al. (2023)\nGiuseppe Cartella, Alberto Baldrati, Davide Morelli, Marcella Cornia, Marco Bertini, and Rita Cucchiara.\n\nOpenfashionclip: Vision-and-language contrastive learning with open-source fashion data.\n\nIn _ICIAP_, 2023.\n\n- Changpinyo et al. (2021)\nSoravit Changpinyo, Piyush Sharma, Nan Ding, and Radu Soricut.\n\nConceptual 12m: Pushing web-scale image-text pre-training to recognize long-tail visual concepts.\n\nIn _CVPR_, 2021.\n\n- Chen et al. (2022)\nDian Chen, Dequan Wang, Trevor Darrell, and Sayna Ebrahimi.\n\nContrastive test-time adaptation.\n\nIn _CVPR_, 2022.\n\n- Chen et al. (2021)\nQingchao Chen, Yang Liu, and Samuel Albanie.\n\nMind-the-gap! unsupervised domain adaptation for text-video retrieval.\n\nIn _AAAI_, 2021.\n\n- Ding et al. (2021)\nZefeng Ding, Changxing Ding, Zhiyin Shao, and Dacheng Tao.\n\nSemantically self-aligned network for text-to-image part-aware person re-identification.\n\n_arXiv:2107.12666_, 2021.\n\n- Faghri et al. (2017)\nFartash Faghri, David J Fleet, Jamie Ryan Kiros, and Sanja Fidler.\n\nVse++: Improving visual-semantic embeddings with hard negatives.\n\n_arXiv:1707.05612_, 2017.\n\n- Gandelsman et al. (2022)\nYossi Gandelsman, Yu Sun, Xinlei Chen, and Alexei Efros.\n\nTest-time training with masked autoencoders.\n\nIn _NeurIPS_, 2022.\n\n- Gou et al. (2024)\nYuanbiao Gou, Haiyu Zhao, Boyun Li, Xinyan Xiao, and Xi Peng.\n\nTest-time degradation adaptation for open-set image restoration.\n\nIn _ICML_, 2024.\n\n- Guo et al. (2019)\nSheng Guo, Weilin Huang, Xiao Zhang, Prasanna Srikhanta, Yin Cui, Yuan Li, Hartwig Adam, Matthew R Scott, and Serge Belongie.\n\nThe imaterialist fashion attribute dataset.\n\nIn _ICCV Workshops_, 2019.\n\n- Han et al. (2017)\nXintong Han, Zuxuan Wu, Phoenix X Huang, Xiao Zhang, Menglong Zhu, Yuan Li, Yang Zhao, and Larry S Davis.\n\nAutomatic spatially-aware fashion concept discovery.\n\nIn _ICCV_, 2017.\n\n- Hao et al. (2023)\nXiaoshuai Hao, Wanqian Zhang, Dayan Wu, Fei Zhu, and Bo Li.\n\nDual alignment unsupervised domain adaptation for video-text retrieval.\n\nIn _CVPR_, 2023.\n\n- Huang et al. (2024)\nZhenyu Huang, Mouxing Yang, Xinyan Xiao, Peng Hu, and Xi Peng.\n\nNoise-robust vision-language pre-training with positive-negative learning.\n\n_IEEE Transactions on Pattern Analysis and Machine Intelligence_, 2024.\n\n- Jia et al. (2021)\nChao Jia, Yinfei Yang, Ye Xia, Yi-Ting Chen, Zarana Parekh, Hieu Pham, Quoc Le, Yun-Hsuan Sung, Zhen Li, and Tom Duerig.\n\nScaling up visual and vision-language representation learning with noisy text supervision.\n\nIn _ICML_, 2021.\n\n- Jiang & Ye (2023)\nDing Jiang and Mang Ye.\n\nCross-modal implicit relation reasoning and aligning for text-to-image person retrieval.\n\nIn _CVPR_, 2023.\n\n- Kang et al. (2019)\nGuoliang Kang, Lu Jiang, Yi Yang, and Alexander G Hauptmann.\n\nContrastive adaptation network for unsupervised domain adaptation.\n\nIn _CVPR_, 2019.\n\n- Krishna et al. (2017)\nRanjay Krishna, Yuke Zhu, Oliver Groth, Justin Johnson, Kenji Hata, Joshua Kravitz, Stephanie Chen, Yannis Kalantidis, Li-Jia Li, David A Shamma, et al.\n\nVisual genome: Connecting language and vision using crowdsourced dense image annotations.\n\n_International Journal of Computer Vision_, 2017.\n\n- Lee et al. (2024)\nJonghyun Lee, Dahuin Jung, Saehyung Lee, Junsung Park, Juhyeon Shin, Uiwon Hwang, and Sungroh Yoon.\n\nEntropy is not enough for test-time adaptation: From the perspective of disentangled factors.\n\n2024.\n\n- Lee et al. (2018)\nKuang-Huei Lee, Xi Chen, Gang Hua, Houdong Hu, and Xiaodong He.\n\nStacked cross attention for image-text matching.\n\nIn _ECCV_, 2018.\n\n- Li et al. (2022)\nJunnan Li, Dongxu Li, Caiming Xiong, and Steven Hoi.\n\nBlip: Bootstrapping language-image pre-training for unified vision-language understanding and generation.\n\nIn _ICML_, 2022.\n\n- Li et al. (2023)\nJunnan Li, Dongxu Li, Silvio Savarese, and Steven Hoi.\n\nBlip-2: Bootstrapping language-image pre-training with frozen image encoders and large language models.\n\nIn _ICML_, 2023.\n\n- Li et al. (2017)\nShuang Li, Tong Xiao, Hongsheng Li, Bolei Zhou, Dayu Yue, and Xiaogang Wang.\n\nPerson search with natural language description.\n\nIn _CVPR_, 2017.\n\n- Liang et al. (2022)\nVictor Weixin Liang, Yuhui Zhang, Yongchan Kwon, Serena Yeung, and James Y Zou.\n\nMind the gap: Understanding the modality gap in multi-modal contrastive representation learning.\n\nIn _NeurIPS_, 2022.\n\n- Lin et al. (2014)\nTsung-Yi Lin, Michael Maire, Serge Belongie, James Hays, Pietro Perona, Deva Ramanan, Piotr Doll√°r, and C Lawrence Zitnick.\n\nMicrosoft coco: Common objects in context.\n\nIn _ECCV_, 2014.\n\n- Liu et al. (2021a)\nYang Liu, Qingchao Chen, and Samuel Albanie.\n\nAdaptive cross-modal prototypes for cross-domain visual-language retrieval.\n\nIn _CVPR_, 2021a.\n\n- Liu et al. (2021b)\nYuejiang Liu, Parth Kothari, Bastien Van Delft, Baptiste Bellot-Gurlet, Taylor Mordan, and Alexandre Alahi.\n\nTtt++: When does self-supervised test-time training fail or thrive?\n\nIn _NeurIPS_, 2021b.\n\n- Long et al. (2017)\nMingsheng Long, Han Zhu, Jianmin Wang, and Michael I Jordan.\n\nDeep transfer learning with joint adaptation networks.\n\nIn _ICML_, 2017.\n\n- Ma et al. (2024)\nZeyu Ma, Yuqi Li, Yizhi Luo, Xiao Luo, Jinxing Li, Chong Chen, Xian-Sheng Hua, and Guangming Lu.\n\nDiscrepancy and structure-based contrast for test-time adaptive retrieval.\n\n_IEEE Transactions on Multimedia_, 2024.\n\n- Munro et al. (2021)\nJonathan Munro, Michael Wray, Diane Larlus, Gabriela Csurka, and Dima Damen.\n\nDomain adaptation in multi-view embedding for cross-modal video retrieval.\n\n_arXiv:2110.12812_, 2021.\n\n- Niu et al. (2022)\nShuaicheng Niu, Jiaxiang Wu, Yifan Zhang, Yaofo Chen, Shijian Zheng, Peilin Zhao, and Mingkui Tan.\n\nEfficient test-time model adaptation without forgetting.\n\nIn _ICML_, 2022.\n\n- Niu et al. (2023)\nShuaicheng Niu, Jiaxiang Wu, Yifan Zhang, Zhiquan Wen, Yaofo Chen, Peilin Zhao, and Mingkui Tan.\n\nTowards stable test-time adaptation in dynamic wild world.\n\nIn _ICLR_, 2023.\n\n- Niu et al. (2024)\nShuaicheng Niu, Chunyan Miao, Guohao Chen, Pengcheng Wu, and Peilin Zhao.\n\nTest-time model adaptation with only forward passes.\n\nIn _ICML_, 2024.\n\n- Ordonez et al. (2011)\nVicente Ordonez, Girish Kulkarni, and Tamara Berg.\n\nIm2text: Describing images using 1 million captioned photographs.\n\nIn _NeurIPS_, 2011.\n\n- Peng & Chi (2019)\nYuxin Peng and Jingze Chi.\n\nUnsupervised cross-media retrieval using domain adaptation with scene graph.\n\n_IEEE Transactions on Circuits and Systems for Video Technology_, 2019.\n\n- Plummer et al. (2015)\nBryan A Plummer, Liwei Wang, Chris M Cervantes, Juan C Caicedo, Julia Hockenmaier, and Svetlana Lazebnik.\n\nFlickr30k entities: Collecting region-to-phrase correspondences for richer image-to-sentence models.\n\nIn _ICCV_, 2015.\n\n- Press et al. (2023)\nOri Press, Steffen Schneider, Matthias K√ºmmerer, and Matthias Bethge.\n\nRdumb: A simple approach that questions our progress in continual test-time adaptation.\n\nIn _NeurIPS_, 2023.\n\n- Qiu et al. (2023)\nJielin Qiu, Yi Zhu, Xingjian Shi, Florian Wenzel, Zhiqiang Tang, Ding Zhao, Bo Li, and Mu Li.\n\nBenchmarking robustness of multimodal image-text models under distribution shift.\n\n_Journal of Data-centric Machine Learning Research_, 2023.\n\n- Radford et al. (2021)\nAlec Radford, Jong Wook Kim, Chris Hallacy, Aditya Ramesh, Gabriel Goh, Sandhini Agarwal, Girish Sastry, Amanda Askell, Pamela Mishkin, Jack Clark, et al.\n\nLearning transferable visual models from natural language supervision.\n\nIn _ICML_, 2021.\n\n- Rostamzadeh et al. (2018)\nNegar Rostamzadeh, Seyedarian Hosseini, Thomas Boquet, Wojciech Stokowiec, Ying Zhang, Christian Jauvin, and Chris Pal.\n\nFashion-gen: The generative fashion dataset and challenge.\n\n_arXiv preprint arXiv:1806.08317_, 2018.\n\n- Sun et al. (2020)\nYu Sun, Xiaolong Wang, Zhuang Liu, John Miller, Alexei Efros, and Moritz Hardt.\n\nTest-time training with self-supervision for generalization under distribution shifts.\n\nIn _ICML_, 2020.\n\n- Wang et al. (2021)\nDequan Wang, Evan Shelhamer, Shaoteng Liu, Bruno Olshausen, and Trevor Darrell.\n\nTent: Fully test-time adaptation by entropy minimization.\n\nIn _ICLR_, 2021.\n\n- Wang et al. (2023)\nXiaodan Wang, Chengyu Wang, Lei Li, Zhixu Li, Ben Chen, Linbo Jin, Jun Huang, Yanghua Xiao, and Ming Gao.\n\nFashionklip: Enhancing e-commerce image-text retrieval with fashion multi-modal conceptual knowledge graph.\n\nIn _ACL_, 2023.\n\n- Wu et al. (2021)\nHui Wu, Yupeng Gao, Xiaoxiao Guo, Ziad Al-Halah, Steven Rennie, Kristen Grauman, and Rogerio Feris.\n\nFashion iq: A new dataset towards retrieving images by natural language feedback.\n\nIn _CVPR_, 2021.\n\n- Yan et al. (2023)\nShuanglin Yan, Neng Dong, Liyan Zhang, and Jinhui Tang.\n\nClip-driven fine-grained text-image person re-identification.\n\n_IEEE Transactions on Image Processing_, 2023.\n\n- Yang et al. (2022)\nJinyu Yang, Jiali Duan, Son Tran, Yi Xu, Sampath Chanda, Liqun Chen, Belinda Zeng, Trishul Chilimbi, and Junzhou Huang.\n\nVision-language pre-training with triple contrastive learning.\n\nIn _CVPR_, 2022.\n\n- Yang et al. (2024)\nMouxing Yang, Yunfan Li, Changqing Zhang, Peng Hu, and Xi Peng.\n\nTest-time adaptation against multi-modal reliability bias.\n\nIn _ICLR_, 2024.\n\n- Yuan et al. (2024)\nYige Yuan, Bingbing Xu, Liang Hou, Fei Sun, Huawei Shen, and Xueqi Cheng.\n\nTea: Test-time energy adaptation.\n\nIn _CVPR_, 2024.\n\n- Zancato et al. (2023)\nLuca Zancato, Alessandro Achille, Tian Yu Liu, Matthew Trager, Pramuditha Perera, and Stefano Soatto.\n\nTrain/test-time adaptation with retrieval.\n\nIn _CVPR_, 2023.\n\n\nAppendix\n\n\\\\etocdepthtag\n\n.tocmtappendix\n\\\\etocsettagdepthmtchapternone\n\\\\etocsettagdepthmtappendixsubsection\n\n## Appendix A Defination of Intra-modality Uniformity and Inter-modality Gap\n\nHere, we provide a mathematical definition of the modality uniformity and the modality gap mentioned in the manuscript.\nSpecifically, the modality uniformity of query modality is defined as\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | Uniformity=1NQ‚Äã‚àëi=1NQ‚Äñùê≥iQ‚àíùêô¬ØQ‚Äñ.Uniformity1superscriptùëÅùëÑsuperscriptsubscriptùëñ1superscriptùëÅùëÑnormsuperscriptsubscriptùê≥ùëñùëÑsuperscript¬ØùêôùëÑ\\\\text{Uniformity}=\\\\frac{1}{N^{Q}}\\\\sum\\_{i=1}^{N^{Q}}\\\\\\|\\\\mathbf{z}\\_{i}^{Q}-\\\\overline{\\\\mathbf{Z}}^{Q}\\\\\\|. |  | (14) |\n\nA low intra-modality uniformity illustrates that the samples in the query modality are compact, which degrades the retrieval performance as the model struggles to distinguish diverse queries.\n\nThe modality gap between query and gallery modalities is defined as\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | Modality Gap=‚Äñùêô¬ØQ‚àíùêô¬ØG‚Äñ.Modality Gapnormsuperscript¬ØùêôùëÑsuperscript¬Øùêôùê∫\\\\text{Modality Gap}=\\\\\\|\\\\overline{\\\\mathbf{Z}}^{Q}-\\\\overline{\\\\mathbf{Z}}^{G}\\\\\\|. |  | (15) |\n\nModality gap has been proved to be a inherent characteristic of multimodal pre-trained models in Liang et al. ( [2022](https://ar5iv.org/html/2410.15624#bib.bib25 \"\")), which might represent the well-aligned common space to some extent.\nAs shown in Fig. [4](https://ar5iv.org/html/2410.15624#S4.F4 \"Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a),\neither an over-low or over-high modality gap would destroy the well-constructed common space, harming the retrieval performance.\n\n## Appendix B More Implementation Details\n\n### B.1 More Details about the Benchmarks\n\nIn the manuscript, we employ the QS setting and the QGS setting for evaluation. Here, we provide more detail about the benchmarks employed in the two settings.\n\nQuery Shift.\nWe construct two benchmarks with only query modality distribution shifts based on the widely-used COCO and Flickr datasets.\nSpecifically,\n\n- ‚Ä¢\n\n\nCOCO is a large-scale dataset for cross-modal retrieval and image captioning tasks. For evaluation, we conduct experiments on the COCO 2014 testing set following Li et al. ( [2022](https://ar5iv.org/html/2410.15624#bib.bib22 \"\")), which contains 5,000 images and 25,000 annotations, with each image associated with five corresponding text descriptions.\n\n- ‚Ä¢\n\n\nFlickr is a cross-modal retrieval dataset collected from natural scenarios. Following Radford et al. ( [2021](https://ar5iv.org/html/2410.15624#bib.bib40 \"\")), we employ the test set comprising 1,000 images and 5,000 annotations, where each image is paired with five corresponding sentences.\n\n\nFollowing Qiu et al. ( [2023](https://ar5iv.org/html/2410.15624#bib.bib39 \"\")), we introduce 16 and 15 types of corruption to the image and text modality, respectively.\nSpecifically, the corruptions in image modality consist of:\n(1) Noise: Gaussian noise, Shot noise, Impulse noise, Speckle noise;\n(2) Blur: Defocus blur, Glass blur, Motion blur, Zoom blur ;\n(3) Weather: Snow, Frost, Fog, Brightness;\n(4) Digital: Contrast, Elastic, Pixelate, JPEG compression.\nTo simulate real-world corruptions, each image modality corruption is applied at five different severity levels, resulting in a total of 80 perturbations.\nAs for the text modality, the employed corruptions could be categorized into three levels: character-level, word-level, and sentence-level.\nSpecifically, the character-level corruptions consist of OCR, Character Insert (CI), Character Replace (CR), Character Swap (CS), and Character Delete (CD), which simulate real-world typos or mistakes during typing.\nThe word-level corruptions involve Synonym Replacement (SR), Word Insertion (WR), Word Swap (WS), Word Deletion (WD), and Insert Punctuation (IP), which simulate different writing habits that people may replace, delete, or add words to express the same meaning.\nFor sentence-level corruptions, we convert the annotation styles into Formal, Casual, Passive, Active, and Back-translation, which simulate various speaking, writing styles or translation errors.\nSimilar to the image corruptions, we introduce 7/2/1 severity levels for character-level/word-level/sentence-level corruptions.\n\nAs a result, we construct the two benchmarks named COCO-C and Flickr-C.\nNotably, we only introduce the corruptions to the query modality in the QS setting, e.g., for image-to-text retrieval, the distribution shifts occur on the image modality.\nThe cases of the 16 image corruptions and 15 text corruptions are visualized in Fig. [5](https://ar5iv.org/html/2410.15624#A2.F5 \"Figure 5 ‚Ä£ B.1 More Details about the Benchmarks ‚Ä£ Appendix B More Implementation Details ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Table [6](https://ar5iv.org/html/2410.15624#A2.T6 \"Table 6 ‚Ä£ B.1 More Details about the Benchmarks ‚Ä£ Appendix B More Implementation Details ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\n\nQuery-Gallery Shift.\nWe establish the following benchmarks with distribution shifts across both query and gallery modalities, including Fashion-Gen from the E-commerce domain, CUHK-PEDES and ICFG-PEDES from the ReID domain, as well as COCO, Flickr, and Nocaps from the natural image domain.\nSpecifically,\n\n- ‚Ä¢\n\n\nFashion-Gen is a cross-modal retrieval dataset source from the E-commerce domain, comprising fashion images paired with item descriptions provided by professional stylists. In the experiment, we employ the testing set containing 32,528 image-text pairs.\n\n- ‚Ä¢\n\n\nCUHK-PEDES is a dataset for text-to-image person re-identification. Following (Jiang & Ye, [2023](https://ar5iv.org/html/2410.15624#bib.bib17 \"\")), we utilize the testing set which contains 3,074 images and 6,156 textual descriptions of 1,000 identities.\n\n- ‚Ä¢\n\n\nICFG-PEDES is a large-scale text-to-image person re-identification dataset. Following (Jiang & Ye, [2023](https://ar5iv.org/html/2410.15624#bib.bib17 \"\")), we adopt the testing set consists of 19,848 image-text pairs, corresponding to 1,000 identities.\n\n- ‚Ä¢\n\n\nNocaps is a cross-modal retrieval dataset derived from the OpenImages dataset. For evaluation, we perform experiments on the test set, which consists of 648 in-domain images, 2,938 near-domain images, and 914 out-domain images. Each image is paired with 10 captions.\n\n\n![Refer to caption](https://ar5iv.org/html/2410.15624/assets/x5.png)Figure 5: Examples of 16 types of image corruption. The original image is from the COCO dataset.Table 6: Examples of 15 types of text corruption. The original text is from the COCO dataset.\n\n|     |     |     |\n| --- | --- | --- |\n| Category | Perturbation | Example |\n| Original | Clean | A train traveling down tracks next to a brick building. |\n| Character | OCR | A train travelin9 down track8 next to a brick building. |\n| CI | A train traveling down traGcks next to a brick bui1lding. |\n| CR | A train traveling doPn tracks next to a brick buildirg. |\n| CS | A train rtaveilng down tracks next to a brick building. |\n| CD | A train tr\\[X\\]veling down tr\\[X\\]cks next to a brick building. |\n| Word | SR | A train jaunt down running adjacent to a brick building. |\n| RI | A train pass traveling down tracks next to go a brick building |\n| RS | A building traveling down tracks next to a brick train. |\n| RD | A train \\[X\\] down tracks \\[X\\] to a brick building. |\n| IP | A : train traveling down tracks next to , a brick building. |\n| Sentence | Formal | A train moving down tracks next to a brick building. |\n| Casual | A train that goes down tracks next to a brick building. |\n| Passive | Tracks next to a brick building are being traveled down by a train. |\n| Active | There is a train traveling down tracks next to a brick building. |\n| Backtrans | A train runs down the tracks next to a brick building. |\n\n### B.2 More Experiment Details\n\nTo guarantee the performance of the baselines, we select the optimal temperature (Eq. [1](https://ar5iv.org/html/2410.15624#S3.E1 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")) for the TTA baselines upon each dataset.\nAccording to Fig. [4](https://ar5iv.org/html/2410.15624#S4.F4 \"Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a), the temperature is fixed as 0.010.010.01 for COCO-C, Flickr-C, COCO, Flickr, and Nocaps datatsets, 0.0010.0010.001 for Fashion-Gen dataset, and 0.00010.00010.0001 for CUHK-PEDE and ICFG-PEDES datasets.\nNote that we employ Tent to conduct the experiment in Fig. [4](https://ar5iv.org/html/2410.15624#S4.F4 \"Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a) since most TTA methods are variants based on the Tent.\nMoreover, the adaptation process utilizes an initial learning rate of 3‚Äãe‚àí4/3‚Äãe‚àí53superscriptùëí43superscriptùëí53e^{-4}/3e^{-5} for text/image retrieval, excepting 3‚Äãe‚àí43superscriptùëí43e^{-4} for image retrieval on the CLIP model.\n\nIn addition, for the ablation study in Fig. [4](https://ar5iv.org/html/2410.15624#S4.F4 \"Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a), we perform experiments on the Flickr-C dataset using the following corruptions: Gaussian, Zoom, Snow, and Contrast for the image modality; OCR, IP, and Formal for the text modality.\n\n### B.3 Pseudo Code\n\nIn the following, we provide the pseudo-code of the proposed TCR in Algorithm [1](https://ar5iv.org/html/2410.15624#algorithm1 \"In B.3 Pseudo Code ‚Ä£ Appendix B More Implementation Details ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nTo guarantee the stability of the estimation for Emsubscriptùê∏ùëöE\\_{m} and ŒîSsubscriptŒîùëÜ\\\\Delta\\_{S}, we maintain a queue which always saves the query-candidate pairs with the smallest SI during the adaptation process.\nFollowing  Caron et al. ( [2020](https://ar5iv.org/html/2410.15624#bib.bib3 \"\")), we limit the queue updating times to a maximum of 10 iterations.\n\nInput:Test samples ùíüT={{ùê±iQ}i=1NQ,{ùê±jG}j=1NG}subscriptùíüùëásuperscriptsubscriptsuperscriptsubscriptùê±ùëñùëÑùëñ1superscriptùëÅùëÑsuperscriptsubscriptsuperscriptsubscriptùê±ùëóùê∫ùëó1superscriptùëÅùê∫\\\\mathcal{D}\\_{T}=\\\\left\\\\{\\\\{\\\\mathbf{x}\\_{i}^{Q}\\\\}\\_{i=1}^{N^{Q}},\\\\{\\\\mathbf{x}\\_{j}^{G}\\\\}\\_{j=1}^{N^{G}}\\\\right\\\\}, the source model fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}} with trainable parameters Œò~~Œò\\\\tilde{\\\\Theta}, TTA steps Œ∑>0ùúÇ0\\\\eta>0, batch size BùêµB.\n\nOutput:Predictions {ùê©i}i=1NQsuperscriptsubscriptsubscriptùê©ùëñùëñ1superscriptùëÅùëÑ\\\\{\\\\mathbf{p}\\_{i}\\\\}\\_{i=1}^{N^{Q}}.\n\n1\nInitialize Œò~0=Œòssubscript~Œò0subscriptŒòùë†\\\\tilde{\\\\Theta}\\_{0}=\\\\Theta\\_{s};\n\n2for _given queries ùê±Q‚ààùíüTsuperscriptùê±ùëÑsubscriptùíüùëá\\\\mathbf{x}^{Q}\\\\in\\\\mathcal{D}\\_{T}_ do\n\n3for _step=1,‚ãØ,Œ∑step1‚ãØùúÇ\\\\text{step}=1,\\\\cdots,\\\\eta_ do\n\n4\nObtain the query predictions ùê©ùê©\\\\mathbf{p} in Eq. [1](https://ar5iv.org/html/2410.15624#S3.E1 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\");\n\n\nSelect a subset of candidates ùê±G‚Ä≤superscriptùê±superscriptùê∫‚Ä≤\\\\mathbf{x}^{G^{\\\\prime}} from the gallery using Eq. [4](https://ar5iv.org/html/2410.15624#S3.E4 \"In 3.2.1 Candidate Selection ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") ;\n\n// Candidate Selection\n\n5\nObtain the refined query predictions ùê©^^ùê©\\\\hat{\\\\mathbf{p}} in Eq. [5](https://ar5iv.org/html/2410.15624#S3.E5 \"In 3.2.1 Candidate Selection ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and the corresponding entropy E‚Äã(ùê±Q)ùê∏superscriptùê±ùëÑE(\\\\mathbf{x}^{Q});\n\n// Update the queue\n\n6if _s‚Äãt‚Äãe‚Äãp=1ùë†ùë°ùëíùëù1step=1_ then\n\n7\nCompute the criterion SI in Eq. [6](https://ar5iv.org/html/2410.15624#S3.E6 \"In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\");\n\n8\nSelect the 30%percent3030\\\\% query-candidate pairs with the smallest S‚ÄãIùëÜùêºSI;\n\n9\nMaintain a queue of size BùêµB to save the pairs and their corresponding entropies;\n\n10\n\n11    end if\n\nEstimate the modality gap ŒîSsubscriptŒîùëÜ\\\\Delta\\_{S} using Eq. [7](https://ar5iv.org/html/2410.15624#S3.E7 \"In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") ;\n\n// Constraint Estimation\n\n\nEstimate the desirable threshold Emsubscriptùê∏ùëöE\\_{m} using Eq. [8](https://ar5iv.org/html/2410.15624#S3.E8 \"In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") ;\n\n// Constraint Estimation\n\n12\nCompute the overall loss ‚Ñí‚Ñí\\\\mathcal{L} in Eq. [3](https://ar5iv.org/html/2410.15624#S3.E3 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") with ŒîSsubscriptŒîùëÜ\\\\Delta\\_{S} and Emsubscriptùê∏ùëöE\\_{m};\n\n13\nUpdate parameters Œò~~Œò\\\\tilde{\\\\Theta} through gradient descent to minimize ‚Ñí‚Ñí\\\\mathcal{L};\n\n14    end for\n\n15\n\n16 end for\n\nAlgorithm 1Test-time adaptation for Cross-modal Retrieval (TCR)\n\n## Appendix C An Alternative Implementation of TCR without training\n\nFrom the results in Fig. [3](https://ar5iv.org/html/2410.15624#S4.F3 \"Figure 3 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we observe that the performance could be boosted by simply scaling up the uniformity or rectifying the modality gap even without adopting the function.\nBased on the observation, in this section, we propose to implement TCR in an untrained manner, which demonstrates the great potential of TCR.\nSpecifically, to enhance the uniformity of the query modality,\nwe scale the given queries by Eq. [12](https://ar5iv.org/html/2410.15624#S4.E12 \"In 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") with ŒªscalesuperscriptùúÜscale\\\\lambda^{\\\\text{scale}} fixed at 222.\nTo adjust the inter-modality gap, we estimate the modality gap ŒîSsubscriptŒîùëÜ\\\\Delta\\_{S} of the source domain by Eq. [7](https://ar5iv.org/html/2410.15624#S3.E7 \"In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and then rectify the modality gap in the target domain to ŒîSsubscriptŒîùëÜ\\\\Delta\\_{S} by Eq. [13](https://ar5iv.org/html/2410.15624#S4.E13 \"In 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nThe details are presented in Algorithm [2](https://ar5iv.org/html/2410.15624#algorithm2 \"In Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and the experiment results are shown in Table [10](https://ar5iv.org/html/2410.15624#A4.T10 \"Table 10 ‚Ä£ D.3 Results on the All Severity Setting ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")- [11](https://ar5iv.org/html/2410.15624#A4.T11 \"Table 11 ‚Ä£ D.3 Results on the All Severity Setting ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\n\nInput:Test samples ùíüT={{ùê±iQ}i=1NQ,{ùê±jG}j=1NG}subscriptùíüùëásuperscriptsubscriptsuperscriptsubscriptùê±ùëñùëÑùëñ1superscriptùëÅùëÑsuperscriptsubscriptsuperscriptsubscriptùê±ùëóùê∫ùëó1superscriptùëÅùê∫\\\\mathcal{D}\\_{T}=\\\\left\\\\{\\\\{\\\\mathbf{x}\\_{i}^{Q}\\\\}\\_{i=1}^{N^{Q}},\\\\{\\\\mathbf{x}\\_{j}^{G}\\\\}\\_{j=1}^{N^{G}}\\\\right\\\\}, the source model fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}}, batch size BùêµB, scaling factor ŒªscalesuperscriptùúÜscale\\\\lambda^{\\\\text{scale}}.\n\nOutput:Predictions {ùê©i}i=1NQsuperscriptsubscriptsubscriptùê©ùëñùëñ1superscriptùëÅùëÑ\\\\{\\\\mathbf{p}\\_{i}\\\\}\\_{i=1}^{N^{Q}}.\n\n1\nInitialize Œò~0=Œòssubscript~Œò0subscriptŒòùë†\\\\tilde{\\\\Theta}\\_{0}=\\\\Theta\\_{s};\n\n2for _given queries ùê±Q‚ààùíüTsuperscriptùê±ùëÑsubscriptùíüùëá\\\\mathbf{x}^{Q}\\\\in\\\\mathcal{D}\\_{T}_ do\n\n\nSelect a subset of candidates ùê±G‚Ä≤superscriptùê±superscriptùê∫‚Ä≤\\\\mathbf{x}^{G^{\\\\prime}} from the gallery using Eq. [4](https://ar5iv.org/html/2410.15624#S3.E4 \"In 3.2.1 Candidate Selection ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") ;\n\n// Candidate Selection\n\n// Update the queue\n\n3\nCompute the criterion SI in Eq. [6](https://ar5iv.org/html/2410.15624#S3.E6 \"In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\");\n\n4\nSelect the 30%percent3030\\\\% query-candidate pairs with the smallest S‚ÄãIùëÜùêºSI;\n\n5\nMaintain a queue of size BùêµB to save the pairs;\n\n\nScale ùê±Qsuperscriptùê±ùëÑ\\\\mathbf{x}^{Q} using Eq. [12](https://ar5iv.org/html/2410.15624#S4.E12 \"In 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") with ŒªscalesuperscriptùúÜscale\\\\lambda^{\\\\text{scale}} ;\n\n// Scaling up Intra-modality Uniformity\n\n\nEstimate the modality gap ŒîSsubscriptŒîùëÜ\\\\Delta\\_{S} using Eq. [7](https://ar5iv.org/html/2410.15624#S3.E7 \"In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") ;\n\n// Constraint Estimation\n\n\nRectify the modality gap to ŒîSsubscriptŒîùëÜ\\\\Delta\\_{S} using Eq. [13](https://ar5iv.org/html/2410.15624#S4.E13 \"In 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") ;\n\n// Rectifying between-modality Gap\n\n6\nPerform ‚Ñì‚Äã2‚Ñì2\\\\ell 2-normalization on the embeddings in the query modality;\n\n7\nObtain the query predictions ùê©ùê©\\\\mathbf{p} in Eq. [1](https://ar5iv.org/html/2410.15624#S3.E1 \"In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\");\n\n8 end for\n\nAlgorithm 2An Implementation of Untrained TCR\n\nTable 7:\nComparisons with state-of-the-art methods on Flickr-C benchmark under query shift on the image modality with maximum severity level regarding the Recall@1 metric.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  | Noise | Blur | Weather | Digital |  |\n| Query Shift | Gauss. | Shot | Impul. | Speckle | Defoc. | Glass | Motion | Zoom | Snow | Frost | Fog | Brit. | Contr. | Elastic | Pixel | JPEG | Avg. |\n| BLIP ViT-B/16 | 49.8 | 56.6 | 50.3 | 71.6 | 53.1 | 84.5 | 47.4 | 15.5 | 66.4 | 80.4 | 79.5 | 85.5 | 60.6 | 53.3 | 35.1 | 80.3 | 60.6 |\n| ‚àô‚àô\\\\bullet~{}Tent | 54.9 | 54.9 | 54.3 | 73.1 | 53.3 | 85.3 | 47.9 | 1.6 | 67.2 | 80.9 | 79.6 | 86.8 | 63.6 | 53.4 | 35.4 | 81.4 | 60.9 |\n| ‚àô‚àô\\\\bullet~{}EATA | 55.5 | 60.5 | 55.8 | 75.8 | 64.6 | 86.2 | 52.2 | 8.5 | 72.0 | 83.7 | 82.5 | 87.9 | 68.4 | 60.1 | 45.9 | 81.6 | 65.1 |\n| ‚àô‚àô\\\\bullet~{}SAR | 54.8 | 62.5 | 55.6 | 75.2 | 48.3 | 87.2 | 34.8 | 15.5 | 71.9 | 83.1 | 82.2 | 87.9 | 68.2 | 60.3 | 42.2 | 81.4 | 63.2 |\n| ‚àô‚àô\\\\bullet~{}READ | 50.1 | 58.2 | 52.2 | 74.8 | 63.7 | 87.0 | 55.1 | 2.2 | 71.7 | 83.8 | 81.9 | 87.7 | 67.4 | 62.3 | 42.5 | 81.4 | 63.9 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 55.4 | 62.0 | 56.3 | 76.2 | 63.8 | 86.3 | 50.3 | 3.2 | 73.1 | 84.1 | 83.2 | 88.6 | 70.1 | 63.1 | 46.8 | 81.3 | 65.2 |\n| ‚àô‚àô\\\\bullet~{}Ours | 62.0 | 66.6 | 61.4 | 80.0 | 68.1 | 87.9 | 65.2 | 39.9 | 78.2 | 85.2 | 85.7 | 89.5 | 75.1 | 73.1 | 56.8 | 83.3 | 72.4 |\n| BLIP ViT-L/16 | 58.2 | 61.0 | 59.7 | 76.9 | 66.4 | 88.5 | 62.5 | 33.4 | 67.7 | 81.5 | 79.3 | 89.1 | 60.4 | 66.4 | 46.5 | 85.0 | 67.7 |\n| ‚àô‚àô\\\\bullet~{}Tent | 61.3 | 64.3 | 63.3 | 77.6 | 70.8 | 88.7 | 62.8 | 31.5 | 70.4 | 83.8 | 81.1 | 89.2 | 61.2 | 68.7 | 52.0 | 84.5 | 69.5 |\n| ‚àô‚àô\\\\bullet~{}EATA | 62.0 | 65.1 | 64.5 | 78.9 | 70.2 | 89.5 | 63.3 | 33.1 | 71.9 | 83.7 | 81.2 | 89.3 | 61.6 | 69.3 | 53.0 | 85.8 | 70.2 |\n| ‚àô‚àô\\\\bullet~{}SAR | 61.1 | 64.4 | 63.7 | 79.7 | 71.6 | 90.3 | 64.4 | 27.6 | 70.6 | 83.4 | 81.0 | 89.7 | 62.4 | 70.1 | 53.3 | 85.3 | 69.9 |\n| ‚àô‚àô\\\\bullet~{}READ | 61.1 | 64.4 | 63.7 | 79.7 | 71.6 | 90.3 | 64.4 | 27.6 | 70.6 | 83.4 | 81.0 | 89.7 | 62.4 | 70.1 | 53.3 | 85.3 | 69.9 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 61.5 | 61.0 | 62.1 | 78.3 | 69.6 | 89.5 | 62.5 | 37.2 | 72.1 | 83.6 | 81.4 | 89.9 | 61.3 | 67.6 | 52.5 | 86.8 | 69.8 |\n| ‚àô‚àô\\\\bullet~{}Ours | 68.2 | 71.7 | 70.2 | 83.3 | 74.7 | 91.9 | 72.5 | 49.6 | 78.2 | 87.0 | 85.5 | 92.1 | 70.9 | 79.6 | 65.5 | 87.8 | 76.8 |\n\nTable 8: Comparisons with state-of-the-art methods on Flickr-C benchmark under query shift on the text modality with maximum severity level regarding the Recall@1 metric.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  | Character-level | Word-level | Setence-level |  |\n| Query Shift | OCR | CI | CR | CS | CD | SR | RI | RS | RD | IP | Formal | Casual | Passive | Active | Backtrans | Avg. |\n| BLIP ViT-B/16 | 53.5 | 18.4 | 18.0 | 30.4 | 22.5 | 68.3 | 77.9 | 76.9 | 77.9 | 82.1 | 82.1 | 81.9 | 79.9 | 82.2 | 79.8 | 62.1 |\n| ‚àô‚àô\\\\bullet~{}Tent | 55.4 | 18.6 | 18.2 | 31.1 | 23.0 | 69.6 | 78.8 | 77.7 | 78.0 | 82.2 | 81.9 | 81.8 | 79.6 | 82.0 | 79.9 | 62.5 |\n| ‚àô‚àô\\\\bullet~{}EATA | 55.7 | 19.9 | 19.9 | 31.6 | 23.6 | 69.5 | 78.6 | 77.5 | 77.9 | 82.4 | 82.3 | 81.8 | 80.5 | 82.6 | 80.2 | 62.9 |\n| ‚àô‚àô\\\\bullet~{}SAR | 53.5 | 20.1 | 19.1 | 32.1 | 23.8 | 68.3 | 77.9 | 76.9 | 77.9 | 82.1 | 82.1 | 81.9 | 79.9 | 82.2 | 79.8 | 62.5 |\n| ‚àô‚àô\\\\bullet~{}READ | 55.8 | 19.7 | 20.6 | 32.0 | 23.5 | 69.3 | 78.6 | 77.6 | 78.1 | 82.4 | 82.2 | 81.8 | 80.5 | 82.5 | 80.2 | 63.0 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 53.5 | 18.4 | 18.0 | 30.4 | 22.5 | 68.3 | 77.9 | 76.9 | 77.9 | 82.1 | 82.1 | 81.9 | 79.9 | 82.2 | 79.8 | 62.1 |\n| ‚àô‚àô\\\\bullet~{}Ours | 57.1 | 21.4 | 22.5 | 33.6 | 25.1 | 69.8 | 79.3 | 78.0 | 78.1 | 82.5 | 82.4 | 82.2 | 81.0 | 82.6 | 80.2 | 63.7 |\n| BLIP ViT-L/16 | 58.0 | 22.2 | 22.0 | 34.1 | 25.1 | 71.2 | 79.9 | 78.9 | 78.8 | 83.3 | 83.1 | 82.7 | 81.7 | 83.5 | 80.7 | 64.4 |\n| ‚àô‚àô\\\\bullet~{}Tent | 59.0 | 22.4 | 22.1 | 34.5 | 25.3 | 71.4 | 80.3 | 79.3 | 78.8 | 83.7 | 82.8 | 82.7 | 81.8 | 83.3 | 80.7 | 64.6 |\n| ‚àô‚àô\\\\bullet~{}EATA | 59.1 | 23.0 | 23.2 | 35.1 | 25.6 | 71.7 | 80.3 | 79.3 | 78.8 | 83.5 | 83.0 | 83.2 | 81.8 | 83.5 | 80.7 | 64.8 |\n| ‚àô‚àô\\\\bullet~{}SAR | 58.1 | 23.1 | 23.0 | 34.5 | 25.8 | 71.2 | 79.9 | 78.9 | 78.8 | 83.3 | 83.1 | 82.7 | 81.7 | 83.4 | 80.7 | 64.6 |\n| ‚àô‚àô\\\\bullet~{}READ | 58.9 | 23.4 | 23.3 | 34.9 | 25.9 | 71.5 | 80.7 | 79.3 | 78.8 | 83.5 | 83.2 | 83.1 | 81.9 | 83.4 | 80.8 | 64.8 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 58.1 | 22.2 | 22.0 | 34.1 | 25.1 | 71.2 | 79.9 | 78.9 | 78.7 | 83.3 | 83.1 | 82.7 | 81.7 | 83.4 | 80.8 | 64.4 |\n| ‚àô‚àô\\\\bullet~{}Ours | 59.7 | 24.4 | 24.4 | 36.1 | 26.7 | 71.8 | 80.9 | 79.5 | 78.9 | 83.5 | 83.2 | 83.4 | 81.8 | 83.5 | 80.8 | 65.2 |\n\n## Appendix D More Experiment Results\n\n### D.1 Results on Flickr-C\n\nIn the manuscript, we have carried out experiments on the COCO-C benchmark. Here, we provide more results on the Flickr-C benchmark.\nAs shown in Table [7](https://ar5iv.org/html/2410.15624#A3.T7 \"Table 7 ‚Ä£ Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")- [8](https://ar5iv.org/html/2410.15624#A3.T8 \"Table 8 ‚Ä£ Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), TCR significantly outperforms all the baselines across various pre-trained model types and sizes on the Flickr-C benchmarks.\n\n### D.2 Experiment about Personalized Queries on Fashion-Gen\n\nAs mentioned in Introduction of the manuscript, different inquirers would submit personalized queries, e.g., some are drawn to fashionable handbags, while others are passionate about collecting a variety of shoes.\nTo further demonstrate the generalization of TCR in this scenario, we simulate the personalized queries on the Fashion-Gen benchmark.\nIn detail, following Cartella et al. ( [2023](https://ar5iv.org/html/2410.15624#bib.bib4 \"\")), we fine-tune the pre-trained CLIP on four publicly available fashion datasets including Fashion-Gen, Fashion IQ (Wu et al., [2021](https://ar5iv.org/html/2410.15624#bib.bib45 \"\")), Fashion200K (Han et al., [2017](https://ar5iv.org/html/2410.15624#bib.bib13 \"\")), and iMaterialist (Guo et al., [2019](https://ar5iv.org/html/2410.15624#bib.bib12 \"\")).\nAfter that, we employ TCR to adapt various preferences such as ‚ÄúTOPS‚Äù and ‚ÄúSWEATERS‚Äù on the Fashion-Gen benchmark.\nThe experimental results are presented in Table [9](https://ar5iv.org/html/2410.15624#A4.T9 \"Table 9 ‚Ä£ D.2 Experiment about Personalized Queries on Fashion-Gen ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), one could observe that TCR improves both image-to-text and text-to-image retrieval performance under personalized queries.\n\nTable 9: The cross-modal retrieval performance of TCR on Fashion-Gen benchmark with personalized queries regarding Recall@1 metric.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  | Query Shift | TOPS | SWEATERS | JACKETS | PANTS | JEANS | SHIRTS | DRESSES | SHORTS | SNEAKERS | SKIRTS | Avg. |\n| TR | BLIP ViT-B/32 | 18.0 | 19.3 | 19.9 | 12.0 | 5.5 | 18.3 | 38.1 | 17.9 | 37.3 | 29.6 | 21.6 |\n| ‚àô‚àô\\\\bullet~{}Ours | 22.9 | 25.2 | 21.6 | 14.3 | 6.0 | 22.8 | 44.3 | 8.5 | 41.7 | 37.4 | 24.5 |\n| IR | BLIP ViT-B/32 | 24.9 | 27.9 | 29.2 | 16.9 | 6.7 | 25.4 | 51.8 | 25.7 | 47.1 | 47.8 | 30.3 |\n| ‚àô‚àô\\\\bullet~{}Ours | 28.2 | 31.7 | 32.8 | 19.5 | 9.6 | 28.5 | 57.1 | 29.1 | 53.6 | 50.7 | 34.1 |\n\n![Refer to caption](https://ar5iv.org/html/2410.15624/assets/x6.png)Figure 6: Text retrieval performance comparisons on the COCO-C benchmark under query shift on the image modality with all severity levels regarding Recall@1 metric. The legend key provides an overview of the average performance of each approach across various corruption types.\n![Refer to caption](https://ar5iv.org/html/2410.15624/assets/x7.png)Figure 7: Image retrieval performance comparisons on the COCO-C benchmark under query shift on the text modality with all severity levels regarding Recall@1 metric.\n\n### D.3 Results on the All Severity Setting\n\nIn Section [4.2](https://ar5iv.org/html/2410.15624#S4.SS2 \"4.2 Comparisons with State-of-the-arts ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") of the manuscript and Appendix [D.1](https://ar5iv.org/html/2410.15624#A4.SS1 \"D.1 Results on Flickr-C ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we have demonstrated the effectiveness of TCR in handling query shift at the maximum severity level.\nTo further verify the robustness of TCR, we conduct more experiments on the COCO-C benchmark with query shift across all severity levels.\n\nThe results in Fig. [6](https://ar5iv.org/html/2410.15624#A4.F6 \"Figure 6 ‚Ä£ D.2 Experiment about Personalized Queries on Fashion-Gen ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")- [7](https://ar5iv.org/html/2410.15624#A4.F7 \"Figure 7 ‚Ä£ D.2 Experiment about Personalized Queries on Fashion-Gen ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") indicate the effectiveness of TCR in addressing various severity of the query shift.\n\nTable 10: The cross-modal retrieval performance of untrained TCR on COCO-C and Flickr-C benchmarks under image modality distribution shifts with maximum severity level regarding the Recall@1 metric.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  |  | Noise | Blur | Weather | Digital |  |\n| Dataset | Query Shift | Gauss. | Shot | Impul. | Speckle | Defoc. | Glass | Motion | Zoom | Snow | Frost | Fog | Brit. | Contr. | Elastic | Pixel | JPEG | Avg. |\n| Flickr-C | EATA | 55.5 | 60.5 | 55.8 | 75.8 | 64.6 | 86.2 | 52.2 | 8.5 | 72.0 | 83.7 | 82.5 | 87.9 | 68.4 | 60.1 | 45.9 | 81.6 | 65.1 |\n| Ours (untrain) | 58.7 | 63.2 | 58.1 | 78.8 | 65.9 | 87.8 | 61.2 | 34.6 | 79.2 | 84.8 | 84.4 | 89.1 | 68.2 | 67.4 | 46.0 | 83.0 | 69.4 |\n| Ours | 62.0 | 66.6 | 61.4 | 80.0 | 68.1 | 87.9 | 65.2 | 39.9 | 78.2 | 85.2 | 85.7 | 89.5 | 75.1 | 73.1 | 56.8 | 83.3 | 72.4 |\n| COCO-C | EATA | 41.4 | 50.3 | 35.7 | 63.1 | 49.8 | 72.2 | 46.2 | 6.9 | 45.6 | 56.7 | 62.5 | 71.4 | 43.6 | 51.3 | 25.6 | 67.0 | 49.3 |\n| Ours (untrain) | 48.8 | 51.7 | 49.8 | 61.5 | 53.9 | 72.6 | 49.4 | 18.7 | 49.7 | 60.5 | 67.1 | 71.4 | 43.9 | 49.9 | 26.7 | 67.4 | 52.7 |\n| Ours | 53.2 | 56.2 | 54.8 | 64.6 | 58.0 | 73.7 | 56.4 | 32.2 | 56.5 | 64.1 | 71.0 | 73.4 | 57.9 | 63.7 | 41.8 | 68.4 | 59.1 |\n\nTable 11: The cross-modal retrieval performance of untrained TCR on COCO-C and Flickr-C benchmarks under text modality distribution shifts with maximum severity level regarding the Recall@1 metric.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  |  | Character-level | Word-level | Setence-level |  |\n| Dataset | Query Shift | OCR | CI | CR | CS | CD | SR | RI | RS | RD | IP | Formal | Casual | Passive | Active | Backtrans | Avg. |\n| Flickr-C | EATA | 55.7 | 19.9 | 19.9 | 31.6 | 23.6 | 69.5 | 78.6 | 77.5 | 77.9 | 82.4 | 82.3 | 81.8 | 80.5 | 82.6 | 80.2 | 62.9 |\n| Ours (untrain) | 55.8 | 20.3 | 20.7 | 32.7 | 23.8 | 69.2 | 78.3 | 77.8 | 77.8 | 82.5 | 82.2 | 82.0 | 80.4 | 82.3 | 80.0 | 63.1 |\n| Ours | 57.1 | 21.4 | 22.5 | 33.6 | 25.1 | 69.8 | 79.3 | 78.0 | 78.1 | 82.5 | 82.4 | 82.2 | 81.0 | 82.6 | 80.2 | 63.7 |\n| COCO-C | EATA | 33.1 | 11.9 | 10.5 | 18.4 | 12.0 | 44.9 | 53.0 | 51.6 | 50.3 | 56.2 | 56.8 | 56.8 | 56.0 | 56.8 | 54.3 | 41.5 |\n| Ours (untrain) | 32.9 | 12.3 | 10.4 | 19.0 | 12.3 | 44.8 | 52.6 | 51.3 | 51.5 | 57.8 | 57.1 | 57.2 | 56.2 | 57.2 | 54.7 | 41.8 |\n| Ours | 34.1 | 13.7 | 11.8 | 19.5 | 13.2 | 45.3 | 53.8 | 51.8 | 51.5 | 57.3 | 57.1 | 56.8 | 56.0 | 57.3 | 54.7 | 42.3 |\n\n### D.4 Results of Untrained TCR\n\nHere, we perform experiments on the COCO-C and Flickr-C benchmarks to evaluate the proposed untrained TCR in Appendix [C](https://ar5iv.org/html/2410.15624#A3 \"Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nDuring the experiments, we compare untrained TCR with the best baseline EATA in Table [1](https://ar5iv.org/html/2410.15624#S4.T1 \"Table 1 ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")- [2](https://ar5iv.org/html/2410.15624#S4.T2 \"Table 2 ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nFrom the results in Table [10](https://ar5iv.org/html/2410.15624#A4.T10 \"Table 10 ‚Ä£ D.3 Results on the All Severity Setting ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Table [11](https://ar5iv.org/html/2410.15624#A4.T11 \"Table 11 ‚Ä£ D.3 Results on the All Severity Setting ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we observe that the untrained TCR achieves significant improvement over EATA, even without parameter update, which corroborates our observations and validates the effectiveness of the proposed TCR.\n\nTable 12: The intra-modality uniformity and inter-modality gap of different baselines after TTA under the ‚ÄúBase2COCO‚Äù setting. IU and TU indicate the uniformity of image and text modalities, respectively. MG indicates the modality gap.\n\n|     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- |\n| Method | IU | MG | TR@1 | TU | MG | IR@1 |\n| Base | 0.62 | 0.72 | 59.3 | 0.67 | 0.72 | 45.4 |\n| Tent | 0.82 | 0.74 | 61.7 | 0.85 | 0.76 | 41.7 |\n| EATA | 0.87 | 0.68 | 64.2 | 0.88 | 0.67 | 47.9 |\n| SAR | 0.86 | 0.70 | 63.5 | 0.74 | 0.69 | 46.6 |\n| READ | 0.85 | 0.72 | 62.1 | 0.84 | 0.70 | 46.4 |\n| DeYO | 0.88 | 0.68 | 65.0 | 0.86 | 0.67 | 47.3 |\n| Ours | 0.93 | 0.63 | 68.9 | 0.96 | 0.64 | 48.9 |\n\n### D.5 More Ablation Results\n\nWe provide more ablation studies under the ‚ÄúBase2COCO‚Äù setting to prove that TCR achieves better performance by enlarging intra-modality uniformity and rectifying the inter-modality gap.\nSpecifically, we present the intra-modality uniformity and inter-modality gap of different baselines after TTA in Table [12](https://ar5iv.org/html/2410.15624#A4.T12 \"Table 12 ‚Ä£ D.4 Results of Untrained TCR ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nThe results illustrate that i) most of the baselines improve the performance by implicitly enlarging the intra-modality uniformity and narrowing the modality gap; ii) the improvement of Tent is unstable due to the enlarged modality gap; iii) the proposed TCR achieves the highest intra-modality uniformity (0.930.930.93 and 0.960.960.96) and enjoys the modality gap (0.630.630.63 and 0.640.640.64) in the target domain close to that (0.670.670.67) in the source domain, thus contributing to boosting the performance.\nNotably, we obtain the modality gap in the source domain by constructing a subset of 12,000 image-text pairs derived from the COCO, Visual Genome (Krishna et al., [2017](https://ar5iv.org/html/2410.15624#bib.bib19 \"\")), CC3M (Changpinyo et al., [2021](https://ar5iv.org/html/2410.15624#bib.bib5 \"\")), and SBU Captions (Ordonez et al., [2011](https://ar5iv.org/html/2410.15624#bib.bib35 \"\")) datasets.\n\n![Refer to caption](https://ar5iv.org/html/2410.15624/assets/x8.png)Figure 8: The t-SNE visualization results of image retrieval on the query and gallery embeddings by employing the proposed TCR.\n\n### D.6 More Visualization Result\n\nAs shown in Fig. [4](https://ar5iv.org/html/2410.15624#S4.F4 \"Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(c) of the manuscript, we have visualized the text retrieval results before/after TTA.\nHere, we provide additional visualization results of image retrieval before/after TTA under the ‚ÄúBase2COCO‚Äù setting.\nThe results in Fig. [8](https://ar5iv.org/html/2410.15624#A4.F8 \"Figure 8 ‚Ä£ D.5 More Ablation Results ‚Ä£ Appendix D More Experiment Results ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") illustrate that samples in the query modality enjoy more scatter and the modality gap narrows after the TTA process, which proves that TCR improves performance in both TR and IR by rectifying the intra-modality uniformity and the inter-modality gap.\n\n[‚óÑ](https://ar5iv.org/html/2410.15623) [![ar5iv homepage](https://ar5iv.org/assets/ar5iv.png)](https://ar5iv.org/) [Feeling\\\\\n\\\\\nlucky?](https://ar5iv.org/feeling_lucky) [Conversion\\\\\n\\\\\nreport](https://ar5iv.org/log/2410.15624) [Report\\\\\n\\\\\nan issue](https://github.com/dginev/ar5iv/issues/new?template=improve-article--arxiv-id-.md&title=Improve+article+2410.15624) [View original\\\\\n\\\\\non arXiv](https://arxiv.org/abs/2410.15624) [‚ñ∫](https://ar5iv.org/html/2410.15625)",
  "sections": {
    "1 Introduction": {
      "content": "Given queries of interest, cross-modal retrieval (Faghri et al., [2017]; Lee et al., [2018]; Yan et al., [2023]; Wang et al., [2023]) try to associate some relevant samples from the gallery set across various modalities, supporting numerous applications such as intelligent surveillance and search engine.\nThe key to cross-modal retrieval is learning a well-established common space, hoping to distinguish different instances within the same modality while gathering the same instance across different modalities.\nRecently, the pre-trained models (Jia et al., [2021]; Yang et al., [2022]; Li et al., [2023]; Huang et al., [2024]) have emerged as the dominant paradigm for cross-modal retrieval.\nAs shown in Fig. [1]Figure 1 ‚Ä£ 1 Introduction ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a), after acquiring generic knowledge from the source domain, the pre-trained models can either perform zero-shot retrieval in the target domains or be fine-tuned on domain-specific data for customization.\n\nDespite the promising performance of the pre-trained models, their success heavily relies on the assumption that the given queries exactly follow the same distribution from the source domain, which is hard to satisfy in real-world applications.\nSpecifically, as shown in Fig. [1]Figure 1 ‚Ä£ 1 Introduction ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(b), inquirers might embrace different cultural backgrounds or enjoy their individual preferences, resulting in the online query stream derived from either scarce or highly personalized domains.\nClearly, such out-of-domain queries violate the identical distribution assumption and thus lead to the query shift problem.\nAs a result, the existing cross-modal retrieval models fail to handle the query shift and inevitably suffer from significant performance degradation, leaving an urgent need to develop an online adaptation method for addressing the query shift problem.\n\n![Refer to caption]Figure 1:\n(a) Dominant Paradigm:\nthe pre-trained models embrace powerful zero-shot retrieval capacity and could be fine-tuned on domain-specific data for customization, which has emerged as the dominant paradigm for cross-modal retrieval.\n(b) Query Shift:\nthe performance of the paradigm would be significantly degraded when encountering the query shift problem.\nOn the one hand, collecting sufficient data to tailor the pre-trained models for scarce domains is daunting and even impossible.\nOn the other hand, as the saying goes, ‚ÄúDifferent strokes for different folks‚Äù, even fine-tuned models cannot accommodate all personalized domains.\n(c) Observations: we study the query shift problem for cross-modal retrieval and reveal the following observations.\nNamely, query shift not only diminishes the uniformity of the query modality but also amplifies the modality gap between the query and gallery modalities, undermining the well-structured common space inherited from pre-trained models.\n\nAs one of the most effective paradigms in reconciling distribution shifts, Test-Time Adaptation (TTA) methods (Wang et al., [2021]; Press et al., [2023]; Niu et al., [2024]) work by continually updating the given source model using the online target data stream.\nAlthough achieving great success, it is intractable to adopt existing TTA methods for cross-modal retrieval with query shift due to the following two reasons.\nOn the one hand, most existing TTA methods focus on the unimodal setting while overlooking the complexity of the query shift in the cross-modal setting.\nMore specifically, the query shift in the cross-modal setting would not only affect the intra-modality distribution but also hinder the cross-modal alignment.\nOn the other hand, most existing TTA methods are specifically designed for the recognition task, which would struggle with the heavy noise from the query predictions if simply applied to the retrieval task.\nIntuitively, for a given sample or query, it has a random probability of 1/K1ùêæ1/K or 1/N1ùëÅ1/N to be correctly associated with the desirable category or cross-modal counterpart in the recognition task or retrieval task, where KùêæK and NùëÅN denote the class number and candidate number, respectively, with N‚â´Kmuch-greater-thanùëÅùêæN\\\\gg K.\n\nTo specifically develop a TTA method for cross-modal retrieval with the query shift, we first present two key observations as illustrated in Fig. [1]Figure 1 ‚Ä£ 1 Introduction ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(c).\nTo summarize, we conclude that the query shift would diminish the uniformity of the query modality, prohibiting discrimination between diverse queries in the common space.\nMoreover, query shift would amplify the modality gap between query and gallery modalities, undermining the well-constructed common space established by the pre-trained models.\n\nBased on the above observations, we propose achieving robust cross-modal retrieval against the query shift by endowing the existing TTA methods with the capacity to manipulate both the modality uniformity and modality gap.\nTo be specific, we propose a novel method, dubbed Test-time adaptation for Cross-modal Retrieval (TCR), which consists of a novel query prediction refinement module and a novel joint objective function.\nFirst, the query prediction refinement module is adopted to refine the retrieval results of the existing TTA methods and thus obtain the retrieval-favorable predictions for queries.\nAfter that, the joint objective is employed on the refined query predictions to achieve online adaptation for cross-modal retrieval models under query shift.\nMore specifically, the joint objective function is composed of three individual losses that embrace the following merits.\nTo enhance the uniformity of the query modality, the intra-modality uniformity learning loss performs contrast between queries and their respective centers, thus guaranteeing the discrimination between queries.\nTo rectify the modality gap between the query and gallery modalities, the inter-modality gap learning loss narrows the difference between the query and gallery modalities with the plausible constraint estimated from off-the-shelf models, thus inheriting the well-established common space.\nTo prevent overfitting on noisy query predictions, the noise-robust adaptation loss amplifies the contribution of high-confident predictions while alleviating the noisy ones with a self-adaptive threshold.\nThe major contributions of this work could be summarized as follows.\n\n- ‚Ä¢\n\n\nTo the best of our knowledge, this work could be one of the first studies on the query shift problem, revealing its underlying impacts on cross-modal retrieval. Specifically, the query shift would not only diminish the uniformity of the query modality but also amplify the modality gap between query and gallery modalities, undermining the well-established common space derived from the source model.\n\n- ‚Ä¢\n\n\nWe propose a novel test-time adaptation method named TCR. TCR first employs a novel module to refine the query predictions, thus supporting the existing TTA methods for cross-modal retrieval. Then, TCR adopts a novel objective function that can not only manipulate both the modality uniformity and modality gap but also prevent the model from overfitting noisy query predictions, thus achieving robust cross-modal retrieval with query shift.\n\n- ‚Ä¢\n\n\nExtensive experiments verify the effectiveness of the proposed method. Furthermore, we benchmark the existing TTA methods on cross-modal retrieval with query shift across six widely-used image-text datasets, hoping to facilitate the study of test-time adaptation beyond unimodal tasks.",
      "citations": [
        {
          "start_pos": 50,
          "end_pos": 71,
          "text": "Faghri et al., [2017]",
          "paper_id": "bib.bib9",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 73,
          "end_pos": 91,
          "text": "Lee et al., [2018]",
          "paper_id": "bib.bib21",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 93,
          "end_pos": 111,
          "text": "Yan et al., [2023]",
          "paper_id": "bib.bib46",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 113,
          "end_pos": 132,
          "text": "Wang et al., [2023]",
          "paper_id": "bib.bib44",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 548,
          "end_pos": 566,
          "text": "Jia et al., [2021]",
          "paper_id": "bib.bib16",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 568,
          "end_pos": 587,
          "text": "Yang et al., [2022]",
          "paper_id": "bib.bib47",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 589,
          "end_pos": 606,
          "text": "Li et al., [2023]",
          "paper_id": "bib.bib23",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 608,
          "end_pos": 628,
          "text": "Huang et al., [2024]",
          "paper_id": "bib.bib15",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3082,
          "end_pos": 3101,
          "text": "Wang et al., [2021]",
          "paper_id": "bib.bib43",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3103,
          "end_pos": 3123,
          "text": "Press et al., [2023]",
          "paper_id": "bib.bib38",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3125,
          "end_pos": 3143,
          "text": "Niu et al., [2024]",
          "paper_id": "bib.bib34",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        }
      ]
    },
    "2 Related Work": {
      "content": "In this section, we briefly review two topics related to this\nwork, i.e., domain adaptation for cross-modal retrieval and test-time adaptation.\n\n### 2.1 Domain Adaptation for Cross-modal Retrieval\n\nCross-modal retrieval aims to establish a well-structured common space, where semantically-relevant candidates could be prioritized for the queries.\nHowever, most existing cross-modal retrieval methods implicitly assume that the given queries follow the same distribution as the source data.\nUnfortunately, such an ideal assumption is easily violated due to the complexity of real-world applications, leading to the query shift problem as discussed in Introduction.\nTo address the problem, some Unsupervised Domain Adaptation (UDA) methods have been proposed to reconcile the distribution differences for robust cross-modal retrieval.\nBased on the way to achieve robustness against query shift, these approaches could be roughly grouped into the following three categories:\ni) pseudo-labeling methods (Munro et al., [2021]; Hao et al., [2023]), which first select the most relevant cross-modal pairs as positives while treating the irrelevant pairs as negatives and then conduct metric learning upon the pairs to adapt the model for target domains;\nii) domain alignment methods (Peng & Chi, [2019]), which mitigate distribution discrepancies between the target and source domains by resorting to the maximum mean discrepancy minimization or mutual information minimization approaches;\niii) prototype-based methods (Liu et al., [2021a]; Chen et al., [2021]), which first constructs different sets of prototypes to represent various domains and then achieves domain adaptation by minimizing the KL divergence between the corresponding prototype sets.\n\nDespite the promising performance, the existing domain adaptation works for cross-modal retrieval require accessing the entire target domain.\nAs a result, these works cannot achieve adaptation for the online query stream, limiting their practicability in real-time scenarios such as search engine.\nDifferent from them, this paper proposes a new adaptation method for addressing the query shift problem, which could be one of the first online adaptation approaches for cross-modal retrieval.\n\n### 2.2 Test-time adaptation\n\nTest-time Adaptation (TTA) has emerged as a promising avenue for domain adaptation, which aims to reconcile the distribution shifts in an online manner.\nTowards achieving this goal, some Test-Time Training (TTT) approaches (Sun et al., [2020]; Liu et al., [2021b]; Gandelsman et al., [2022]) have been proposed, which require modifying the training process of the source model and adding an auxiliary self-supervised task.\nAs a result, the source model could be adapted by performing the self-supervised task on the online target data stream.\nTo avoid the reduplicated training cost of the source model, Fully Test-Time Adaptation Wang et al. ( [2021]) paradigm has been proposed, which could be coarsely divided into the following three categories: i) online TTA methods (Yuan et al., [2024]; Chen et al., [2022]), which continually update the normalization layers by resorting to the unsupervised objectives, such as entropy minimization or its variants. ii) robust TTA methods (Lee et al., [2024]; Zancato et al., [2023]), which strive to improve the robustness against noisy predictions, mixed distribution shifts, label shifts, and so on. iii) TTA beyond recognition, which focuses on the tasks including but not limited to image restoration (Gou et al., [2024]), multimodal recognition (Yang et al., [2024]), and multimodal segmentation (Cao et al., [2023]).\n\nIn this paper, we focus on online TTA for achieving robust cross-modal retrieval against query shift.\nAmong existing approaches, DISC (Ma et al., [2024]) is most relevant to our work, while having significantly different motivations.\nIn brief, DISC is designed to adapt the pre-trained image hashing models against the distribution shift for achieving effective retrieval in the target domain.\nDifferent from DISC, our work focuses on addressing the query shift problem for cross-modal retrieval, which is less-touched by the existing studies.\nMoreover, unlike DISC that requires accessing the source data to train the hashing model, our TCR could adapt the off-the-shelf pre-trained models without using the source data.\n\n![Refer to caption]Figure 2:\nOverview of the proposed TCR.\nFor the given online queries, the modality-specific encoders are employed to project the query and gallery samples into the latent space established by the source model.\nThe obtained query embeddings and gallery embeddings are passed into the query prediction refinement module.\nIn the module, TCR first selects the most similar gallery sample for each query and obtain the query-gallery pairs.\nAfter that, the pairs with higher uniformity and lower modality gap are chosen to estimate the filtering threshold of query predictions and modality gap of the source model as the constraints for the adaptation.\nFinally, three loss functions are employed to achieve robust adaptation for cross-modal retrieval with query shift.",
      "citations": [
        {
          "start_pos": 1000,
          "end_pos": 1020,
          "text": "Munro et al., [2021]",
          "paper_id": "bib.bib31",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 1022,
          "end_pos": 1040,
          "text": "Hao et al., [2023]",
          "paper_id": "bib.bib14",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 1277,
          "end_pos": 1295,
          "text": "Peng & Chi, [2019]",
          "paper_id": "bib.bib36",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 1513,
          "end_pos": 1532,
          "text": "Liu et al., [2021a]",
          "paper_id": "bib.bib27",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 1534,
          "end_pos": 1553,
          "text": "Chen et al., [2021]",
          "paper_id": "bib.bib7",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 2494,
          "end_pos": 2512,
          "text": "Sun et al., [2020]",
          "paper_id": "bib.bib42",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 2514,
          "end_pos": 2533,
          "text": "Liu et al., [2021b]",
          "paper_id": "bib.bib28",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 2535,
          "end_pos": 2560,
          "text": "Gandelsman et al., [2022]",
          "paper_id": "bib.bib10",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 2901,
          "end_pos": 2921,
          "text": "Wang et al. ( [2021]",
          "paper_id": "bib.bib43",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3043,
          "end_pos": 3062,
          "text": "Yuan et al., [2024]",
          "paper_id": "bib.bib49",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3064,
          "end_pos": 3083,
          "text": "Chen et al., [2022]",
          "paper_id": "bib.bib6",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3251,
          "end_pos": 3269,
          "text": "Lee et al., [2024]",
          "paper_id": "bib.bib20",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3271,
          "end_pos": 3293,
          "text": "Zancato et al., [2023]",
          "paper_id": "bib.bib50",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3518,
          "end_pos": 3536,
          "text": "Gou et al., [2024]",
          "paper_id": "bib.bib11",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3563,
          "end_pos": 3582,
          "text": "Yang et al., [2024]",
          "paper_id": "bib.bib48",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 3614,
          "end_pos": 3632,
          "text": "Cao et al., [2023]",
          "paper_id": "bib.bib2",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": [
            "bib.bib1"
          ]
        },
        {
          "start_pos": 3771,
          "end_pos": 3788,
          "text": "Ma et al., [2024]",
          "paper_id": "bib.bib30",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        }
      ]
    },
    "3 Method": {
      "content": "In this section, we introduce the proposed Test-time adaptation for Cross-modal Retrieval (TCR) to handle the query shift problem for cross-modal retrieval.\nThe section is structured as follows.\nIn Section [3.1]Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we present the formal definition of the query shift problem and design a simple baseline to facilitate TTA for cross-modal retrieval.\nIn Section [3.2]Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we propose the query prediction refinement module to derive the retrieval-favorable query predictions.\nIn Section [3.3]Intra-modality Uniformity Learning ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")- [3.5]Noise-robust Adaptation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we design a novel joint objective function to achieve robust cross-modal retrieval against query shift.\n\n### 3.1 Notations and Problem Formulation\n\nWithout loss of generality, we take two modalities as a showcase to elaborate on the query shift problem.\nLet fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}} denote the multimodal model pre-trained on the source-domain data ùíüSsubscriptùíüùëÜ\\\\mathcal{D}\\_{S}, which consists of two modality-specific encoders, i.e., fŒòsQsubscriptùëìsubscriptsuperscriptŒòùëÑùë†f\\_{\\\\Theta^{Q}\\_{s}} and fŒòsGsubscriptùëìsubscriptsuperscriptŒòùê∫ùë†f\\_{\\\\Theta^{G}\\_{s}}.\nFor a given query ùê±iQsubscriptsuperscriptùê±ùëÑùëñ\\\\mathbf{x}^{Q}\\_{i} from the target domain data ùíüT={ùêóQ={ùê±iQ}i=1NQ,ùêóG={ùê±jG}j=1NG}subscriptùíüùëáformulae-sequencesuperscriptùêóùëÑsuperscriptsubscriptsuperscriptsubscriptùê±ùëñùëÑùëñ1superscriptùëÅùëÑsuperscriptùêóùê∫superscriptsubscriptsuperscriptsubscriptùê±ùëóùê∫ùëó1superscriptùëÅùê∫\\\\mathcal{D}\\_{T}=\\\\left\\\\{\\\\mathbf{X}^{Q}=\\\\{\\\\mathbf{x}\\_{i}^{Q}\\\\}\\_{i=1}^{N^{Q}},\\\\mathbf{X}^{G}=\\\\{\\\\mathbf{x}\\_{j}^{G}\\\\}\\_{j=1}^{N^{G}}\\\\right\\\\}, cross-modal retrieval aims to associate the corresponding sample ùê±jGsubscriptsuperscriptùê±ùê∫ùëó\\\\mathbf{x}^{G}\\_{j} from the gallery set ùêóGsuperscriptùêóùê∫\\\\mathbf{X}^{G} by resorting to the common space established by fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}}, where QùëÑQ and Gùê∫G denotes as query modality and gallery modality for clarity in the following.\nIn real-world applications, the given queries are usually from the distribution distinct with the source-domain data, i.e., ùí´‚Äã(ùíüT)‚àºÃ∏ùí´‚Äã(ùíüS)not-similar-toùí´subscriptùíüùëáùí´subscriptùíüùëÜ\\\\mathcal{P}\\\\left(\\\\mathcal{D}\\_{T}\\\\right)\\\\not\\\\sim\\\\mathcal{P}\\\\left(\\\\mathcal{D}\\_{S}\\\\right), where ùí´‚Äã(ùíü)ùí´ùíü\\\\mathcal{P}\\\\left(\\\\mathcal{D}\\\\right) denotes the distribution of the given data ùíüùíü\\\\mathcal{D}.\nAs a result, such a query shift problem would lead to the performance degradation of fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}} as verified in the experiments.\n\nTo achieve online adaptation for fŒòssubscriptùëìsubscriptŒòùë†f\\_{\\\\Theta\\_{s}} with query shift, we first propose a simple baseline that endows the unimodal-recognition-oriented TTA approaches with the capacity to handle the cross-modal retrieval task.\nTo be specific, we formulate the retrieval task as a query prediction process in analogy with the recognition task that assigns the given samples to their corresponding categories.\nFormally, for a given online batch of queries with size BùêµB, the corresponding query predictions could be defined as\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ùê©=Softmax‚Å°(ùê≥Q‚Äã(ùêôG)T/œÑ),ùê©Softmaxsuperscriptùê≥ùëÑsuperscriptsuperscriptùêôùê∫ùëáùúè\\\\mathbf{p}=\\\\operatorname{Softmax}\\\\left(\\\\mathbf{z}^{Q}\\\\left(\\\\mathbf{Z}^{G}\\\\right)^{T}/\\\\tau\\\\right), |  | (1) |\n\nwhere œÑùúè\\\\tau is the temperature that controls the trade-off between the smoothness and sharpness of the predictions, ùê≥Q=fŒòsQ‚Äã(ùê±Q)‚àà‚ÑùB√óDsuperscriptùê≥ùëÑsubscriptùëìsubscriptsuperscriptŒòùëÑùë†superscriptùê±ùëÑsuperscript‚Ñùùêµùê∑\\\\mathbf{z}^{Q}=f\\_{\\\\Theta^{Q}\\_{s}}(\\\\mathbf{x}^{Q})\\\\in\\\\mathbb{R}^{B\\\\times D} and ùêôG=fŒòsG‚Äã(ùêóG)‚àà‚ÑùNG√óDsuperscriptùêôùê∫subscriptùëìsubscriptsuperscriptŒòùê∫ùë†superscriptùêóùê∫superscript‚ÑùsuperscriptùëÅùê∫ùê∑\\\\mathbf{Z}^{G}=f\\_{\\\\Theta^{G}\\_{s}}(\\\\mathbf{X}^{G})\\\\in\\\\mathbb{R}^{N^{G}\\\\times D} are the ‚Ñì‚Äã2‚Ñì2\\\\ell 2-normalized embeddings with the dimensionality of Dùê∑D for the given query and gallery samples, respectively.\nThanks to the above formulation, most existing TTA methods could be adopted to handle the query shift challenge with the following objective,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | minŒò~‚Å°‚ÑíT‚ÄãT‚ÄãA‚Äã(ùê©),subscript~Œòsubscript‚Ñíùëáùëáùê¥ùê©\\\\min\\_{\\\\tilde{\\\\Theta}}\\\\mathcal{L}\\_{TTA}\\\\left(\\\\mathbf{p}\\\\right), |  | (2) |\n\nwhere Œò~‚äÜŒòs~ŒòsubscriptŒòùë†\\\\tilde{\\\\Theta}\\\\subseteq\\\\Theta\\_{s} is the learnable parameters.\nHowever, such a simple formulation of query prediction would result in either model underfitting or overfitting even with carefully tuning of œÑùúè\\\\tau due to the variable gallery sizes, as verified in Table [3]Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Fig. [4]Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a).\nFurthermore, such a simple baseline overlooks the underlying influences behind the query shift problem and thus fails to achieve promising performance as discussed in Introduction.\nOn the one hand, the existing TTA methods cannot explicitly manipulate the intra-modality uniformity and inter-modality gap.\nOn the other hand, these methods struggle to account for the heavy noise from the query prediction.\n\nAs a remedy, we propose Test-time adaptation for Cross-modal Retrieval (TCR).\nAs shown in Fig. [2]Figure 2 ‚Ä£ 2.2 Test-time adaptation ‚Ä£ 2 Related Work ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), for the given online batch of queries, TCR first employs the novel query prediction refinement module to obtain the retrieval-favorable predictions ùê©^^ùê©\\\\hat{\\\\mathbf{p}}.\nAfter that, the following joint objective consisting of three novel loss functions is adopted to achieve robust cross-modal retrieval against the query shift, i.e.,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | minŒò~‚Å°‚Ñí‚Äã(ùê©^),subscript~Œò‚Ñí^ùê©\\\\min\\_{\\\\tilde{\\\\Theta}}\\\\mathcal{L}\\\\left(\\\\hat{\\\\mathbf{p}}\\\\right), |  | (3) |\n\nwhere ‚Ñí=‚ÑíM‚ÄãU+‚ÑíM‚ÄãG+‚ÑíN‚ÄãA‚Ñísubscript‚ÑíùëÄùëàsubscript‚ÑíùëÄùê∫subscript‚ÑíùëÅùê¥\\\\mathcal{L}=\\\\mathcal{L}\\_{MU}+\\\\mathcal{L}\\_{MG}+\\\\mathcal{L}\\_{NA}, with ‚ÑíM‚ÄãUsubscript‚ÑíùëÄùëà\\\\mathcal{L}\\_{MU}, ‚ÑíM‚ÄãGsubscript‚ÑíùëÄùê∫\\\\mathcal{L}\\_{MG}, and ‚ÑíN‚ÄãAsubscript‚ÑíùëÅùê¥\\\\mathcal{L}\\_{NA} denote the intra-modality uniformity learning loss, inter-modality gap learning loss, and the noise-robust adaptation loss, respectively.\nIn the following, we will elaborate on each loss individually.\n\n### 3.2 Query Prediction Refinement\n\nIn this section, we introduce the query prediction refinement module which involves refining the prediction for the given queries and estimating the constraints to support the optimization of Eq. [3]In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\n\n#### 3.2.1 Candidate Selection\n\nTo break the dilemma of vanilla query prediction formulation in Eq. [1]In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we propose selecting a subset of candidates from the gallery and then establishing new query predictions for the given queries.\nMathematically, for each given query ùê±iQsubscriptsuperscriptùê±ùëÑùëñ\\\\mathbf{x}^{Q}\\_{i}, the corresponding candidate in the gallery is obtain via\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ùê±iG‚Ä≤=ùí©‚Äã(ùê±iQ),subscriptsuperscriptùê±superscriptùê∫‚Ä≤ùëñùí©subscriptsuperscriptùê±ùëÑùëñ\\\\mathbf{x}^{G^{\\\\prime}}\\_{i}=\\\\mathcal{N}(\\\\mathbf{x}^{Q}\\_{i}), |  | (4) |\n\nwhere ùí©‚Äã(‚ãÖ)ùí©‚ãÖ\\\\mathcal{N}(\\\\cdot) denotes the selection manner, and we adopt the nearest neighborhood selection in the common space for simplicity.\nIn other words, we retrieve the most similar sample from the gallery set for each query and thus obtain query-candidate pairs (ùê≥Q,ùê≥G‚Ä≤)superscriptùê≥ùëÑsuperscriptùê≥superscriptùê∫‚Ä≤(\\\\mathbf{z}^{Q},\\\\mathbf{z}^{G^{\\\\prime}}).\nConsequently, the refined query predictions for the online-batched queries ùê±Qsuperscriptùê±ùëÑ\\\\mathbf{x}^{Q} could be formulated as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ùê©^=Softmax‚Å°(ùê≥Q‚Äã(ùêôG‚Ä≤)T/œÑ),^ùê©Softmaxsuperscriptùê≥ùëÑsuperscriptsuperscriptùêôsuperscriptùê∫‚Ä≤ùëáùúè\\\\mathbf{\\\\hat{p}}=\\\\operatorname{Softmax}\\\\left(\\\\mathbf{z}^{Q}\\\\left(\\\\mathbf{Z}^{G^{\\\\prime}}\\\\right)^{T}/\\\\tau\\\\right), |  | (5) |\n\nwhere ùêôG‚Ä≤superscriptùêôsuperscriptùê∫‚Ä≤\\\\mathbf{Z}^{G^{\\\\prime}} are the embeddings of the selected candidates for ùê±Qsuperscriptùê±ùëÑ\\\\mathbf{x}^{Q}.\nThe query prediction refinement manner embraces the following two merits.\nOn the one hand, the query prediction refinement manner could exclude some irrelevant samples in the gallery, thus preventing the model from overfitting to some extent.\nOn the other hand, the excluded irrelevant samples would avoid looking for a needle in a bottle of hay for queries, thus alleviating the model underfitting issue.\n\n#### 3.2.2 Constraint Estimation\n\nIt is widely acknowledged that source data could effectively regulate the domain adaptation process (Long et al., [2017]; Kang et al., [2019]), thus circumventing the catastrophic forgetting issue.\nDue to the unavailability of the source data in the test-time adaptation, we propose further choosing some source-domain-like data from the selected query-candidate pairs to estimate desirable constraints that support the optimization of Eq. [3]In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nTo this end, we first design a criterion for choosing the query-candidate pair (ùê≥iQ,ùê≥iG‚Ä≤)superscriptsubscriptùê≥ùëñùëÑsuperscriptsubscriptùê≥ùëñsuperscriptùê∫‚Ä≤(\\\\mathbf{z}\\_{i}^{Q},\\\\mathbf{z}\\_{i}^{G^{\\\\prime}}), i.e.,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | SI=2‚Äã(‚Äñùê≥iQ‚àíùê≥iG‚Ä≤‚Äñ)‚àí(‚Äñùê≥iQ‚àíùê≥¬ØQ‚Äñ+‚Äñùê≥iG‚Ä≤‚àíùê≥¬ØG‚Ä≤‚Äñ),SI2normsuperscriptsubscriptùê≥ùëñùëÑsuperscriptsubscriptùê≥ùëñsuperscriptùê∫‚Ä≤normsuperscriptsubscriptùê≥ùëñùëÑsuperscript¬Øùê≥ùëÑnormsuperscriptsubscriptùê≥ùëñsuperscriptùê∫‚Ä≤superscript¬Øùê≥superscriptùê∫‚Ä≤\\\\text{SI}=2\\\\left(\\\\\\|\\\\mathbf{z}\\_{i}^{Q}-\\\\mathbf{z}\\_{i}^{G^{\\\\prime}}\\\\\\|\\\\right)-\\\\left(\\\\\\|\\\\mathbf{z}\\_{i}^{Q}-\\\\overline{\\\\mathbf{z}}^{Q}\\\\\\|+\\\\\\|\\\\mathbf{z}\\_{i}^{G^{\\\\prime}}-\\\\overline{\\\\mathbf{z}}^{G^{\\\\prime}}\\\\\\|\\\\right), |  | (6) |\n\nwhere ùê≥¬ØQ=1B‚Äã‚àëiBùê≥iQsuperscript¬Øùê≥ùëÑ1ùêµsuperscriptsubscriptùëñùêµsuperscriptsubscriptùê≥ùëñùëÑ\\\\overline{\\\\mathbf{z}}^{Q}=\\\\frac{1}{B}\\\\sum\\_{i}^{B}\\\\mathbf{z}\\_{i}^{Q} and ùê≥¬ØG‚Ä≤=1B‚Äã‚àëiBùê≥iG‚Ä≤superscript¬Øùê≥superscriptùê∫‚Ä≤1ùêµsuperscriptsubscriptùëñùêµsuperscriptsubscriptùê≥ùëñsuperscriptùê∫‚Ä≤\\\\overline{\\\\mathbf{z}}^{G^{\\\\prime}}=\\\\frac{1}{B}\\\\sum\\_{i}^{B}\\\\mathbf{z}\\_{i}^{G^{\\\\prime}} are the centers of the given queries and the selected candidates, respectively.\nIn the implementation, we choose 30%percent3030\\\\% query-candidate pairs with the smallest SI value, namely, (ùê≥Qm,ùê≥Gm‚Ä≤)superscriptùê≥subscriptùëÑùëösuperscriptùê≥subscriptsuperscriptùê∫‚Ä≤ùëö(\\\\mathbf{z}^{Q\\_{m}},\\\\mathbf{z}^{G^{\\\\prime}\\_{m}}) of size MùëÄM, as the source-domain-like data.\nClearly, a low value of the criterion has the incentive to select the query-candidate pairs with the small modality gap and high intra-modality uniformity, which have higher probability to be source-domain-like, as verified in Fig. [3]Figure 3 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\n\nBased on the selected source-domain-like data, we propose estimating the modality gap of the source model as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ŒîS=‚Äñ1M‚Äã‚àëiMùê≥iQm‚àí1M‚Äã‚àëjMùê≥jGm‚Ä≤‚Äñ,subscriptŒîùëÜnorm1ùëÄsuperscriptsubscriptùëñùëÄsubscriptsuperscriptùê≥subscriptùëÑùëöùëñ1ùëÄsuperscriptsubscriptùëóùëÄsubscriptsuperscriptùê≥superscriptsubscriptùê∫ùëö‚Ä≤ùëó\\\\Delta\\_{S}=\\\\left\\\\\\|\\\\frac{1}{M}\\\\sum\\_{i}^{M}\\\\mathbf{z}^{Q\\_{m}}\\_{i}-\\\\frac{1}{M}\\\\sum\\_{j}^{M}\\\\mathbf{z}^{G\\_{m}^{\\\\prime}}\\_{j}\\\\right\\\\\\|, |  | (7) |\n\nwhere ùê≥iQmsubscriptsuperscriptùê≥subscriptùëÑùëöùëñ\\\\mathbf{z}^{Q\\_{m}}\\_{i} and ùê≥jGm‚Ä≤subscriptsuperscriptùê≥superscriptsubscriptùê∫ùëö‚Ä≤ùëó\\\\mathbf{z}^{G\\_{m}^{\\\\prime}}\\_{j} denote the iùëñi-th query sample and the jùëój-th gallery sample in the query-candidate pairs, respectively.\nAs the another by-product, a desirable threshold that could filter the noise in the query predictions ùê©^^ùê©\\\\hat{\\\\mathbf{p}} could be adaptively determined as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | Em=maxi=1,‚Ä¶,M‚Å°E‚Äã(ùê±iQm),subscriptùê∏ùëösubscriptùëñ1‚Ä¶ùëÄùê∏superscriptsubscriptùê±ùëñsubscriptùëÑùëöE\\_{m}=\\\\max\\_{i=1,\\\\dots,M}E\\\\left(\\\\mathbf{x}\\_{i}^{Q\\_{m}}\\\\right), |  | (8) |\n\nwhere E‚Äã(‚ãÖ)ùê∏‚ãÖE\\\\left(\\\\cdot\\\\right) indicates the entropy based on the refined query predictions.\n\n### 3.3 Intra-modality Uniformity Learning\n\nAs discussed in Introduction, query shift would diminish the uniformity of the query modality, resulting in confused queries with lower discrimination in the common space.\nTo address the problem, we propose to perform the contrast between queries and their respective centers, thus explicitly enlarging the intra-modality uniformity.\nMathematically, the loss function of intra-modality uniformity learning is defined as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ‚ÑíM‚ÄãU=1B‚Äã‚àëiBe‚Äãx‚Äãp‚Äã(‚àí‚Äñùê≥iQ‚àíùê≥¬ØQ‚Äñ/t)subscript‚ÑíùëÄùëà1ùêµsuperscriptsubscriptùëñùêµùëíùë•ùëùnormsuperscriptsubscriptùê≥ùëñùëÑsuperscript¬Øùê≥ùëÑùë°\\\\mathcal{L}\\_{MU}=\\\\frac{1}{B}\\\\sum\\_{i}^{B}exp\\\\left(-\\\\\\|\\\\mathbf{z}\\_{i}^{Q}-\\\\overline{\\\\mathbf{z}}^{Q}\\\\\\|/t\\\\right) |  | (9) |\n\nwhere tùë°t is the trade-off parameter to control the uniformity that is fixed as 101010 in the experiments.\n\n### 3.4 Inter-modality Gap Leaning\n\nAs discussed in Introduction, query shift would amplify the modality gap between query and gallery modalities, disrupting the cross-modal alignment established by the source model.\nTo remedy this, we propose to rectify the difference between the query and gallery modalities to the estimated modality gap of the source model in Eq. [7]In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nFormally, the inter-modality gap learning loss is defined as follows,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ‚ÑíM‚ÄãG=(ŒîT‚àíŒîS)2,subscript‚ÑíùëÄùê∫superscriptsubscriptŒîùëásubscriptŒîùëÜ2\\\\mathcal{L}\\_{MG}=\\\\left(\\\\Delta\\_{T}-\\\\Delta\\_{S}\\\\right)^{2}, |  | (10) |\n\nwhere ŒîT=‚Äñùê≥¬ØQ‚àíùê≥¬ØG‚Ä≤‚ÄñsubscriptŒîùëánormsuperscript¬Øùê≥ùëÑsuperscript¬Øùê≥superscriptùê∫‚Ä≤\\\\Delta\\_{T}=\\\\left\\\\\\|\\\\overline{\\\\mathbf{z}}^{Q}-\\\\overline{\\\\mathbf{z}}^{G^{\\\\prime}}\\\\right\\\\\\| denotes the modality gap of the target domain.\nThe key idea behind ‚ÑíM‚ÄãGsubscript‚ÑíùëÄùê∫\\\\mathcal{L}\\_{MG} is that the modality gap rectification would take advantage of well-aligned multimodal common space from the source model, thus boosting retrieval performance.\nNotably, as observed in Liang et al. ( [2022]), over-eliminating the modality gap would not improve or even degrade the performance of the multimodal model.\nTherefore, we believe the proposed loss that rectifies the modality gap of the target model to a plausible constraint in a non-monotonic manner is reasonable.\nThe experimental results in Fig. [3]Figure 3 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") could support the claims.\n\n### 3.5 Noise-robust Adaptation\n\nTo achieve robustness against the heavy noise on the query predictions, we propose the following noise-robust adaptation loss,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | ‚ÑíN‚ÄãA=1‚àëiùïÄ{S‚Äã(ùê±iQ)‚â†0}‚Äã‚àëi=1NQS‚Äã(ùê±iQ)‚ÄãE‚Äã(ùê±iQ),where‚ÄãS‚Äã(ùê±iQ)=max‚Å°(1‚àíE‚Äã(ùê±iQ)Em,0),formulae-sequencesubscript‚ÑíùëÅùê¥1subscriptùëñsubscriptùïÄùëÜsuperscriptsubscriptùê±ùëñùëÑ0superscriptsubscriptùëñ1superscriptùëÅùëÑùëÜsuperscriptsubscriptùê±ùëñùëÑùê∏superscriptsubscriptùê±ùëñùëÑwhereùëÜsuperscriptsubscriptùê±ùëñùëÑ1ùê∏superscriptsubscriptùê±ùëñùëÑsubscriptùê∏ùëö0\\\\mathcal{L}\\_{NA}=\\\\frac{1}{\\\\sum\\_{i}\\\\mathbb{I}\\_{\\\\{S(\\\\mathbf{x}\\_{i}^{Q})\\\\neq 0\\\\}}}\\\\sum\\_{i=1}^{N^{Q}}S(\\\\mathbf{x}\\_{i}^{Q})E(\\\\mathbf{x}\\_{i}^{Q}),\\ \\\\text{where}\\ S(\\\\mathbf{x}\\_{i}^{Q})=\\\\max\\\\left(1-\\\\frac{E(\\\\mathbf{x}\\_{i}^{Q})}{E\\_{m}},0\\\\right), |  | (11) |\n\nwhere Emsubscriptùê∏ùëöE\\_{m} is the self-adaptive threshold estimated in Eq. [8]In 3.2.2 Constraint Estimation ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), and ùïÄ{‚ãÖ}subscriptùïÄ‚ãÖ\\\\mathbb{I}\\_{\\\\{\\\\cdot\\\\}} is an indicator function evaluating to 111i.f.f. the condition is satisfied.\nIt is worth noting that existing TTA methods like EATA (Niu et al., [2022]) and SAR (Niu et al., [2023]) are highly sensitive to the manually determined thresholds, resulting in either none or all query predictions being treated as noise.\nIn contrast, the proposed ‚ÑíN‚ÄãAsubscript‚ÑíùëÅùê¥\\\\mathcal{L}\\_{NA} not only employs a self-adaptive threshold to filter out noise but also employs various confidence scores for query predictions to facilitate the optimization.",
      "citations": [
        {
          "start_pos": 9281,
          "end_pos": 9300,
          "text": "Long et al., [2017]",
          "paper_id": "bib.bib29",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 9302,
          "end_pos": 9321,
          "text": "Kang et al., [2019]",
          "paper_id": "bib.bib18",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 14933,
          "end_pos": 14954,
          "text": "Liang et al. ( [2022]",
          "paper_id": "bib.bib25",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 16613,
          "end_pos": 16631,
          "text": "Niu et al., [2022]",
          "paper_id": "bib.bib32",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 16642,
          "end_pos": 16660,
          "text": "Niu et al., [2023]",
          "paper_id": "bib.bib33",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        }
      ]
    },
    "4 Experiments": {
      "content": "In this section, we verify the effectiveness of TCR in handling the query shift problem for the image-text retrieval task.\nThis section is organized as follows.\nIn Section [4.1]Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we present the implementation details and experiment settings of TCR.\nIn Section [4.2]Comparisons with State-of-the-arts ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we conduct extensive comparison experiments to verify the performance superiority of TCR.\nIn Section [4.3]Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), we perform a series of analytic studies, ablation studies, and visualization analyses, to provide a comprehensive understanding of TCR.\n\nTable 1: Comparisons with state-of-the-art methods on COCO-C benchmark under query shift on the image modality with maximum severity level regarding the Recall@1 metric. The best results are marked in bold.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  | Noise | Blur | Weather | Digital |  |\n| Query Shift | Gauss. | Shot | Impul. | Speckle | Defoc. | Glass | Motion | Zoom | Snow | Frost | Fog | Brit. | Contr. | Elastic | Pixel | JPEG | Avg. |\n| BLIP ViT-B/16 | 43.4 | 46.3 | 43.2 | 57.3 | 43.3 | 68.0 | 39.7 | 8.4 | 32.3 | 52.2 | 57.0 | 66.8 | 36.0 | 41.3 | 20.6 | 63.7 | 45.0 |\n| ‚àô‚àô\\\\bullet~{}Tent | 41.6 | 40.5 | 37.9 | 54.0 | 44.7 | 65.1 | 39.6 | 8.3 | 31.9 | 48.7 | 56.3 | 66.5 | 31.8 | 40.3 | 19.2 | 62.3 | 43.0 |\n| ‚àô‚àô\\\\bullet~{}EATA | 41.4 | 50.3 | 35.7 | 63.1 | 49.8 | 72.2 | 46.2 | 6.9 | 45.6 | 56.7 | 62.5 | 71.4 | 43.6 | 51.3 | 25.6 | 67.0 | 49.3 |\n| ‚àô‚àô\\\\bullet~{}SAR | 42.3 | 51.5 | 37.5 | 61.8 | 40.3 | 71.5 | 32.8 | 6.2 | 38.0 | 56.2 | 59.1 | 70.6 | 31.1 | 53.5 | 17.5 | 66.4 | 46.0 |\n| ‚àô‚àô\\\\bullet~{}READ | 45.8 | 48.4 | 37.2 | 59.9 | 44.5 | 71.8 | 46.6 | 11.5 | 39.9 | 49.9 | 58.4 | 70.3 | 35.8 | 45.0 | 18.8 | 66.2 | 46.9 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 47.9 | 53.5 | 46.8 | 63.4 | 42.9 | 72.1 | 36.7 | 3.2 | 37.5 | 59.7 | 66.4 | 71.2 | 40.3 | 49.0 | 13.1 | 67.6 | 48.2 |\n| ‚àô‚àô\\\\bullet~{}Ours | 53.2 | 56.2 | 54.8 | 64.6 | 58.0 | 73.7 | 56.4 | 32.2 | 56.5 | 64.1 | 71.0 | 73.4 | 57.9 | 63.7 | 41.8 | 68.4 | 59.1 |\n| BLIP ViT-L/16 | 50.3 | 51.8 | 51.1 | 61.6 | 53.7 | 72.1 | 49.4 | 14.5 | 44.0 | 57.5 | 61.8 | 70.5 | 37.3 | 50.6 | 32.0 | 70.5 | 51.8 |\n| ‚àô‚àô\\\\bullet~{}Tent | 46.3 | 49.3 | 46.7 | 58.4 | 52.2 | 71.8 | 47.5 | 12.3 | 41.9 | 56.2 | 60.9 | 69.7 | 35.7 | 48.3 | 29.4 | 69.6 | 49.8 |\n| ‚àô‚àô\\\\bullet~{}EATA | 46.2 | 53.5 | 49.5 | 63.8 | 56.5 | 73.8 | 52.6 | 18.4 | 50.6 | 59.1 | 64.5 | 72.1 | 40.7 | 55.4 | 43.5 | 70.7 | 54.4 |\n| ‚àô‚àô\\\\bullet~{}SAR | 45.9 | 50.2 | 47.3 | 63.1 | 51.1 | 73.8 | 47.2 | 11.6 | 40.8 | 58.9 | 60.7 | 71.6 | 33.6 | 54.0 | 34.4 | 70.5 | 50.9 |\n| ‚àô‚àô\\\\bullet~{}READ | 38.1 | 48.0 | 43.3 | 63.5 | 43.6 | 73.4 | 43.6 | 22.0 | 44.5 | 56.5 | 62.2 | 71.9 | 32.9 | 49.6 | 27.5 | 70.6 | 49.5 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 39.9 | 50.2 | 43.5 | 63.8 | 50.4 | 74.0 | 52.4 | 5.4 | 49.5 | 59.3 | 62.8 | 71.8 | 34.0 | 54.7 | 34.4 | 69.7 | 51.0 |\n| ‚àô‚àô\\\\bullet~{}Ours | 58.2 | 60.7 | 59.8 | 66.6 | 61.5 | 74.9 | 60.3 | 36.8 | 59.0 | 65.2 | 72.1 | 73.5 | 56.3 | 65.7 | 50.2 | 71.6 | 62.0 |\n\nTable 2: Comparisons with state-of-the-art methods on COCO-C benchmark under query shift on the text modality with maximum severity level regarding the Recall@1 metric.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  | Character-level | Word-level | Sentence-level |  |\n| Query Shift | OCR | CI | CR | CS | CD | SR | RI | RS | RD | IP | Formal | Casual | Passive | Active | Backtrans | Avg. |\n| BLIP ViT-B/16 | 31.4 | 11.3 | 9.4 | 18.9 | 11.4 | 43.6 | 51.5 | 50.3 | 50.6 | 56.8 | 56.6 | 56.2 | 54.9 | 56.8 | 54.2 | 40.9 |\n| ‚àô‚àô\\\\bullet~{}Tent | 31.4 | 11.0 | 9.5 | 17.7 | 11.3 | 43.2 | 51.3 | 50.3 | 50.6 | 56.6 | 56.2 | 56.0 | 54.9 | 56.9 | 53.9 | 40.7 |\n| ‚àô‚àô\\\\bullet~{}EATA | 33.1 | 11.9 | 10.5 | 18.4 | 12.0 | 44.9 | 53.0 | 51.6 | 50.3 | 56.2 | 56.8 | 56.8 | 56.0 | 56.8 | 54.3 | 41.5 |\n| ‚àô‚àô\\\\bullet~{}SAR | 31.8 | 11.6 | 9.9 | 18.5 | 11.7 | 43.6 | 51.5 | 50.3 | 50.6 | 56.8 | 56.5 | 56.2 | 54.9 | 56.8 | 54.2 | 41.0 |\n| ‚àô‚àô\\\\bullet~{}READ | 32.3 | 11.4 | 9.6 | 18.2 | 11.2 | 44.3 | 52.9 | 51.7 | 51.1 | 57.6 | 57.1 | 56.7 | 55.9 | 57.1 | 54.7 | 41.4 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 31.4 | 11.3 | 9.4 | 17.9 | 11.4 | 43.6 | 51.5 | 50.3 | 50.6 | 56.8 | 56.5 | 56.2 | 54.9 | 56.7 | 54.2 | 40.9 |\n| ‚àô‚àô\\\\bullet~{}Ours | 34.1 | 13.7 | 11.8 | 19.5 | 13.2 | 45.3 | 53.8 | 51.8 | 51.5 | 57.3 | 57.1 | 56.8 | 56.0 | 57.3 | 54.7 | 42.3 |\n| BLIP ViT-L/16 | 34.5 | 12.3 | 11.1 | 19.7 | 12.9 | 46.0 | 54.4 | 54.0 | 53.5 | 59.4 | 59.1 | 58.8 | 57.8 | 59.4 | 56.7 | 43.3 |\n| ‚àô‚àô\\\\bullet~{}Tent | 34.0 | 12.3 | 11.0 | 19.6 | 12.9 | 46.5 | 54.2 | 53.8 | 53.4 | 59.4 | 59.1 | 58.8 | 57.6 | 58.9 | 56.5 | 43.2 |\n| ‚àô‚àô\\\\bullet~{}EATA | 35.6 | 13.3 | 11.3 | 20.3 | 13.2 | 47.2 | 55.4 | 54.2 | 53.8 | 59.2 | 59.1 | 59.4 | 57.9 | 59.4 | 56.8 | 43.7 |\n| ‚àô‚àô\\\\bullet~{}SAR | 34.5 | 13.1 | 11.2 | 20.3 | 13.1 | 46.7 | 54.4 | 54.0 | 53.5 | 59.5 | 59.1 | 58.8 | 57.8 | 59.4 | 56.7 | 43.5 |\n| ‚àô‚àô\\\\bullet~{}READ | 35.3 | 12.2 | 10.9 | 19.1 | 12.7 | 47.3 | 55.1 | 55.0 | 53.3 | 59.7 | 59.3 | 59.1 | 58.1 | 59.6 | 56.7 | 43.6 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 34.5 | 12.3 | 11.1 | 19.7 | 12.9 | 46.7 | 54.4 | 54.0 | 53.5 | 59.5 | 59.1 | 58.8 | 57.8 | 59.4 | 56.7 | 43.4 |\n| ‚àô‚àô\\\\bullet~{}Ours | 36.8 | 14.7 | 13.4 | 21.3 | 14.3 | 47.9 | 56.3 | 54.8 | 53.9 | 59.5 | 59.4 | 59.0 | 58.2 | 59.6 | 56.9 | 44.4 |\n\n### 4.1 Implementation Details and Experiment Settings\n\nTCR is a general TTA framework that could endow most existing pre-trained models with robustness against the query shift.\nTherefore, we select CLIP (Radford et al., [2021]) and BLIP (Li et al., [2022]) as the source models since they are the widely adopted vision-language models for image-text retrieval task.\nFollowing Lee et al. ( [2018]), we adopt two testing protocols, namely, image-to-text retrieval (a.k.a. TR) and text-to-image retrieval (a.k.a. IR).\nDuring the adaptation process, TCR performs the objective function for each coming mini-batch of queries, and the batch size is set as 646464.\nFollowing Niu et al. ( [2023]); Wang et al. ( [2021]), TCR updates the parameters within the normalization layers in the query-specific encoder fŒòsQsubscriptùëìsubscriptsuperscriptŒòùëÑùë†f\\_{\\\\Theta^{Q}\\_{s}}using the AdamW optimizer.\nTo be more specific, the learnable parameters in Œò~~Œò\\\\tilde{\\\\Theta} (Eq. [3]In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")) correspond to the Layer Normalization (LN) layers in our implementation.\nBesides, the temperature hyper-parameter œÑùúè\\\\tau in Eq. [1]In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and uniformity learning hyper-parameter tùë°t in Eq. [9]In 3.3 Intra-modality Uniformity Learning ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") are fixed as 0.020.020.02 and 101010 for all experiments, respectively.\n\nTo investigate the influence of cross-modal retrieval with query shift, we employ the following two settings for extensive evaluations (see more details in Appendix [B.1]B.1 More Details about the Benchmarks ‚Ä£ Appendix B More Implementation Details ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")).\n\n- ‚Ä¢\n\n\nQuery Shift (QS):\nIn this setting, only the queries come from different distributions with the source-domain data.\nFollowing Qiu et al. ( [2023]), we introduce 16 types of corruptions to the image modality and 15 types to the text modality across widely-used image-text retrieval datasets, COCO (Lin et al., [2014]) and Flickr (Plummer et al., [2015]).\nAs a result, the COCO-C and Flickr-C benchmarks are constructed, which would result in distribution shifts on either the image or text modalities.\nTo guarantee the controlled study on QS, we first fine-tune the pre-trained model on either the COCO (Lin et al., [2014]) or Flickr (Plummer et al., [2015]) dataset, namely, treating them as the source domains.\nAfter that, evaluations are conducted on the COCO-C or Flickr-C benchmarks, namely, treating them as the target domain.\n\n- ‚Ä¢\n\n\nQuery-Gallery Shift (QGS):\nIn this setting, both the query and gallery samples are drawn from distributions different from the source-domain data.\nTo this end, evaluations are directly conducted on the pre-trained model upon several widely-used image-text retrieval datasets from various domains, including Fashion-Gen (Rostamzadeh et al., [2018]) from the e-commerce domain, CUHK-PEDES (Li et al., [2017]) and ICFG-PEDES (Ding et al., [2021]) from the person re-identification (ReID) domain, and COCO, Flickr, and Nocaps (Agrawal et al., [2019]) from the natural image domain.\nIn other words, the source model would encounter distribution shifts on both image and text modalities during adaptation.\n\n\nTable 3: Comparisons with state-of-the-art methods on benchmarks under Query-Gallery shifts regarding the Recall@1 metric. In the table, ‚ÄúID‚Äù, ‚ÄúND‚Äù and ‚ÄúOD‚Äù refer to ‚ÄúIn-Domain‚Äù, ‚ÄúNear-Domain‚Äù and ‚ÄúOut-Domain‚Äù, respectively.\nBesides, ‚ÄúTR@1‚Äù / ‚ÄúIR@1‚Äù represent Recall@1 for image-to-text retrieval / text-to-image retrieval.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n|  | Base2Flickr | Base2COCO | Base2Fashion | Base2Nocaps(ID) | Base2Nocaps(ND) | Base2Nocaps(OD) |  |\n| Query Shift | TR@1 | IR@1 | TR@1 | IR@1 | TR@1 | IR@1 | TR@1 | IR@1 | TR@1 | IR@1 | TR@1 | IR@1 | Avg. |\n| CLIP ViT-B/16 | 80.2 | 61.5 | 52.5 | 33.0 | 8.5 | 13.2 | 84.9 | 61.4 | 75.4 | 49.2 | 73.8 | 55.8 | 54.1 |\n| ‚àô‚àô\\\\bullet~{}Tent | 81.4 | 64.0 | 48.8 | 27.6 | 5.6 | 10.7 | 85.1 | 61.7 | 74.6 | 48.6 | 71.8 | 56.1 | 53.0 |\n| ‚àô‚àô\\\\bullet~{}EATA | 80.4 | 63.4 | 52.1 | 34.8 | 8.1 | 12.0 | 84.7 | 62.0 | 75.1 | 52.3 | 74.1 | 56.9 | 54.7 |\n| ‚àô‚àô\\\\bullet~{}SAR | 80.3 | 62.2 | 51.8 | 33.9 | 8.0 | 13.3 | 84.7 | 61.3 | 75.4 | 51.3 | 73.7 | 56.1 | 54.3 |\n| ‚àô‚àô\\\\bullet~{}READ | 80.6 | 64.4 | 46.0 | 35.7 | 5.8 | 11.2 | 85.1 | 63.0 | 75.0 | 52.1 | 73.5 | 57.0 | 54.1 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 80.1 | 64.0 | 51.5 | 33.4 | 6.9 | 10.9 | 84.4 | 62.2 | 75.1 | 52.0 | 73.2 | 57.3 | 54.3 |\n| ‚àô‚àô\\\\bullet~{}Ours | 82.4 | 64.8 | 52.9 | 36.5 | 8.9 | 14.0 | 85.1 | 63.5 | 75.7 | 54.0 | 74.4 | 58.0 | 55.9 |\n| BLIP ViT-B/16 | 70.0 | 68.3 | 59.3 | 45.4 | 19.9 | 26.1 | 88.2 | 74.9 | 79.3 | 63.6 | 81.9 | 67.8 | 62.1 |\n| ‚àô‚àô\\\\bullet~{}Tent | 81.9 | 68.5 | 61.7 | 41.7 | 14.1 | 26.1 | 88.5 | 75.4 | 82.6 | 64.1 | 82.7 | 68.9 | 63.0 |\n| ‚àô‚àô\\\\bullet~{}EATA | 82.3 | 69.4 | 64.2 | 47.9 | 12.8 | 25.2 | 87.8 | 75.1 | 82.8 | 63.9 | 81.5 | 67.9 | 63.4 |\n| ‚àô‚àô\\\\bullet~{}SAR | 81.7 | 68.3 | 63.5 | 46.6 | 17.9 | 26.1 | 88.2 | 75.6 | 81.0 | 65.4 | 81.2 | 69.3 | 63.7 |\n| ‚àô‚àô\\\\bullet~{}READ | 80.0 | 69.9 | 62.1 | 46.4 | 5.6 | 24.1 | 87.3 | 75.1 | 80.6 | 63.9 | 80.7 | 67.9 | 62.0 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 83.5 | 69.9 | 65.0 | 47.3 | 12.2 | 24.1 | 89.2 | 75.6 | 83.7 | 65.7 | 84.3 | 69.4 | 64.2 |\n| ‚àô‚àô\\\\bullet~{}Ours | 86.8 | 70.3 | 68.9 | 48.9 | 23.6 | 30.3 | 89.7 | 76.0 | 86.3 | 66.1 | 87.2 | 69.5 | 67.0 |\n\n### 4.2 Comparisons with State-of-the-arts\n\nIn this section, We compare TCR with five SOTA TTA methods (Tent (Wang et al., [2021]), EATA (Niu et al., [2022]), SAR (Niu et al., [2023]), READ (Yang et al., [2024]), and DeYO (Lee et al., [2024])) under both the QS and QGS settings.\nAmong the baseline methods, Tent is the vanilla TTA approach with an entropy-based objective, while the others enhance Tent by incorporating specially designed noise-robust loss functions.\nFor a fair comparison, we select the optimal temperature (Eq.1) for the TTA baselines upon each dataset according to Fig. [4]Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a).\nThe results on the QS setting and QGS setting are summarized in Tables [1]Table 1 ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), [2]Table 2 ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), [7]Table 7 ‚Ä£ Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), [8]Table 8 ‚Ä£ Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Tables [3]Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), [4]Table 4 ‚Ä£ 4.2 Comparisons with State-of-the-arts ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), respectively.\nFrom the results, one could have the following observations and conclusions.\n\n- ‚Ä¢\n\n\nExisting TTA methods only achieve marginal performance improvements over the base model, which could be attributed to the inability on manipulating both modality uniformity and the modality gap.\nIn contrast, TCR could rectify the modality gap and enlarge the modality uniformity, thus significantly outperforming all the baselines across various pre-trained model types and sizes.\n\n- ‚Ä¢\n\n\nTCR demonstrates greater robustness against more severe shift types like ‚ÄúZoom‚Äù and ‚ÄúPixel‚Äù (see Table [1]Table 1 ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Table [7]Table 7 ‚Ä£ Appendix C An Alternative Implementation of TCR without training ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")), whereas most baseline methods experience significant performance degradation under these challenging distribution shifts.\nMoreover, in Table [3]Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), the more significant performance improvements on ‚ÄúBase2Nocaps‚Äù with ‚ÄúND‚Äù and ‚ÄúOD‚Äù compared to that with ‚ÄúID‚Äù also verify the conclusion.\n\n- ‚Ä¢\n\n\nAs the size of the gallery set increases in Table [3]Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") (from ‚ÄúBase2Flickr‚Äù to ‚ÄúBase2COCO‚Äù to ‚ÄúBase2Fashion‚Äù), existing TTA methods suffer from increasing performance degradation, eventually performing even worse than the base model. This supports our claim in Section [3.1]Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") that TTA methods struggle to accommodate well for cross-modal retrieval tasks due to the excessively large gallery set.\nIn contrast, our method consistently achieves performance improvements across various gallery sizes.\n\n\nTable 4:\nComparisons with state-of-the-art methods on ReID benchmarks under Query-Gallery shifts regarding the Recall@1 metric.\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | CUHK2ICFG | ICFG2CUHK |  |\n| Query Shift | IR@1 | IR@1 | Avg. |\n| CLIP ViT-B/16 | 33.3 | 41.0 | 37.2 |\n| ‚àô‚àô\\\\bullet~{}Tent | 33.5 | 41.9 | 37.7 |\n| ‚àô‚àô\\\\bullet~{}EATA | 33.3 | 42.2 | 37.8 |\n| ‚àô‚àô\\\\bullet~{}SAR | 33.3 | 42.2 | 37.8 |\n| ‚àô‚àô\\\\bullet~{}READ | 33.0 | 42.3 | 37.7 |\n| ‚àô‚àô\\\\bullet~{}DeYO | 33.3 | 42.2 | 37.8 |\n| ‚àô‚àô\\\\bullet~{}Ours | 37.3 | 42.4 | 39.9 |\n\n### 4.3 Ablation and Analytic Study\n\nIn this section, all the experiments are conducted under the ‚ÄúBase2COCO‚Äù setting using the BLIP ViT-B/16 model unless otherwise stated.\n\nAnalytic Studies on Intra-modality Uniformity and Inter-modality Gap.\nAs pointed out in Introduction, the query shift would diminish the intra-modality uniformity and amplify the inter-modality gap.\nFor an in-depth understanding, we conduct analytic experiments to investigate how the two characteristics affect the retrieval performance.\nTo examine the influence of the intra-modality uniformity, we manually scale the latent distance between different queries.\nMathematically, the scaling operation is defined as follows.\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | (ùê≥iQ)scale =ùêô¬ØQ+Œªscale‚Äã(ùê≥iQ‚àíùêô¬ØQ),superscriptsuperscriptsubscriptùê≥ùëñùëÑscale superscript¬ØùêôùëÑsuperscriptùúÜscalesuperscriptsubscriptùê≥ùëñùëÑsuperscript¬ØùêôùëÑ(\\\\mathbf{z}\\_{i}^{Q})^{\\\\text{scale }}=\\\\overline{\\\\mathbf{Z}}^{Q}+\\\\lambda^{\\\\text{scale}}\\\\left(\\\\mathbf{z}\\_{i}^{Q}-\\\\overline{\\\\mathbf{Z}}^{Q}\\\\right), |  | (12) |\n\n![Refer to caption]Figure 3: Observation of the intra-modality uniformity and inter-modality gap.\nThe increasing ŒªscalesuperscriptùúÜscale\\\\lambda^{\\\\operatorname{scale}} indicates the growing intra-modality uniformity while the decreasing ŒªoffsetsuperscriptùúÜoffset\\\\lambda^{\\\\operatorname{offset}} indicates the narrowing inter-modality gap.\nNotably, Œªscale=1.0superscriptùúÜscale1.0\\\\lambda^{\\\\operatorname{scale}}=1.0 and Œªoffset=0superscriptùúÜoffset0\\\\lambda^{\\\\operatorname{offset}}=0 represent no scaling and no offset, respectively.\n\nwhere ùêô¬ØQ=1NQ‚Äã‚àëi=1NQùê≥iQsuperscript¬ØùêôùëÑ1superscriptùëÅùëÑsuperscriptsubscriptùëñ1superscriptùëÅùëÑsuperscriptsubscriptùê≥ùëñùëÑ\\\\overline{\\\\mathbf{Z}}^{Q}=\\\\frac{1}{N^{Q}}\\\\sum\\_{i=1}^{N^{Q}}\\\\mathbf{z}\\_{i}^{Q} is the center of queries, ŒªscalesuperscriptùúÜscale\\\\lambda^{\\\\text{scale}} is the scaling factor.\nAs illustrated in Fig. [3]Figure 3 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a),\nincreasing the intra-modality uniformity in the query modality would improve the performance, but not vice versa.\nSuch a phenomenon indicates that higher uniformity would guarantee the discrimination between queries and thus boost performance.\nTo examine the influence of the inter-modality gap, following Liang et al. ( [2022]), we manually move every query embedding towards closing the modality gap. Formally,\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | (ùê≥iQ)offset=ùê≥iQ‚àíŒªoffset‚Äã(ùêô¬ØQ‚àíùêô¬ØG),superscriptsuperscriptsubscriptùê≥ùëñùëÑoffsetsuperscriptsubscriptùê≥ùëñùëÑsuperscriptùúÜoffsetsuperscript¬ØùêôùëÑsuperscript¬Øùêôùê∫(\\\\mathbf{z}\\_{i}^{Q})^{\\\\text{offset}}=\\\\mathbf{z}\\_{i}^{Q}-\\\\lambda^{\\\\text{offset}}\\\\left(\\\\overline{\\\\mathbf{Z}}^{Q}-\\\\overline{\\\\mathbf{Z}}^{G}\\\\right), |  | (13) |\n\nwhere ùêô¬ØG=1NG‚Äã‚àëi=1NGùê≥iGsuperscript¬Øùêôùê∫1superscriptùëÅùê∫superscriptsubscriptùëñ1superscriptùëÅùê∫superscriptsubscriptùê≥ùëñùê∫\\\\overline{\\\\mathbf{Z}}^{G}=\\\\frac{1}{N^{G}}\\\\sum\\_{i=1}^{N^{G}}\\\\mathbf{z}\\_{i}^{G} is the center of the gallery samples, ŒªoffsetsuperscriptùúÜoffset\\\\lambda^{\\\\text{offset}} controls the offset of the embeddings.\nFrom the results in Fig. [3]Figure 3 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(b), one could observe that monotonously eliminating the modality gap would not always improve the performance.\nIn contrast, the estimated modality gap from the pre-trained model is a plausible criterion for modality gap rectification.\nNote that the embeddings are all ‚Ñì‚Äã2‚Ñì2\\\\ell 2-normalized after scaling or shifting.\n\nTable 5: Ablation study of the loss functions, where ‚Äù ‚úì‚úì\\\\checkmark ‚Äù denotes the loss is adopted.\n\n|     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- |\n| ‚ÑíN‚ÄãAsubscript‚ÑíùëÅùê¥\\\\mathcal{L}\\_{NA} | ‚ÑíM‚ÄãUsubscript‚ÑíùëÄùëà\\\\mathcal{L}\\_{MU} | ‚ÑíE‚ÄãM‚ÄãGsubscript‚Ñíùê∏ùëÄùê∫\\\\mathcal{L}\\_{EMG} | TR@1 | IR@1 | Avg. |\n|  |  |  | 59.3 | 45.4 | 52.4 |\n| ‚úì‚úì\\\\checkmark |  |  | 67.4 | 47.8 | 57.9 |\n|  | ‚úì‚úì\\\\checkmark |  | 64.9 | 46.7 | 55.8 |\n|  |  | ‚úì‚úì\\\\checkmark | 64.3 | 46.3 | 55.3 |\n| ‚úì‚úì\\\\checkmark | ‚úì‚úì\\\\checkmark |  | 67.8 | 48.3 | 58.2 |\n| ‚úì‚úì\\\\checkmark |  | ‚úì‚úì\\\\checkmark | 68.1 | 48.4 | 58.4 |\n|  | ‚úì‚úì\\\\checkmark | ‚úì‚úì\\\\checkmark | 66.3 | 47.8 | 57.1 |\n| ‚úì‚úì\\\\checkmark | ‚úì‚úì\\\\checkmark | ‚úì‚úì\\\\checkmark | 68.9 | 48.9 | 58.9 |\n\nAblation studies.\nTo verify the effectiveness of each design, we investigate the loss terms of TCR in Table [5]Table 5 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"), resulting in the following conclusions.\nFirst, ‚ÑíN‚ÄãAsubscript‚ÑíùëÅùê¥\\\\mathcal{L}\\_{NA} boosts performance through the query prediction refinement module and self-adaptive loss, e.g., TCR improves R@1 by 9.2% and 14.6% on text and image retrieval, compared to Tent in Table [3]Table 3 ‚Ä£ 4.1 Implementation Details and Experiment Settings ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nSecond, both the designed intra-modality uniformity learning module and inter-modality gap learning module would enhance robustness against query shift.\nThird, TCR achieves optimal performance when all the loss terms are employed.\nMoreover, we carry out experiments to verify the effectiveness of the proposed query prediction refinement module in Section [3.5]Noise-robust Adaptation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\").\nAs shown in Fig. [4]Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(a), we observe that: i) selecting an appropriate temperature for the existing TTA approach across various datasets is challenging; ii) even a low temperature (e.g., 1‚Äãe‚àí41ùëí41e-4) is a better setting across all datasets, the performance degrades as a low temperature tends to make model overfitting on noisy query prediction.\nIn contrast, the query prediction refinement module not only stabilizes the temperature setting for all the datasets but also prevents the model from either underfitting or overfitting by excluding some irrelevant samples in the gallery.\n\nVisualization Result.\nTo qualitatively study the effectiveness of TCR, we conduct the t-SNE visualization on both the query and gallery embeddings before and after the TTA process.\nFrom the results in Fig. [4]Figure 4 ‚Ä£ 4.3 Ablation and Analytic Study ‚Ä£ 4 Experiments ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")(c), one could observe that the samples in the query modality enjoy more scatter and the difference between the query and gallery modalities narrows after the TTA process.\nIn other words, TCR achieves better robustness against query shift by rectifying the intra-modality uniformity and the inter-modality gap.\n\n![Refer to caption]Figure 4: Finer-grained Ablation studies. (a) The parameter analysis of œÑùúè\\\\tau (Eq. [1]In 3.1 Notations and Problem Formulation ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\") and Eq. [5]In 3.2.1 Candidate Selection ‚Ä£ 3.2 Query Prediction Refinement ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\")) on the vanilla TTA method Tent w/ (solid line) and w/o (dotted line) the query prediction refinement module. (b) The parameter analysis of tùë°t in Eq. [9]In 3.3 Intra-modality Uniformity Learning ‚Ä£ 3 Method ‚Ä£ Test-time Adaptation for Cross-modal Retrieval with Query Shift\"). (c) The t-SNE visualization of TR on the query and gallery embeddings after employing the proposed TCR.",
      "citations": [
        {
          "start_pos": 6079,
          "end_pos": 6101,
          "text": "Radford et al., [2021]",
          "paper_id": "bib.bib40",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 6113,
          "end_pos": 6130,
          "text": "Li et al., [2022]",
          "paper_id": "bib.bib22",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 6251,
          "end_pos": 6270,
          "text": "Lee et al. ( [2018]",
          "paper_id": "bib.bib21",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 6543,
          "end_pos": 6562,
          "text": "Niu et al. ( [2023]",
          "paper_id": "bib.bib33",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 6565,
          "end_pos": 6585,
          "text": "Wang et al. ( [2021]",
          "paper_id": "bib.bib43",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 7912,
          "end_pos": 7931,
          "text": "Qiu et al. ( [2023]",
          "paper_id": "bib.bib39",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 8083,
          "end_pos": 8101,
          "text": "Lin et al., [2014]",
          "paper_id": "bib.bib26",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 8115,
          "end_pos": 8137,
          "text": "Plummer et al., [2015]",
          "paper_id": "bib.bib37",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 8389,
          "end_pos": 8407,
          "text": "Lin et al., [2014]",
          "paper_id": "bib.bib26",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 8420,
          "end_pos": 8442,
          "text": "Plummer et al., [2015]",
          "paper_id": "bib.bib37",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 8945,
          "end_pos": 8971,
          "text": "Rostamzadeh et al., [2018]",
          "paper_id": "bib.bib41",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 9013,
          "end_pos": 9030,
          "text": "Li et al., [2017]",
          "paper_id": "bib.bib24",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 9048,
          "end_pos": 9067,
          "text": "Ding et al., [2021]",
          "paper_id": "bib.bib8",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 9148,
          "end_pos": 9170,
          "text": "Agrawal et al., [2019]",
          "paper_id": "bib.bib1",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": [
            "bib.bib2"
          ]
        },
        {
          "start_pos": 11709,
          "end_pos": 11728,
          "text": "Wang et al., [2021]",
          "paper_id": "bib.bib43",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 11737,
          "end_pos": 11755,
          "text": "Niu et al., [2022]",
          "paper_id": "bib.bib32",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 11763,
          "end_pos": 11781,
          "text": "Niu et al., [2023]",
          "paper_id": "bib.bib33",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 11790,
          "end_pos": 11809,
          "text": "Yang et al., [2024]",
          "paper_id": "bib.bib48",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 11822,
          "end_pos": 11840,
          "text": "Lee et al., [2024]",
          "paper_id": "bib.bib20",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        },
        {
          "start_pos": 18109,
          "end_pos": 18130,
          "text": "Liang et al. ( [2022]",
          "paper_id": "bib.bib25",
          "single_citation": null,
          "citation_type": null,
          "nearest_citations": null
        }
      ]
    },
    "5 Conclusion": {
      "content": "In this paper, we develop a new test-time adaptation method, dubbed TCR, to achieve robust cross-modal retrieval against the query shift problem.\nIn brief, TCR first employs a novel module to refine the query predictions.\nAfter that, TCR adopts a novel joint objective to prevent the model adaptation from overfitting noise while simultaneously manipulating the intra-modality uniformity and inter-modality gap to preserve the well-established common space from the source model.\nExtensive experiments not only verify the effectiveness of TCR but also reveal the importance of each designs.\nIn the future, we plan to explore more potential scenarios contaminated with query shift and extend TCR to address the corresponding issues.",
      "citations": []
    }
  },
  "references": {
    "data": {
      "bib.bib1": {
        "id": "bib.bib1",
        "citation": "Agrawal et al. (2019)",
        "authors": "",
        "year": "",
        "title": "Nocaps: Novel object captioning at scale.",
        "venue": "CVPR",
        "pages": "",
        "url": "",
        "arxiv_id": "1812.08658",
        "doi": null,
        "sections": {},
        "abstract": "Image captioning models have achieved impressive results on datasets\ncontaining limited visual concepts and large amounts of paired image-caption\ntraining data. However, if these models are to ever function in the wild, a\nmuch larger variety of visual concepts must be learned, ideally from less\nsupervision. To encourage the development of image captioning models that can\nlearn visual concepts from alternative data sources, such as object detection\ndatasets, we present the first large-scale benchmark for this task. Dubbed\n'nocaps', for novel object captioning at scale, our benchmark consists of\n166,100 human-generated captions describing 15,100 images from the OpenImages\nvalidation and test sets. The associated training data consists of COCO\nimage-caption pairs, plus OpenImages image-level labels and object bounding\nboxes. Since OpenImages contains many more classes than COCO, nearly 400 object\nclasses seen in test images have no or very few associated training captions\n(hence, nocaps). We extend existing novel object captioning models to establish\nstrong baselines for this benchmark and provide analysis to guide future work\non this task."
      },
      "bib.bib2": {
        "id": "bib.bib2",
        "citation": "Cao et al. (2023)",
        "authors": "",
        "year": "",
        "title": "Multi-modal continual test-time adaptation for 3d semantic segmentation.",
        "venue": "CVPR",
        "pages": "",
        "url": "",
        "arxiv_id": "2303.10457",
        "doi": null,
        "sections": {
          "1 Introduction": {
            "content": "Test-Time Adaptation (TTA) proposes a realistic domain adaptation scenario, which adapts pre-trained models to the target domain during the testing process. Unlike previous Unsupervised Domain Adaptation (UDA) \\[ [17]), [49]), [57]), [51])\\], TTA performs adaptation online without accessing the data from the source domain. Typical TTA \\[ [44]), [39]), [40])\\] methods assume a stationary target domain, while real-world scenarios are dynamic over time. To fulfill this gap, a previous work \\[ [46])\\] proposes a general extension of TTA named Continual Test-Time Adaptation (CTTA) which assumes that the target domain is continually changing rather than static. Compared to TTA, CTTA is more challenging since the performance is easily affected by error accumulation \\[ [6])\\] and catastrophic forgetting \\[ [29])\\] during the continual adaptation.\n\n![Refer to caption]Figure 1: Illustration of how continual domain shifts affect multi-modal segmentation and our method. Unlike the source domain where predictions from both modalities are reliable, the reliability of each modality varies in MM-CTTA due to different domain shifts. CoMAC tackles MM-CTTA by attending to the reliable modality (‚úì) rather than the noisy one (‚úó). Meanwhile, source knowledge is stochastically revisited to avoid catastrophic forgetting. Figure best viewed in color and zoomed in.\n\nFor 3D semantic segmentation, multi-modal sensors are frequently leveraged in different tasks, such as scene understanding \\[ [4]), [30])\\] and semantic map construction \\[ [31]), [47])\\]. For some specific applications like semantic-based localization \\[ [8])\\] and autonomous driving \\[ [50]), [48])\\], multi-modal information is the key to robust performance under adverse conditions. However, their collaboration has been proven to be sensitive toward domain drifts \\[ [1]), [39])\\]. In real-world scenarios, such collaboration deterioration could be more severe considering that the target domain is continually changing as in CTTA (e.g., the operating environments of 24/7 AGVs are continually changing due to altering weather or illumination conditions). Hence, it is essential for multi-modal networks to adapt to the dynamic target domain in an online manner. In this work, we aim to study Multi-Modal Continual Test-Time Adaptation (MM-CTTA) for 3D semantic segmentation, where networks are continually adapted to a changing target domain taking 3D point clouds and 2D images as input without accessing the source data.\n\nIntuitively, one can address MM-CTTA by utilizing CTTA \\[ [32]), [46])\\] or TTA \\[ [3]), [42])\\] methods on 2D and 3D networks separately. However, this simple extension can not achieve satisfactory performance since it cannot correctly attend to the reliable modality for adaptation when others suffer from severe domain shifts. Take Fig. [1]Figure 1 ‚Ä£ 1 Introduction ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\") as an example: predictions from the 2D image are more accurate at the beginning of the target domain, while 2D results become unreliable and 3D predictions prevail as the illumination level significantly changes over time. Although previous CTTA or TTA methods have attempted to mitigate this intra-modal prediction noise by augmentations \\[ [46])\\] or entropy minimization \\[ [44]), [32])\\], the domain drift in Fig. [1]Figure 1 ‚Ä£ 1 Introduction ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\") is too severe to be effectively rectified by image input itself, leading to inevitable error accumulation. Previous works have proposed different cross-modal fusion methods to mitigate the effect of the noisy modality during adaptation, such as cross-modal consistency \\[ [19])\\] for UDA or pseudo-label fusion based on student-teacher consistency \\[ [39])\\] for TTA. However, their methods rely on the premise that the target domain is static, and therefore suffer from catastrophic forgetting in MM-CTTA, leading to degenerated results.\n\nFor MM-CTTA, an ideal solution is to suppress the contribution from the noisy modality and attend more to the reliable one in an online manner. Typically, the reliability of prediction can be estimated based on its corresponding feature location in the latent space. A prediction with features close to the centroid is more likely to be reliable, suffering less from the domain shift and vice versa. On the other hand, to ensure the validity of centroid-based reliability estimation, class-wise centroids should actively adapt to the continually changing target domain while stochastically revisiting the source knowledge to avoid catastrophic forgetting. To this end, we propose an MM-CTTA method called Continual Cross-Modal Adaptive Clustering (CoMAC) for 3D semantic segmentation. CoMAC consists of three main modules: (i) Intra-Modal Prediction Aggregation (iMPA), (ii) Inter-Modal Pseudo-Label Fusion (xMPF), and (iii) Class-Wise Momentum Queues (CMQs). On one hand, the proposed iMPA and xMPF are utilized to suppress prediction noise based on the centroid-based reliability estimation from intra-modal and inter-modal perspectives, respectively. On the other hand, CMQs are designed to actively adapt class-wise centroids for iMPA and xMPF while avoiding catastrophic forgetting. Additionally, a class-wise contrastive loss is introduced to regularize the extracted features from drifting too far from centroids.\n\nIn summary, our main contributions are three-fold. (i) We explore a new task MM-CTTA where multi-modal input is utilized to perform continual test-time adaptation for 3D semantic segmentation and propose an effective method named CoMAC to leverage multi-modal information for MM-CTTA. (ii) We propose iMPA and xMPF to generate accurate cross-modal pseudo-labels by attending to a reliable modality. CMQs are introduced to actively adapt to the target domain without catastrophic forgetting. (iii) We introduce two 3D semantic segmentation benchmarks to facilitate the future exploration of MM-CTTA. Extensive experiments show that our method achieves state-of-the-art performance, outperforming previous methods significantly by 6.9%percent6.96.9\\\\% on the challenging benchmark.",
            "citations": null
          },
          "2 Related Works": {
            "content": "Test-Time Adaptation\nDescribing a more realistic adaptation scenario, Test-Time Adaptation (TTA) is receiving more and more attention. Different from previous Unsupervised Domain Adaptation (UDA), TTA forbids access to raw source data and adapts the source pre-trained model during test time. As one of the primary works, TENT \\[ [44])\\] highlights the fully test-time setting and proposes to update the batch normalization layers by entropy minimization. The following works mainly address TTA by aligning batch normalization statistics \\[ [32]), [25]), [56])\\], self-training with pseudo labeling \\[ [13]), [45])\\], feature alignment \\[ [27])\\], or augmentation invariance \\[ [55]), [23])\\]. The aforementioned TTA methods strictly follow the one-pass protocol as mentioned in \\[ [40])\\], where networks immediately infer each sample in an online manner and forbid multiple training epochs. On the other hand, some previous works \\[ [24]), [10]), [7]), [52])\\] follow the multi-pass protocol by adapting the model for multiple epochs in an offline manner. As one of the primary works, Source Hypothesis Transfer (SHOT) \\[ [24])\\] proposes to update only the encoder parameters and align source and target representation by entropy minimization and pseudo-labeling. While most existing TTA methods are proposed for image classification, some recent works \\[ [10]), [22]), [28])\\] aim to explore TTA for image semantic segmentation. Specifically, \\[ [10])\\] proposes to minimize the prediction entropy while maximizing its robustness toward feature noise. \\[ [22])\\] divides the TTA problem into source domain generalization and target domain adaptation. \\[ [28])\\] proposes a dual attention distillation method to transfer contextual knowledge and patch-level pseudo labels for self-supervised learning.\n\nContinual Test-Time Adaptation\nThe definition of Continual Test-Time Adaptation (CTTA) is first proposed in CoTTA\\[ [46])\\], which aims to adapt the model to continually changing target domains in an online manner without any source data. Specifically, CoTTA proposes to use the moving teacher model and augmentation-average predictions for noise suppression and the model stochastic restoration to avoid catastrophic forgetting. Following the scheme of CoTTA, some recent works \\[ [11]), [12]), [32])\\] have addressed CTTA from different perspectives. Specifically, \\[ [12])\\] leverages the temporal correlations of streamed input by reservoir sampling and instance-aware batch normalization. \\[ [11])\\] proposes domain-specific prompts and domain-agnostic prompts to preserve domain-specific and domain-shared knowledge, respectively. EATA \\[ [32])\\] performs adaptation on non-redundant samples for an efficient update.\n\nMulti-Modal Adaptation for Segmentation\nThanks to the emerging multi-modal datasets \\[ [2]), [5]), [41]), [36]), [53])\\], recent works start to explore how to leverage multi-modal information between 2D images and 3D point clouds to perform domain adaptation under different settings. xMUDA \\[ [19])\\] proposes the first Multi-Modal Unsupervised Domain Adaptation (MM-UDA) method for 3D semantic segmentation. Specifically, it leverages the cross-modal prediction consistency by minimizing the prediction discrepancy from additional classifiers. Following the scheme of cross-modal learning, DsCML \\[ [34])\\] designs a deformable mapping between pixel-point correlation for MM-UDA while \\[ [26])\\] introduces adversarial training to mitigate domain discrepancy. In addition to UDA settings, \\[ [39])\\] proposes the first multi-modal test-time adaptation for semantic segmentation which generates intra-modal and inter-modal pseudo labels by attending to the one with more consistent predictions across student and teacher models.\n\nIn this work, we propose MM-CTTA as a new extension of CTTA with a specific method CoMAC. While our proposed dual-stage modules (i.e., iMPA and xMPA) and CMQs share some similar merit with previous TTA methods \\[ [39]), [40])\\], our method is explicitly designed for MM-CTTA. Unlike previous work \\[ [39])\\] measuring prediction reliability by teacher-student consistency, our reliability measurement relies on the feature-centroid distance to encourage feature clustering around the adapting centroids. Different from \\[ [40])\\] utilizing queues to measure target distribution, the objective of our CMQs is to actively update class-wise centroids to ensure the validity of iMPA and xMPA while avoiding catastrophic forgetting.\n\n![Refer to caption]Figure 2: The main structure of our proposed method. From the source domain, we preserve the source centroids and the pre-trained model for each modality as the initialization of the class-wise centroids and all the models in the target domain, respectively. To generate reliable intra-modal predictions, Intra-Modal Prediction Aggregation (iMPA) attends to the reliable prediction whose feature shares a closer distance with the class-wise centroids in an intra-modal manner. Inter-Modal Pseudo-Label Fusion (xMPF) then fuses the intra-modal predictions by estimating the reliability of predictions from each modality for noise suppression. Class-Wise Momentum Queues (CMQs) are designed to achieve a good balance between target domain adaptation and source knowledge preservation.",
            "citations": null
          },
          "3 Proposed Method": {
            "content": "Problem definition and notations. At timestamp tùë°t, the 2D image xùíØ,t2D‚àà‚ÑùH√óW√ó3superscriptsubscriptùë•ùíØùë°2Dsuperscript‚Ñùùêªùëä3x\\_{\\\\mathcal{T},t}^{\\\\textrm{2D}}\\\\in\\\\mathbb{R}^{H\\\\times W\\\\times 3} and the 3D point cloud xùíØ,t3D‚àà‚ÑùN√ó4superscriptsubscriptùë•ùíØùë°3Dsuperscript‚ÑùùëÅ4x\\_{\\\\mathcal{T},t}^{\\\\textrm{3D}}\\\\in\\\\mathbb{R}^{N\\\\times 4} are observed in the target domain ùíØùíØ\\\\mathcal{T}, where NùëÅN denotes the number of 3D points located in the camera FOV. Modal-specific pre-trained networks œïŒ∏,tm‚Äã(‚ãÖ)=ftm‚Äã(gtm‚Äã(‚ãÖ)),m‚àà{2D,3D}formulae-sequencesuperscriptsubscriptitalic-œïùúÉùë°ùëö‚ãÖsubscriptsuperscriptùëìùëöùë°subscriptsuperscriptùëîùëöùë°‚ãÖùëö2D3D\\\\phi\\_{\\\\theta,t}^{m}(\\\\cdot)=f^{m}\\_{t}(g^{m}\\_{t}(\\\\cdot)),m\\\\in\\\\{\\\\textrm{2D},\\\\textrm{3D}\\\\} consisting of the feature extractor ftmsubscriptsuperscriptùëìùëöùë°f^{m}\\_{t} and the classifier gtmsubscriptsuperscriptùëîùëöùë°g^{m}\\_{t} are used to predict the semantic labels for each point. Inspired by the fact that moving average models can provide more stable predictions \\[ [43])\\], we utilize a fast student network œïŒ∏m‚Äã(‚ãÖ)=fŒ∏m‚Äã(gŒ∏m‚Äã(‚ãÖ))superscriptsubscriptitalic-œïùúÉùëö‚ãÖsubscriptsuperscriptùëìùëöùúÉsubscriptsuperscriptùëîùëöùúÉ‚ãÖ\\\\phi\\_{\\\\theta}^{m}(\\\\cdot)=f^{m}\\_{\\\\theta}(g^{m}\\_{\\\\theta}(\\\\cdot)) and a slow teacher network œïŒ∏‚Ä≤m‚Äã(‚ãÖ)=fŒ∏‚Ä≤m‚Äã(gŒ∏‚Ä≤m‚Äã(‚ãÖ))superscriptsubscriptitalic-œïsuperscriptùúÉ‚Ä≤ùëö‚ãÖsubscriptsuperscriptùëìùëösuperscriptùúÉ‚Ä≤subscriptsuperscriptùëîùëösuperscriptùúÉ‚Ä≤‚ãÖ\\\\phi\\_{\\\\theta^{\\\\prime}}^{m}(\\\\cdot)=f^{m}\\_{\\\\theta^{\\\\prime}}(g^{m}\\_{\\\\theta^{\\\\prime}}(\\\\cdot)) for each modality similar to previous works \\[ [39]), [46])\\]. Given xùíØ,tmsuperscriptsubscriptùë•ùíØùë°ùëöx\\_{\\\\mathcal{T},t}^{m} as input, the features extracted by ftmsubscriptsuperscriptùëìùëöùë°f^{m}\\_{t} is denoted as zùíØ,tm‚àà‚ÑõN√óFmsubscriptsuperscriptùëßùëöùíØùë°superscript‚ÑõùëÅsuperscriptùêπùëöz^{m}\\_{\\\\mathcal{T},t}\\\\in\\\\mathcal{R}^{N\\\\times F^{m}}, where FmsuperscriptùêπùëöF^{m} denotes the channel number. Here we adopt the same projection protocol of previous works \\[ [19]), [39])\\] for cross-modal alignment, which projects features from the 2D branch back to 3D points, resulting in the 2D feature zùíØ,t2Dsubscriptsuperscriptùëß2DùíØùë°z^{\\\\textrm{2D}}\\_{\\\\mathcal{T},t} of shape N√óF2DùëÅsuperscriptùêπ2DN\\\\times F^{\\\\textrm{2D}}. By default, the subscript of the target domain ùíØùíØ\\\\mathcal{T} and the timestamp tùë°t are omitted for clarity. Given the multi-modal input xùíØ,t2Dsuperscriptsubscriptùë•ùíØùë°2Dx\\_{\\\\mathcal{T},t}^{\\\\textrm{2D}}, xùíØ,t3Dsuperscriptsubscriptùë•ùíØùë°3Dx\\_{\\\\mathcal{T},t}^{\\\\textrm{3D}}, the goal of MM-CTTA is to output reliable cross-modal predictions by continuously adapting to the changing target domain. In this work, we interpret the core of MM-CTTA as two-fold: (i) attending to the reliable modality for noisy suppression, and (ii) revisiting source knowledge to prevent catastrophic forgetting.\n\nTo this end, we propose Continual Cross-Modal Adaptive Clustering (CoMAC) to tackle MM-CTTA from the aforementioned perspectives. Specifically, as shown in Fig. [2]Figure 2 ‚Ä£ 2 Related Works ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"), the class-wise centroids are initialized from the source domain and pseudo-source features are randomly sampled around the centroids as source knowledge (Sec. [3.1]Source Models and Class-Wise Centroids ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")). Given the raw and augmentation-average predictions from the teacher models as input, Intra-Modal Prediction Aggregation (iMPA) generates stable intra-modal predictions as their weighted sum based on their feature distance to the class-wise centroids (Sec. [3.2]Intra-Modal Prediction Aggregation ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")). Inter-Modal Pseudo-Label Fusion (xMPF) then combines the intra-modal predictions from each modality based on their reliability and output cross-modal pseudo-labels as supervision signals for student networks (Sec. [3.3]Inter-Modal Pseudo-Label Fusion ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")). Given raw samples as input, confident target features from student networks are utilized to update Class-Wise Momentum Queues (CMQs), while pseudo-source features are stochastically restored to avoid catastrophic forgetting (Sec. [3.4]Class-Wise Moving Queues ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")).\n\n### 3.1 Source Models and Class-Wise Centroids\n\nTo effectively avoid catastrophic forgetting and inspired by previous TTA methods \\[ [9]), [40])\\] which preserve trivial source domain information, we utilize pseudo-source features sampled around source offline feature centroids as source representatives. The source offline centroids and pseudo-source features are treated as the prior knowledge from the source domain, which plays an essential role in preventing catastrophic forgetting detailed in Sec. [3.4]Class-Wise Moving Queues ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"). Specifically, given a specific semantic category kùëòk, the corresponding source offline centroid is modeled as Gaussian distribution, and pseudo-source features are denoted as:\n\n|     |     |     |     |     |\n| --- | --- | --- | --- | --- |\n|  | Cs‚Äãr‚Äãcm,ksuperscriptsubscriptùê∂ùë†ùëüùëêùëöùëò\\\\displaystyle C\\_{src}^{m,k} | =ùí©‚Äã(Œºs‚Äãr‚Äãcm,k,œÉs‚Äãr‚Äãcm,k),absentùí©superscriptsubscriptùúáùë†ùëüùëêùëöùëòsuperscriptsubscriptùúéùë†ùëüùëêùëöùëò\\\\displaystyle=\\\\mathcal{N}(\\\\mu\\_{src}^{m,k},\\\\sigma\\_{src}^{m,k}), |  | (1) |\n|  | ùíµs‚Äãr‚Äãcm,ksubscriptsuperscriptùíµùëöùëòùë†ùëüùëê\\\\displaystyle\\\\mathcal{Z}^{m,k}\\_{src} | ={zs‚Äãr‚Äãc,im,k‚àºCs‚Äãr‚Äãcm,k‚à£i‚àà\\[1,Nq\\]},absentconditional-setsimilar-tosubscriptsuperscriptùëßùëöùëòùë†ùëüùëêùëñsuperscriptsubscriptùê∂ùë†ùëüùëêùëöùëòùëñ1subscriptùëÅùëû\\\\displaystyle=\\\\{z^{m,k}\\_{src,i}\\\\sim C\\_{src}^{m,k}\\\\mid i\\\\in\\[1,N\\_{q}\\]\\\\}, |  | (2) |\n\nwhere NqsubscriptùëÅùëûN\\_{q} is the number of pseudo-source features. Œºs‚Äãr‚Äãcm,ksuperscriptsubscriptùúáùë†ùëüùëêùëöùëò\\\\mu\\_{src}^{m,k} and œÉs‚Äãr‚Äãcm,ksuperscriptsubscriptùúéùë†ùëüùëêùëöùëò\\\\sigma\\_{src}^{m,k}\ndenote the mean and standard deviation of normalized source features from the category kùëòk, respectively. Here we use the features generated by the pre-trained extractor g0m‚Äã(‚ãÖ)superscriptsubscriptùëî0ùëö‚ãÖg\\_{0}^{m}(\\\\cdot) for the centroid construction.\n\n### 3.2 Intra-Modal Prediction Aggregation\n\nIn MM-CTTA, the prediction from each modality could be unreliable due to continual domain shifts, causing severe noise to the multi-modal fusion. To mitigate the intra-modal noise, iMPA aims to generate reliable intra-modal predictions for each modality. Although previous methods \\[ [46]), [42])\\] regard the augmentation-average prediction as a more stable alternative, we argue that its superiority is not certain since test-time augmentations may introduce inductive bias to the prediction \\[ [38])\\] (e.g., resizing image as in \\[ [46])\\] could cause ambiguity to small-scale classes). Unlike the previous work \\[ [46])\\], we propose an adaptive mechanism to fuse the raw and the augmentation-average prediction as the weighted sum based on their feature distance between class-wise centroids. Given the input sample xmsuperscriptùë•ùëöx^{m} and its augmented variants {x~im‚à£i‚àà\\[1,Na‚Äãu‚Äãgm\\]}conditional-setsubscriptsuperscript~ùë•ùëöùëñùëñ1subscriptsuperscriptùëÅùëöùëéùë¢ùëî\\\\{\\\\widetilde{x}^{m}\\_{i}\\\\mid i\\\\in\\[1,N^{m}\\_{aug}\\]\\\\}, the features and predictions are extracted by the teacher model œïŒ∏‚Ä≤msuperscriptsubscriptitalic-œïsuperscriptùúÉ‚Ä≤ùëö\\\\phi\\_{\\\\theta^{\\\\prime}}^{m} as:\n\n|     |     |     |     |     |\n| --- | --- | --- | --- | --- |\n|  | p‚Äã(xm)ùëùsuperscriptùë•ùëö\\\\displaystyle p(x^{m}) | =fŒ∏‚Ä≤m‚Äã(gŒ∏‚Ä≤m‚Äã(xm))=fŒ∏‚Ä≤m‚Äã(zm),absentsubscriptsuperscriptùëìùëösuperscriptùúÉ‚Ä≤subscriptsuperscriptùëîùëösuperscriptùúÉ‚Ä≤superscriptùë•ùëösubscriptsuperscriptùëìùëösuperscriptùúÉ‚Ä≤superscriptùëßùëö\\\\displaystyle=f^{m}\\_{\\\\theta^{\\\\prime}}(g^{m}\\_{\\\\theta^{\\\\prime}}(x^{m}))=f^{m}\\_{\\\\theta^{\\\\prime}}(z^{m}), |  | (3) |\n|  | p~‚Äã(xm)~ùëùsuperscriptùë•ùëö\\\\displaystyle\\\\widetilde{p}(x^{m}) | =1Na‚Äãu‚Äãgm‚Äã‚àëi=1Na‚Äãu‚ÄãgmfŒ∏‚Ä≤m‚Äã(gŒ∏‚Ä≤m‚Äã(x~im)),absent1subscriptsuperscriptùëÅùëöùëéùë¢ùëîsuperscriptsubscriptùëñ1subscriptsuperscriptùëÅùëöùëéùë¢ùëîsubscriptsuperscriptùëìùëösuperscriptùúÉ‚Ä≤subscriptsuperscriptùëîùëösuperscriptùúÉ‚Ä≤subscriptsuperscript~ùë•ùëöùëñ\\\\displaystyle=\\\\frac{1}{N^{m}\\_{aug}}\\\\sum\\_{i=1}^{N^{m}\\_{aug}}f^{m}\\_{\\\\theta^{\\\\prime}}(g^{m}\\_{\\\\theta^{\\\\prime}}(\\\\widetilde{x}^{m}\\_{i})), |  | (4) |\n\nwhere p‚Äã(xm)ùëùsuperscriptùë•ùëöp(x^{m}) and p~‚Äã(xm)~ùëùsuperscriptùë•ùëö\\\\widetilde{p}(x^{m}) represent the raw and the augmentation-average prediction, respectively. Both predictions are of shape N√óNcùëÅsubscriptùëÅùëêN\\\\times N\\_{c}, where NCsubscriptùëÅùê∂N\\_{C} is the number of classes and Na‚Äãu‚ÄãgmsubscriptsuperscriptùëÅùëöùëéùë¢ùëîN^{m}\\_{aug} denotes the number of augmentations. The normalized augmentation-average feature is computed as z~m=‚àëi=1Na‚Äãu‚Äãgmgm‚Äã(x~im)/(‚Äñgm‚Äã(x~im)‚Äñ‚ãÖNa‚Äãu‚Äãgm)superscript~ùëßùëösuperscriptsubscriptùëñ1subscriptsuperscriptùëÅùëöùëéùë¢ùëîsuperscriptùëîùëösubscriptsuperscript~ùë•ùëöùëñ‚ãÖnormsuperscriptùëîùëösubscriptsuperscript~ùë•ùëöùëñsubscriptsuperscriptùëÅùëöùëéùë¢ùëî\\\\widetilde{z}^{m}=\\\\sum\\_{i=1}^{N^{m}\\_{aug}}g^{m}(\\\\widetilde{x}^{m}\\_{i})/(\\\\\\|g^{m}(\\\\widetilde{x}^{m}\\_{i})\\\\\\|\\\\cdot N^{m}\\_{aug}). Subsequently, the weights for predictions p‚Äã(xm),p~‚Äã(xm)ùëùsuperscriptùë•ùëö~ùëùsuperscriptùë•ùëöp(x^{m}),\\\\widetilde{p}(x^{m}) are computed based on their corresponding feature distance to the class-wise centroid in a point-wise manner, so that each point of the intra-modal prediction p^‚Äã(xm)^ùëùsuperscriptùë•ùëö\\\\hat{p}(x^{m}) can attend more to the confident prediction located closer to the cluster in the latent space. Taking a point (j)ùëó(j) as an example, given its predictions p(j)‚Äã(xm)subscriptùëùùëósuperscriptùë•ùëöp\\_{(j)}(x^{m}), p~(j)‚Äã(xm)subscript~ùëùùëósuperscriptùë•ùëö\\\\widetilde{p}\\_{(j)}(x^{m}) and features z(j)msubscriptsuperscriptùëßùëöùëóz^{m}\\_{(j)}, z~(j)msubscriptsuperscript~ùëßùëöùëó\\\\widetilde{z}^{m}\\_{(j)}:\n\n|     |     |     |     |     |\n| --- | --- | --- | --- | --- |\n|  | w(j)msubscriptsuperscriptùë§ùëöùëó\\\\displaystyle w^{m}\\_{(j)} | =exp‚Å°(‚ü®Œºm,k,z(j)m‚ü©)‚àëi‚ààNcexp‚Å°(‚ü®Œºm,i,z(j)m‚ü©),absentsuperscriptùúáùëöùëòsubscriptsuperscriptùëßùëöùëósubscriptùëñsubscriptùëÅùëêsuperscriptùúáùëöùëñsubscriptsuperscriptùëßùëöùëó\\\\displaystyle=\\\\frac{\\\\exp(\\\\langle\\\\mu^{m,k},z^{m}\\_{(j)}\\\\rangle)}{\\\\sum\\_{i\\\\in N\\_{c}}\\\\exp(\\\\langle\\\\mu^{m,i},z^{m}\\_{(j)}\\\\rangle)}, |  | (5) |\n|  | w~(j)msubscriptsuperscript~ùë§ùëöùëó\\\\displaystyle\\\\widetilde{w}^{m}\\_{(j)} | =exp‚Å°(‚ü®Œºm,k~,z~(j)m‚ü©)‚àëi‚ààNcexp‚Å°(‚ü®Œºm,i,z~(j)m‚ü©),absentsuperscriptùúáùëö~ùëòsubscriptsuperscript~ùëßùëöùëósubscriptùëñsubscriptùëÅùëêsuperscriptùúáùëöùëñsubscriptsuperscript~ùëßùëöùëó\\\\displaystyle=\\\\frac{\\\\exp(\\\\langle\\\\mu^{m,\\\\widetilde{k}},\\\\widetilde{z}^{m}\\_{(j)}\\\\rangle)}{\\\\sum\\_{i\\\\in N\\_{c}}\\\\exp(\\\\langle\\\\mu^{m,i},\\\\widetilde{z}^{m}\\_{(j)}\\\\rangle)}, |  | (6) |\n|  | p^(j)‚Äã(xm)subscript^ùëùùëósuperscriptùë•ùëö\\\\displaystyle\\\\hat{p}\\_{(j)}(x^{m}) | =w(j)m‚Äãp(j)‚Äã(xm)+w~(j)m‚Äãp~(j)‚Äã(xm)w(j)m+w~(j)m,absentsubscriptsuperscriptùë§ùëöùëósubscriptùëùùëósuperscriptùë•ùëösubscriptsuperscript~ùë§ùëöùëósubscript~ùëùùëósuperscriptùë•ùëösubscriptsuperscriptùë§ùëöùëósubscriptsuperscript~ùë§ùëöùëó\\\\displaystyle=\\\\frac{w^{m}\\_{(j)}p\\_{(j)(x^{m})}+\\\\widetilde{w}^{m}\\_{(j)}\\\\widetilde{p}\\_{(j)}(x^{m})}{w^{m}\\_{(j)}+\\\\widetilde{w}^{m}\\_{(j)}}, |  | (7) |\n\nwhere w(j)msubscriptsuperscriptùë§ùëöùëów^{m}\\_{(j)}, w~(j)msubscriptsuperscript~ùë§ùëöùëó\\\\widetilde{w}^{m}\\_{(j)} are termed as the raw weight and augmentation-average weight, respectively. kùëòk, k~~ùëò\\\\widetilde{k} are the largest element locations of p(j)‚Äã(xm)subscriptùëùùëósuperscriptùë•ùëöp\\_{(j)}(x^{m}), p~(j)‚Äã(xm)subscript~ùëùùëósuperscriptùë•ùëö\\\\widetilde{p}\\_{(j)}(x^{m}). Œºm,ksuperscriptùúáùëöùëò\\\\mu^{m,k} denotes the mean of class kùëòk centroid, which is actively updated as shown in Sec. [3.4]Class-Wise Moving Queues ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"). ‚ü®a,b‚ü©ùëéùëè\\\\langle a,b\\\\rangle represents the inner product of vectors aùëéa and bùëèb. Our empirical results show that this adaptive fusion between the raw and augmentation-average predictions results in more stable intra-modal predictions.\n\n### 3.3 Inter-Modal Pseudo-Label Fusion\n\nGiven the output of iMPA, the goal of xMPF is to generate pseudo-labels by estimating their reliability in a cross-modal manner. Since domain shifts can affect the reliability of each modality variously (e.g., images in day and night), the cross-modal pseudo-label should adaptively attend to the reliable modality for noise suppression. Motivated by this idea, the proposed xMPF generates the cross-modal pseudo-labels as the weighted sum of intra-modal predictions from iMPA. Specifically, taking point (j)ùëó(j) as an example, the inter-modal weight w^(j)msubscriptsuperscript^ùë§ùëöùëó\\\\hat{w}^{m}\\_{(j)} is computed as the summation of both weights if their corresponding predictions indicate the same class, or the maximum one otherwise. This can be viewed as an implicit way to encourage point-wise prediction consistency for each modality. Formally, the inter-modal weight w^(j)msubscriptsuperscript^ùë§ùëöùëó\\\\hat{w}^{m}\\_{(j)} is computed as follows:\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n|  | w^(j)m={w(j)m+w~(j)m,ifk=k~max‚Å°(w(j)m,w~(j)m),ifk‚â†k~.subscriptsuperscript^ùë§ùëöùëócasessubscriptsuperscriptùë§ùëöùëósubscriptsuperscript~ùë§ùëöùëóifùëò~ùëòotherwisesubscriptsuperscriptùë§ùëöùëósubscriptsuperscript~ùë§ùëöùëóifùëò~ùëòotherwise\\\\hat{w}^{m}\\_{(j)}=\\\\begin{cases}w^{m}\\_{(j)}+\\\\widetilde{w}^{m}\\_{(j)},\\ \\ \\\\textrm{if}\\ \\ k=\\\\widetilde{k}\\\\\\<br>\\\\max(w^{m}\\_{(j)},\\\\widetilde{w}^{m}\\_{(j)}),\\ \\ \\\\textrm{if}\\ \\ k\\\\neq\\\\widetilde{k}\\\\end{cases}. |  | (8) |\n\nThe cross-modal prediction is then computed as the weighted sum in a cross-modal manner:\n\n|     |     |     |     |     |\n| --- | --- | --- | --- | --- |\n|  | p^(j)xM‚Äã(x)subscriptsuperscript^ùëùxMùëóùë•\\\\displaystyle\\\\hat{p}^{\\\\textrm{xM}}\\_{(j)}(x) | =w^(j)2D‚Äãp^(j)2D‚Äã(x)+w^(j)3D‚Äãp^(j)3D‚Äã(x)w^(j)2D+w^(j)3D,absentsubscriptsuperscript^ùë§2Dùëósubscriptsuperscript^ùëù2Dùëóùë•subscriptsuperscript^ùë§3Dùëósubscriptsuperscript^ùëù3Dùëóùë•subscriptsuperscript^ùë§2Dùëósubscriptsuperscript^ùë§3Dùëó\\\\displaystyle=\\\\frac{\\\\hat{w}^{\\\\textrm{2D}}\\_{(j)}\\\\hat{p}^{\\\\textrm{2D}}\\_{(j)}(x)+\\\\hat{w}^{\\\\textrm{3D}}\\_{(j)}\\\\hat{p}^{\\\\textrm{3D}}\\_{(j)}(x)}{\\\\hat{w}^{\\\\textrm{2D}}\\_{(j)}+\\\\hat{w}^{\\\\textrm{3D}}\\_{(j)}}, |  | (9) |\n|  | y^(j)subscript^ùë¶ùëó\\\\displaystyle\\\\hat{y}\\_{(j)} | =arg‚Å°maxk‚ààNc‚Å°(p^(j)xM‚Äã(x)(k)),absentsubscriptùëòsubscriptùëÅùëêsubscriptsuperscript^ùëùxMùëósuperscriptùë•ùëò\\\\displaystyle=\\\\arg\\\\max\\_{k\\\\in N\\_{c}}(\\\\hat{p}^{\\\\textrm{xM}}\\_{(j)}(x)^{(k)}), |  | (10) |\n\nwhere p^(j)xM‚Äã(x)subscriptsuperscript^ùëùxMùëóùë•\\\\hat{p}^{\\\\textrm{xM}}\\_{(j)}(x), y^(j)subscript^ùë¶ùëó\\\\hat{y}\\_{(j)} denote the cross-modal prediction and pseudo-label, respectively. The cross-modal pseudo-label can therefore attend to the more reliable modality with confident intra-modal predictions.\n\n### 3.4 Class-Wise Moving Queues\n\nBoth iMPA and xMPF greatly depend on the quality of class-wise centroids. Initialized from the source offline centroids as in Eq. [1]In 3.1 Source Models and Class-Wise Centroids ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"), the class-wise centroids should continually adapt to the target domain to ensure the validity of iMPA and xMPF. Meanwhile, the source knowledge should be occasionally played back during the centroid adaptation so that it can be revisited during the reliability estimation in iMPA and xMPF without catastrophic forgetting. To achieve a balance between adaptation and source knowledge preservation, we propose CMQs which utilize momentum queues \\[ [15])\\] to actively estimate feature clustering of the target domain by capturing confident target features while stochastically restoring pseudo-source features for each modality. Specifically, the CMQ of the class kùëòk is initialized by the pseudo-source features ùíµs‚Äãr‚Äãcm,ksubscriptsuperscriptùíµùëöùëòùë†ùëüùëê\\\\mathcal{Z}^{m,k}\\_{src} as in Eq. [2]In 3.1 Source Models and Class-Wise Centroids ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"). For each iteration, taking the raw sample as input, the normalized point features from the student network œïŒ∏msuperscriptsubscriptitalic-œïùúÉùëö\\\\phi\\_{\\\\theta}^{m} with confident predictions are preserved by threshold-based filtering. Given the CMQ of class kùëòk from the previous step denoted as ùí¨^t‚àí1m,ksuperscriptsubscript^ùí¨ùë°1ùëöùëò\\\\mathcal{\\\\hat{Q}}\\_{t-1}^{m,k}, the CMQ of current step is updated as:\n\n|     |     |     |     |     |\n| --- | --- | --- | --- | --- |\n|  | ùíµc‚Äãfm,ksuperscriptsubscriptùíµùëêùëìùëöùëò\\\\displaystyle\\\\mathcal{Z}\\_{cf}^{m,k} | =ùüôc‚Äãfk‚Äã\\[gŒ∏m‚Äã(xm)/‚ÄñgŒ∏m‚Äã(xm)‚Äñ\\],absentsubscriptsuperscript1ùëòùëêùëìdelimited-\\[\\]superscriptsubscriptùëîùúÉùëösuperscriptùë•ùëönormsuperscriptsubscriptùëîùúÉùëösuperscriptùë•ùëö\\\\displaystyle=\\\\mathbbm{1}^{k}\\_{cf}\\[g\\_{\\\\theta}^{m}(x^{m})/\\\\\\|g\\_{\\\\theta}^{m}(x^{m})\\\\\\|\\], |  | (11) |\n|  | ùí¨~tm,ksuperscriptsubscript~ùí¨ùë°ùëöùëò\\\\displaystyle\\\\mathcal{\\\\widetilde{Q}}\\_{t}^{m,k} | =Œ¶‚Äã(ùí¨^t‚àí1m,k,ùíµc‚Äãfm,k),absentŒ¶superscriptsubscript^ùí¨ùë°1ùëöùëòsuperscriptsubscriptùíµùëêùëìùëöùëò\\\\displaystyle=\\\\Phi(\\\\mathcal{\\\\hat{Q}}\\_{t-1}^{m,k},\\\\mathcal{Z}\\_{cf}^{m,k}), |  | (12) |\n|  | ùí¨^tm,ksuperscriptsubscript^ùí¨ùë°ùëöùëò\\\\displaystyle\\\\mathcal{\\\\hat{Q}}\\_{t}^{m,k} | ={ùí¨~tm,k,ifŒ≥t>pr‚ÄãsŒ¶‚Äã(ùí¨^t‚àí1m,k,ùüôr‚Äãsk‚Äãùíµs‚Äãr‚Äãcm,k),ifŒ≥t‚â§pr‚Äãs,absentcasessuperscriptsubscript~ùí¨ùë°ùëöùëòifsubscriptùõæùë°subscriptùëùùëüùë†Œ¶superscriptsubscript^ùí¨ùë°1ùëöùëòsubscriptsuperscript1ùëòùëüùë†subscriptsuperscriptùíµùëöùëòùë†ùëüùëêifsubscriptùõæùë°subscriptùëùùëüùë†\\\\displaystyle=\\\\begin{cases}\\\\mathcal{\\\\widetilde{Q}}\\_{t}^{m,k},&\\\\textrm{if}\\ \\ \\\\gamma\\_{t}>p\\_{rs}\\\\\\<br>\\\\Phi(\\\\mathcal{\\\\hat{Q}}\\_{t-1}^{m,k},\\\\mathbbm{1}^{k}\\_{rs}\\\\mathcal{Z}^{m,k}\\_{src}),&\\\\textrm{if}\\ \\ \\\\gamma\\_{t}\\\\leq p\\_{rs}\\\\end{cases}, |  | (13) |\n\nwhere ùüôc‚Äãfksubscriptsuperscript1ùëòùëêùëì\\\\mathbbm{1}^{k}\\_{cf} is the confidence index for class kùëòk where ùüôc‚Äãfk‚ÄãœïŒ∏m‚Äã(xm)(k)‚â•œÑc‚Äãfsubscriptsuperscript1ùëòùëêùëìsuperscriptsubscriptitalic-œïùúÉùëösuperscriptsuperscriptùë•ùëöùëòsubscriptùúèùëêùëì\\\\mathbbm{1}^{k}\\_{cf}\\\\phi\\_{\\\\theta}^{m}(x^{m})^{(k)}\\\\geq\\\\tau\\_{cf} and ùüôr‚Äãsksubscriptsuperscript1ùëòùëüùë†\\\\mathbbm{1}^{k}\\_{rs} denotes the source restoring index which randomly samples Ne‚Äãn‚ÄãqsubscriptùëÅùëíùëõùëûN\\_{enq} pseudo-source features from ùíµs‚Äãr‚Äãcm,ksubscriptsuperscriptùíµùëöùëòùë†ùëüùëê\\\\mathcal{Z}^{m,k}\\_{src}. Œ¶‚Äã(a,b)Œ¶ùëéùëè\\\\Phi(a,b) denotes the operation of enqueuing bùëèb in aùëéa as in \\[ [15])\\]. Œ≥tsubscriptùõæùë°\\\\gamma\\_{t} is a restoring flag uniformly sampled from \\[0,1\\]01\\[0,1\\] at timestamp tùë°t and pr‚Äãssubscriptùëùùëüùë†p\\_{rs} denotes the hyper-parameter of restoring probability. Different from the image classification problem which can capture all confident samples \\[ [40])\\], the number of confident points from each class can be huge (i.e., more than 1,000), which is too aggressive and expensive to enqueue all points. Therefore, we limit the index number of ùüôc‚Äãfksubscriptsuperscript1ùëòùëêùëì\\\\mathbbm{1}^{k}\\_{cf} by an upper bound Ne‚Äãn‚ÄãqsubscriptùëÅùëíùëõùëûN\\_{enq} through selecting features with the top Ne‚Äãn‚ÄãqsubscriptùëÅùëíùëõùëûN\\_{enq} confident predictions.\n\nFor each optimization step, the mean of the class-wise centroid for the next step Œºt+1m,ksuperscriptsubscriptùúáùë°1ùëöùëò\\\\mu\\_{t+1}^{m,k} is updated as the average of CMQ of the current timestamp ùí¨^tm,ksuperscriptsubscript^ùí¨ùë°ùëöùëò\\\\mathcal{\\\\hat{Q}}\\_{t}^{m,k} so that the class-wise centroids can adapt to the feature clustering of target domain without catastrophic forgetting. Additionally, we propose a class-wise contrastive loss modified from \\[ [20])\\] as a regularizer so that the target confident features can revisit source knowledge through clustering around the class-wise centroids. Specifically, given any confident target feature from Eq. [11]In 3.4 Class-Wise Moving Queues ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\") as the anchor, the positive samples are the features from the CMQ that shares the same modality and semantic class, denoted as P‚Äã(k)={q^p‚à£q^p‚ààùí¨^tm,k}ùëÉùëòconditional-setsubscript^ùëûùëùsubscript^ùëûùëùsuperscriptsubscript^ùí¨ùë°ùëöùëòP(k)=\\\\{\\\\hat{q}\\_{p}\\\\mid\\\\hat{q}\\_{p}\\\\in\\\\mathcal{\\\\hat{Q}}\\_{t}^{m,k}\\\\}. The negative samples are the features from the CMQs of the same modality but different classes denoted as A‚Äã(k)={q^n‚à£q^n‚ààùí¨^tm,a,‚àÄa‚â†k‚Äã‚ãÇa‚ààNc}ùê¥ùëòconditional-setsubscript^ùëûùëõformulae-sequencesubscript^ùëûùëõsuperscriptsubscript^ùí¨ùë°ùëöùëéfor-allùëéùëòùëésubscriptùëÅùëêA(k)=\\\\{\\\\hat{q}\\_{n}\\\\mid\\\\hat{q}\\_{n}\\\\in\\\\mathcal{\\\\hat{Q}}\\_{t}^{m,a},\\\\forall a\\\\neq k\\\\bigcap a\\\\in N\\_{c}\\\\}. The class-wise contrastive loss ‚Ñíc‚Äãt‚Äãsmsubscriptsuperscript‚Ñíùëöùëêùë°ùë†\\\\mathcal{L}^{m}\\_{cts} is computed as:\n\n|     |     |     |     |     |\n| --- | --- | --- | --- | --- |\n|  | ‚Ñíc‚Äãt‚Äãsm=superscriptsubscript‚Ñíùëêùë°ùë†ùëöabsent\\\\displaystyle\\\\mathcal{L}\\_{cts}^{m}= | ‚àëi‚àà\\|ùíµc‚Äãfm,k\\|‚àí1\\|P‚Äã(k)\\|subscriptùëñsuperscriptsubscriptùíµùëêùëìùëöùëò1ùëÉùëò\\\\displaystyle\\\\sum\\_{i\\\\in\\|\\\\mathcal{Z}\\_{cf}^{m,k}\\|}\\\\frac{-1}{\\|P(k)\\|} |  |\n|  |  | ‚àëqp‚ààP‚Äã(k)exp‚Å°(z^t,(i)m,k‚ãÖqp)‚àëqn‚ààN‚Äã(k)exp‚Å°(z^t,(i)m,k‚ãÖqn).subscriptsubscriptùëûùëùùëÉùëò‚ãÖsuperscriptsubscript^ùëßùë°ùëñùëöùëòsubscriptùëûùëùsubscriptsubscriptùëûùëõùëÅùëò‚ãÖsuperscriptsubscript^ùëßùë°ùëñùëöùëòsubscriptùëûùëõ\\\\displaystyle\\\\sum\\_{q\\_{p}\\\\in P(k)}\\\\frac{\\\\exp{(\\\\hat{z}\\_{t,(i)}^{m,k}\\\\cdot q\\_{p})}}{\\\\sum\\_{q\\_{n}\\\\in N(k)}\\\\exp{(\\\\hat{z}\\_{t,(i)}^{m,k}\\\\cdot q\\_{n})}}. |  | (14) |\n\nInit Model:Teacher œïŒ∏‚Ä≤msuperscriptsubscriptitalic-œïsuperscriptùúÉ‚Ä≤ùëö\\\\phi\\_{\\\\theta^{\\\\prime}}^{m}, student œïŒ∏msuperscriptsubscriptitalic-œïùúÉùëö\\\\phi\\_{\\\\theta}^{m}, m‚àà{2D,3D}ùëö2D3Dm\\\\in\\\\{\\\\text{2D},\\\\text{3D}\\\\}\n\nInit CMQ:ùí¨^0m,k=ùíµs‚Äãr‚Äãcm,ksuperscriptsubscript^ùí¨0ùëöùëòsubscriptsuperscriptùíµùëöùëòùë†ùëüùëê\\\\mathcal{\\\\hat{Q}}\\_{0}^{m,k}=\\\\mathcal{Z}^{m,k}\\_{src}, m‚àà{2D,3D},k‚ààNcformulae-sequenceùëö2D3DùëòsubscriptùëÅùëêm\\\\in\\\\{\\\\text{2D},\\\\text{3D}\\\\},k\\\\in N\\_{c}\n\nfor _t‚àà\\|ùí≥ùíØ\\|ùë°subscriptùí≥ùíØt\\\\in\\|\\\\mathcal{X}\\_{\\\\mathcal{T}}\\|, x=(x_2D_,x_3D_)‚ààùí≥ùíØùë•superscriptùë•_2D_superscriptùë•_3D_subscriptùí≥ùíØx=(x^{\\\\text{2D}},x^{\\\\text{3D}})\\\\in\\\\mathcal{X}\\_{\\\\mathcal{T}}_ do\n\nfor _m‚àà{2D,3D}ùëö2D3Dm\\\\in\\\\{\\\\textrm{2D},\\\\textrm{3D}\\\\}_ do\n\n\n1\\. Augmented input to get {x~im‚à£i‚ààNa‚Äãu‚Äãgm}conditional-setsubscriptsuperscript~ùë•ùëöùëñùëñsubscriptsuperscriptùëÅùëöùëéùë¢ùëî\\\\{\\\\widetilde{x}^{m}\\_{i}\\\\mid i\\\\in N^{m}\\_{aug}\\\\}\n\n\n2\\. Get predictions and features with œïŒ∏‚Ä≤msuperscriptsubscriptitalic-œïsuperscriptùúÉ‚Ä≤ùëö\\\\phi\\_{\\\\theta^{\\\\prime}}^{m} by Eq. [3]In 3.2 Intra-Modal Prediction Aggregation ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")- [4]In 3.2 Intra-Modal Prediction Aggregation ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")\n\n\n3\\. Get intra-modal p^m‚Äã(xm)superscript^ùëùùëösuperscriptùë•ùëö\\\\hat{p}^{m}(x^{m}) by iMPA through Eq. [5]In 3.2 Intra-Modal Prediction Aggregation ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")- [7]In 3.2 Intra-Modal Prediction Aggregation ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")\n\n‚ÄÖ‚ÄÖ‚ÄÖ‚ÄÖ end for\n\n‚ÄÖ‚ÄÖ‚ÄÖ‚ÄÖ4\\. Get inter-modal y^^ùë¶\\\\hat{y} by xMPF through Eq. [8]In 3.3 Inter-Modal Pseudo-Label Fusion ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")- [10]In 3.3 Inter-Modal Pseudo-Label Fusion ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")\n\n\n5\\. Update CMQs and compute ‚Ñíc‚Äãt‚Äãsmsubscriptsuperscript‚Ñíùëöùëêùë°ùë†\\\\mathcal{L}^{m}\\_{cts} by Eq. [11]In 3.4 Class-Wise Moving Queues ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")- [14]In 3.4 Class-Wise Moving Queues ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")\n\n\n6\\. Update œïŒ∏msuperscriptsubscriptitalic-œïùúÉùëö\\\\phi\\_{\\\\theta}^{m} by Eq. [16]In 3.5 Main Structure and Optimization ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\") and œïŒ∏‚Ä≤msuperscriptsubscriptitalic-œïsuperscriptùúÉ‚Ä≤ùëö\\\\phi\\_{\\\\theta^{\\\\prime}}^{m} by Eq. [17]In 3.5 Main Structure and Optimization ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")\n\n‚ÄÖ‚ÄÖ‚ÄÖ‚ÄÖ end for\n\nAlgorithm 1The proposed CoMAC\n\n### 3.5 Main Structure and Optimization\n\nThe main structure of our proposed method is shown in Fig. [2]Figure 2 ‚Ä£ 2 Related Works ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"). Given the multi-modal input xmsuperscriptùë•ùëöx^{m}, the teacher model is used to infer xmsuperscriptùë•ùëöx^{m} and its augmented variants {x~im\\|i‚àà\\[1,Na‚Äãu‚Äãgm\\]}conditional-setsubscriptsuperscript~ùë•ùëöùëñùëñ1subscriptsuperscriptùëÅùëöùëéùë¢ùëî\\\\{\\\\widetilde{x}^{m}\\_{i}\\|i\\\\in\\[1,N^{m}\\_{aug}\\]\\\\} and then generate reliable cross-modal pseudo-labels denoted as y^^ùë¶\\\\hat{y} through iMPA and xMPF. The student model is directly updated by minimizing the weighted sum of the standard cross-entropy loss between its prediction and the pseudo-label y^^ùë¶\\\\hat{y}, and the contrastive loss in Eq. [14]In 3.4 Class-Wise Moving Queues ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"). The teacher model is updated as the exponential moving average of the student‚Äôs weights as in previous works \\[ [39]), [46])\\]:\n\n|     |     |     |     |     |\n| --- | --- | --- | --- | --- |\n|  | ‚Ñíc‚Äãemsubscriptsuperscript‚Ñíùëöùëêùëí\\\\displaystyle\\\\mathcal{L}^{m}\\_{ce} | =ùüôy^‚Äãlog‚Å°œïm‚Äã(xm),absentsubscript1^ùë¶superscriptitalic-œïùëösuperscriptùë•ùëö\\\\displaystyle=\\\\mathbbm{1}\\_{\\\\hat{y}}\\\\log{\\\\phi^{m}(x^{m})}, |  | (15) |\n|  | ‚Ñít‚Äão‚Äãt‚Äãa‚Äãlsubscript‚Ñíùë°ùëúùë°ùëéùëô\\\\displaystyle\\\\mathcal{L}\\_{total} | =‚àëm{2D,3D}(‚Ñíc‚Äãem+Œªc‚Äãt‚Äãs‚Äã‚Ñíc‚Äãt‚Äãsm),absentsuperscriptsubscriptùëö2D3Dsubscriptsuperscript‚ÑíùëöùëêùëísubscriptùúÜùëêùë°ùë†subscriptsuperscript‚Ñíùëöùëêùë°ùë†\\\\displaystyle=\\\\sum\\_{m}^{\\\\{\\\\textrm{2D},\\\\textrm{3D}\\\\}}(\\\\mathcal{L}^{m}\\_{ce}+\\\\lambda\\_{cts}\\\\mathcal{L}^{m}\\_{cts}), |  | (16) |\n|  | Œ∏t+1‚Ä≤subscriptsuperscriptùúÉ‚Ä≤ùë°1\\\\displaystyle\\\\theta^{\\\\prime}\\_{t+1} | =(1‚àíŒªs)‚ÄãŒ∏+Œªs‚ÄãŒ∏‚Ä≤,absent1subscriptùúÜùë†ùúÉsubscriptùúÜùë†superscriptùúÉ‚Ä≤\\\\displaystyle=(1-\\\\lambda\\_{s})\\\\theta+\\\\lambda\\_{s}\\\\theta^{\\\\prime}, |  | (17) |\n\nwhere Œªc‚Äãt‚ÄãssubscriptùúÜùëêùë°ùë†\\\\lambda\\_{cts} and ŒªssubscriptùúÜùë†\\\\lambda\\_{s} are the hyper-parameters denoting the coefficient of the contrastive loss and the momentum factor. Our adaptation process is summarized as Algorithm [1]In 3.4 Class-Wise Moving Queues ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\").",
            "citations": null
          },
          "4 Experiments": {
            "content": "In this section, we present our experimental results based on two new benchmarks. The details of our proposed benchmarks, baselines, and implementation are first introduced in Sec. [4.1]Benchmarks and Settings ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"). Sec. [4.2]Overall Results ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\") presents our overall results and Sec. [4.3]Ablation Studies ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\") justifies our method by extensive ablation studies.\n\n|     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |     |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| Time | t‚Üíùë°‚Üít\\ \\ \\\\xrightarrow{\\\\hskip 280.00043pt} | t‚Üíùë°‚Üít\\ \\ \\\\xrightarrow{\\\\hskip 220.00034pt} |\n| Methods | DA Type | SemanticKITTI-to-Synthia | SemanticKITTI-to-Waymo |\n| 01-Spring | 02-Summer | 04-Fall | 05-Winter | 01-Dawn | 02-Night | 04-Sunset | 05-W-night | 01-Fog | 02-S-Rain | 04-R-Night | 05-Rain | Avg | D-O-1 | D-P-1 | D-S-1 | DD-1 | N-1 | D-O-2 | D-P-2 | D-S-2 | DD-2 | N-2 | Avg |\n| Source | - | 28.3 | 30.7 | 37.7 | 27.3 | 23.1 | 27.3 | 38.2 | 26.5 | 27.0 | 21.6 | 27.8 | 16.4 | 27.7 | 33.2 | 36.9 | 29.5 | 28.3 | 14.0 | 32.8 | 38.0 | 30.4 | 28.4 | 14.6 | 28.6 |\n| Pslabel | TTA | 29.6 | 27.1 | 36.4 | 28.4 | 21.4 | 26.6 | 32.3 | 26.1 | 27.4 | 21.8 | 25.0 | 18.0 | 26.7 | 39.1 | 41.9 | 37.0 | 36.8 | 25.7 | 38.5 | 43.7 | 37.6 | 37.6 | 24.6 | 36.9 |\n| TENT \\[ [18])\\] | TTA | 35.4 | 24.9 | 24.9 | 20.7 | 18.7 | 16.6 | 16.0 | 13.6 | 13.6 | 11.5 | 8.4 | 9.1 | 17.8 | 33.6 | 22.3 | 18.8 | 16.9 | 10.8 | 15.7 | 12.9 | 9.8 | 11.3 | 10.6 | 16.3 |\n| LAME \\[ [3])\\] | TTA | 14.0 | 12.4 | 17.3 | 13.0 | 12.6 | 11.6 | 17.0 | 13.2 | 19.2 | 7.7 | 7.8 | 6.0 | 12.7 | 11.9 | 10.4 | 13.4 | 9.2 | 8.7 | 13.4 | 11.2 | 12.2 | 9.7 | 8.6 | 12.7 |\n| xMUDA-pl \\[ [19])\\] | MM-TTA | 28.8 | 26.9 | 35.9 | 28.2 | 21.3 | 26.5 | 32.2 | 26.0 | 27.0 | 21.6 | 24.9 | 17.9 | 26.4 | 39.3 | 42.1 | 37.4 | 37.0 | 25.9 | 38.7 | 43.9 | 37.9 | 37.7 | 25.0 | 36.5 |\n| MMTTA \\[ [39])\\] | MM-TTA | 31.1 | 24.4 | 30.7 | 25.8 | 28.3 | 24.2 | 26.8 | 23.2 | 29.6 | 20.7 | 22.1 | 20.6 | 25.6 | 39.9 | 40.0 | 30.9 | 31.5 | 29.6 | 30.6 | 32.2 | 23.9 | 26.4 | 23.8 | 30.9 |\n| CoTTA \\[ [46])\\] | CTTA | 29.7 | 27.2 | 34.7 | 27.0 | 26.4 | 25.6 | 33.0 | 27.3 | 28.1 | 18.0 | 22.7 | 18.4 | 26.5 | 32.9 | 28.0 | 22.9 | 22.2 | 20.3 | 26.1 | 24.9 | 23.6 | 24.7 | 19.7 | 24.5 |\n| EATA \\[ [32])\\] | CTTA | 34.0 | 30.0 | 38.6 | 30.2 | 30.2 | 28.4 | 36.5 | 30.1 | 32.2 | 21.3 | 25.3 | 20.1 | 29.7 | 40.1 | 40.8 | 36.3 | 34.3 | 28.9 | 39.3 | 41.7 | 36.5 | 37.9 | 28.8 | 36.5 |\n| MMTTA-rs \\[ [39])\\] | MM-CTTA | 31.9 | 28.1 | 37.7 | 29.3 | 28.7 | 27.6 | 35.2 | 29.7 | 30.2 | 20.4 | 25.6 | 20.3 | 28.7 | 40.4 | 41.5 | 36.3 | 34.7 | 30.2 | 39.9 | 41.5 | 36.4 | 38.3 | 29.9 | 36.9 |\n| CoMAC (Ours) | MM-CTTA | 34.0 | 34.7 | 44.9 | 38.1 | 35.0 | 37.8 | 45.1 | 39.0 | 39.1 | 29.4 | 35.1 | 27.1 | 36.6 | 41.4 | 43.7 | 38.8 | 37.8 | 32.2 | 42.2 | 41.8 | 40.7 | 38.9 | 30.4 | 38.8 |\n| Time | t‚Üêùë°‚Üêt\\ \\ \\\\xleftarrow{\\\\hskip 280.00043pt} | t‚Üêùë°‚Üêt\\ \\ \\\\xleftarrow{\\\\hskip 220.00034pt} |\n| TENT \\[ [18])\\] | TTA | 10.2 | 8.8 | 8.6 | 9.0 | 10.2 | 9.5 | 9.8 | 11.4 | 18.3 | 13.2 | 16.9 | 18.9 | 12.1 | 12.0 | 11.5 | 9.2 | 9.8 | 9.7 | 12.6 | 13.0 | 12.5 | 19.8 | 21.2 | 13.1 |\n| MMTTA-rs \\[ [39])\\] | MM-CTTA | 31.4 | 27.4 | 37.2 | 28.7 | 26.2 | 27.2 | 33.1 | 29.0 | 28.5 | 19.9 | 22.3 | 19.7 | 27.6 | 40.4 | 41.4 | 36.4 | 31.6 | 29.1 | 37.6 | 40.2 | 35.4 | 35.2 | 27.8 | 35.5 |\n| CoMAC (Ours) | MM-CTTA | 34.6 | 32.8 | 40.9 | 33.2 | 31.8 | 32.4 | 39.2 | 33.2 | 33.8 | 25.1 | 30.3 | 23.3 | 32.4 | 40.8 | 41.9 | 37.7 | 33.2 | 30.3 | 39.6 | 43.6 | 38.8 | 38.6 | 30.0 | 37.5 |\n\nTable 1: Performance (mIoU) of SemanticKITTI-to-Synthia. Here we report the softmax-average mIoU of 2D and 3D prediction.![Refer to caption]Figure 3: Ablation studies to justify our design of CoMAC. Specifically, (a) compares CoMAC with variants only using raw or augmented samples as input of iMPA and (b) justifies the necessity of weighting mechanisms in iMPA and xMPF. (c) compares CoMAC with variants without either target feature enqueuing or pseudo-source features restoring in CMQs. Scores within the parentheses are the average mIoU.\n\n### 4.1 Benchmarks and Settings\n\nProposed benchmarks. To evaluate the performance under MM-CTTA settings, we proposed two benchmarks in this work, including (i) SemanticKITTI-to-Synthia (S-to-S) and (ii) SemanticKITTI-to-Waymo (S-to-W). Both benchmarks leverage SemanticKITTI \\[ [2])\\] as the source-domain dataset, which utilizes a 0.7MP camera and a 64-line LiDAR. For the target domain, we utilize two different datasets including Synthia \\[ [36])\\] and Waymo \\[ [41])\\] thanks to the various environmental conditions they cover. The former shares a larger domain gap with more diverse seasons, weather, and illumination conditions while the latter is less challenging but closer to the real-world application. For S-to-S, it is constructed by a sequence of different videos from Synthia \\[ [36])\\] without any repetition. Since Synthia includes depth images instead of 3D point clouds, we generate a simulated point cloud for each sample by randomly sampling depth pixels as 3D points following the structural characteristic of LiDAR. For each sequence, all samples are included for adaptation and we use ‚ÄúNo.-Conditions‚Äù to indicate their corresponding video sequence in Synthia (i.e, ‚Äú01-Spring‚Äù indicates video sequence 01 under Spring condition). Different from the previous CTTA benchmark \\[ [46])\\] which only includes 4 different unique sequences, the proposed S-to-S consists of 12 different sequences recorded under various environmental conditions without repetition. By default, we organize the sequences following the order of seasons‚Üí‚Üí\\\\rightarrowillumination‚Üí‚Üí\\\\rightarrowweathers as a challenge ascending order. For S-to-W, we sort out the illumination conditions of each sequence in Waymo dataset \\[ [41])\\] based on the sequence descriptions and divide all samples into three types, including Day (D), Dawn-Dusk (DD), and Night (N). Since the number of sequences of D is much larger than others, we further split the sequence of D based on their recording location, including Phoenix (P), San Francisco (S), and Others (O). Each sequence is separated in two halves to simulate the revisiting situation as in \\[ [46])\\] but without repeated samples (i.e., ‚ÄúD-O-1‚Äù indicates the first half of the D-O sequence). Similar to S-to-S, S-to-W also follows a challenge ascending order. For both datasets, we adopt the images of the front-view camera similar to the source-domain dataset. We utilize a similar class mapping strategy as \\[ [19]), [39])\\] with slight modification since some classes are missing in the target domain. More details are illustrated in the appendix.\n\nBaselines. Previous TTA, MM-TTA, and CTTA methods are evaluated on both S-to-S and S-to-M as baselines. For TTA methods, we compare with pseudo-labels with threshold filtering (Pslabel), TENT \\[ [18])\\] and LAME \\[ [3])\\], while xMUDA with pseudo-labels (xMUDA-pl) \\[ [19])\\] and MMTTA \\[ [47])\\] are regarded as the representatives of MM-TTA methods. CoTTA \\[ [46])\\] and EATA \\[ [32])\\] are the recent works that focus on CTTA problems. Specifically, xMUDA-pl is originally designed for UDA, whereas we modify it into a TTA version by discarding the source data during adaptation. Considering our CoMAC is the only MM-CTTA method, we implement an MM-CTTA version of MMTTA \\[ [39])\\] integrated with model-based stochastic restoration in \\[ [46])\\] for a fair comparison. We report the softmax-average mIoU of 2D and 3D predictions as results.\n\nImplementation details. Following previous works \\[ [19]), [39])\\], we utilize UNet \\[ [35])\\] with ResNet-34 \\[ [16])\\] encoder as the 2D backbone and SCN \\[ [14])\\] based on UNet as the 3D backbone for all baselines. The pre-training procedures on SemanticKITTI dataset follow \\[ [19])\\]. For our method, we empirically choose resizing and z-rotation as the 2D and 3D augmentations following previous works \\[ [46]), [19])\\]. Specifically, we utilize multiple resizing factors of \\[0.5, 0.625, 0.75, 0.875\\] and z-rotation of \\[60‚àòsuperscript6060^{\\\\circ}, 120‚àòsuperscript120120^{\\\\circ}, 180‚àòsuperscript180180^{\\\\circ}, 240‚àòsuperscript240240^{\\\\circ}, 300‚àòsuperscript300300^{\\\\circ}\\]. NqsubscriptùëÅùëûN\\_{q} and Ne‚Äãn‚ÄãqsubscriptùëÅùëíùëõùëûN\\_{enq} are set to 4096 and 200, respectively. We utilize a restore rate pr‚Äãssubscriptùëùùëüùë†p\\_{rs} of 0.5 and a momentum factor ŒªssubscriptùúÜùë†\\\\lambda\\_{s} of 0.999 with a coefficient Œªc‚Äãt‚ÄãssubscriptùúÜùëêùë°ùë†\\\\lambda\\_{cts} of 1. All methods strictly follow the one-pass protocol \\[ [40])\\] (i.e., the training epoch is one where inference is conducted immediately for each sample). More details are included in the appendix.\n\n### 4.2 Overall Results\n\nAs shown in Table [1]Table 1 ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"), our CoMAC achieves SOTA performance on the average mIoU of all sequences for both benchmarks. Specifically, the proposed CoMAC significantly outperforms previous methods by more than 6.9%percent6.96.9\\\\% on S-to-S and 1.9%percent1.91.9\\\\% on S-to-W, which justifies the effectiveness of our method. It can also be observed that most TTA methods (TENT \\[ [18])\\] and LAME \\[ [3])\\]) are outperformed by CTTA methods, which reveals the importance of avoiding catastrophic forgetting.\nAdditionally, previous MM-TTA (i.e., xMUDA and MMTTA) methods can not consistently outperform previous single-modal methods (e.g., EATA \\[ [32])\\]), which suggests the sensitivity of multi-modal collaboration toward continual domain shifts. In fact, by intuitively utilizing model-based stochastic restoration, MMTTA-rs can achieve a noticeable improvement of 3.1%percent3.13.1\\\\% and 6.0%percent6.06.0\\\\% on S-to-S and S-to-W, respectively. Yet MMTTA-rs is still outperformed by our method. To justify the effect of the sequence arrangement, we conduct additional experiments by reversing the sequences of S-to-S and S-to-W for TENT, MMTTA-rs, and our CoMAC. While the performance of all methods decreases, the improvement of CoMAC compared to others can be observed across all sequences.\n\nFor S-to-S, we notice that our method achieves the second-best performance at the first sequence 01-Spring and then surpasses all previous methods in the following sequences since we utilize CMQs to gradually adapt to the changing target domain without forgetting. Compared with TTA methods, our method consistently prevails with an increasing gap as they struggle with error accumulation. A similar observation can be found at D-O-2 of S-to-W. Interestingly, xMUDA-pl as well as Pslabel perform competitively on S-to-W and outperform CoMAC in D-P-2 mainly because is less challenging and simply filtering pseudo-labels can effectively mitigate the prediction noise. Nevertheless, this performance gap is trivial as our CoMAC surpasses both xMUDA-pl and Pslabel on all other sequences.\n\n![Refer to caption]Figure 4: Visualization of online segmentation results. Here we present the cross-modal pseudo-labels from xMPF (Ours) as well as the individual prediction from 2D and 3D teachers in comparison with the ground truth (GT).\n\n### 4.3 Ablation Studies\n\nIn this section, we provide our ablation studies on S-to-S to justify our design of CoMAC.\n\nUtilization of raw and augmented input. In Sec. [3.2]Intra-Modal Prediction Aggregation ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"), a key hypothesis is that while the augmentation-average prediction can be a potential reliable alternative, it may introduce inductive bias to the result. To justify this assumption, we conduct experiments by simply using the pure raw or augmentation-average prediction as the intra-modal prediction as in Eq. [7]In 3.2 Intra-Modal Prediction Aggregation ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"). As shown in Fig. [3]Figure 3 ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")(a), both variants achieve inferior performance compared to CoMAC and these performance gaps are consistent across most sequences. Specifically, using pure augmentation-average predictions lead to serious degradation of 5.8%percent5.85.8\\\\%, which justifies the necessity of mitigating the inductive noise brought by test-time augmentations and our motivation for iMPA.\n\nWeighting mechanisms of iMPA and xMPF. The proposed iMPA and xMPF utilize centroid-based weighting mechanisms to attend to the reliable modality. To justify their effectiveness, we compared CoMAC with variants by replacing either Eq. [7]In 3.2 Intra-Modal Prediction Aggregation ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\") or Eq. [8]In 3.3 Inter-Modal Pseudo-Label Fusion ‚Ä£ 3 Proposed Method ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\") with a simple average fusion (indicated as w/o iMPA and w/o xMPF). As presented in Fig. [3]Figure 3 ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")(b), CoMAC outperforms both variants by more than 2.5%percent2.52.5\\\\%. This performance gap justifies that both iMPA and xMPF play an important part in noise suppression.\n\nUpdating mechanisms of CMQs. The goal of CMQs is to achieve a good balance between adaptation and knowledge preservation. To justify the role of CMQs, we compared CoMAC with variants without enqueuing target features or restoring pseudo-source features, respectively. For the variant without enqueuing target features, the corresponding class-wise centroids are identical to the source centroids across the whole testing process. As in Fig. [3]Figure 3 ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\")(c), disabling enqueuing target features (w/o Update) causes a significant performance decrease of 6.1%percent6.16.1\\\\%, which justifies the necessity of adapting class-wise centroids for the validity of iMPA and xMPF. On the other hand, while disabling restoring pseudo-source features (w/o Restore) leads to a quicker adaptation at the first two sequences, it eventually causes catastrophic forgetting after the third sequence, resulting in a noticeable gap of 8.4%percent8.48.4\\\\%. Overall, the performance gain brought by CMQs justifies their effectiveness.\n\n| CoMAC | No. of 2D Aug |\n| --- | --- |\n|  | 1 | 2 | 3 | 4 | 5 | Avg |\n| --- | --- | --- | --- | --- | --- | --- |\n| No. of3D Aug | 1 | 33.0 | 33.1 | 33.2 | 33.2 | 33.3 | 33.2 |\n|  | 2 | 34.1 | 34.2 | 34.3 | 34.4 | 34.4 | 34.3 |\n|  | 3 | 35.2 | 35.2 | 35.4 | 35.3 | 35.5 | 35.3 |\n|  | 4 | 36.4 | 36.4 | 36.5 | 36.5 | 36.5 | 36.5 |\n|  | 5 | 36.4 | 36.5 | 36.7 | 36.6 | 36.7 | 36.6 |\n|  | Avg | 35.0 | 35.1 | 35.2 | 35.2 | 35.3 | 35.2 |\n\nTable 2: Augmentation analysis of CoMAC. CoMAC is evaluated with different numbers of augmentations.\n\n| CoMAC | pr‚Äãssubscriptùëùùëüùë†p\\_{rs} | (œÑc‚Äãf,Œªc‚Äãt‚Äãs)subscriptùúèùëêùëìsubscriptùúÜùëêùë°ùë†(\\\\tau\\_{cf},\\\\lambda\\_{cts}) | Avg | œÑc‚Äãfsubscriptùúèùëêùëì\\\\tau\\_{cf} | (pr‚Äãs,Œªc‚Äãt‚Äãs)subscriptùëùùëüùë†subscriptùúÜùëêùë°ùë†(p\\_{rs},\\\\lambda\\_{cts}) | Avg | Œªc‚Äãt‚ÄãssubscriptùúÜùëêùë°ùë†\\\\lambda\\_{cts} | (pr‚Äãs,œÑc‚Äãf)subscriptùëùùëüùë†subscriptùúèùëêùëì(p\\_{rs},\\\\tau\\_{cf}) | Avg |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| 0.5 | (0.8, 1.0) | 36.6 | 0.8 | (0.5, 1.0) | 36.6 | 1.0 | (0.5, 0.8) | 36.6 |\n| 0.3 | - | 34.5 | 0.0 | - | 34.8 | 0.0 | - | 35.8 |\n| 0.7 | - | 36.4 | 0.5 | - | 36.5 | 0.01 | - | 36.4 |\n| 1.0 | - | 36.3 | 0.9 | - | 36.4 | 0.1 | - | 36.4 |\n\nTable 3: Sensitivity analysis of CoMAC. Here ‚ÄúxM‚Äù is the softmax-average of 2D and 3D predictions. The parameter value with ‚Äú-‚Äù indicates the same value as default settings.\n\nNumber of Augmentations. To investigate the effect of augmentations, we conduct a grid search by utilizing different numbers of 2D and 3D augmentations. Specifically, we adopt resize and rotation as 2D and 3D augmentation, respectively. The factor range for 2D scaling is \\[0.5,1)0.51\\[0.5,1) while 3D one is set to (0‚àò,360‚àò)superscript0superscript360(0^{\\\\circ},360^{\\\\circ}), where the list of augmentations is computed as evenly spaced factors given the number of augmentations. As shown in Table [2]Table 2 ‚Ä£ 4.3 Ablation Studies ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"), increasing the number of either 2D or 3D augmentations leads to performance improvement, while the 2D improvement is less noticeable compared to 3D probably due to the inductive bias brought by 2D augmentations. While all settings perform competitively, we adopt the combination of three 2D augmentations and five 3D augmentations to achieve the best result.\\\n\\\nSensitivity analysis. We perform sensitivity analysis over the hyper-parameters of CoMAC as shown in Table [3]Table 3 ‚Ä£ 4.3 Ablation Studies ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"). There are some extreme cases that can lead to the performance degeneration of CoMAC. For restoring rate pr‚Äãssubscriptùëùùëüùë†p\\_{rs}, the performance relatively drops about 5.7%percent5.75.7\\\\% when pr‚Äãs=0.3subscriptùëùùëüùë†0.3p\\_{rs}=0.3, indicating the restoring rate is too low to prevent forgetting. Nevertheless, when pr‚Äãs‚â•0.5subscriptùëùùëüùë†0.5p\\_{rs}\\\\geq 0.5, CoMAC is robust to the arbitrary choice of pr‚Äãssubscriptùëùùëüùë†p\\_{rs}. Similar observations can be found when œÑc‚Äãf=0.0subscriptùúèùëêùëì0.0\\\\tau\\_{cf}=0.0 or Œªc‚Äãt‚Äãs=0.0subscriptùúÜùëêùë°ùë†0.0\\\\lambda\\_{cts}=0.0, where the performance decreases relatively by 4.9%percent4.94.9\\\\% and 2.2%percent2.22.2\\\\%. This performance degeneration indicates the importance of confident feature filtering and class-wise contrastive loss. Overall, when œÑc‚Äãf‚â•0.0subscriptùúèùëêùëì0.0\\\\tau\\_{cf}\\\\geq 0.0 and Œªc‚Äãt‚Äãs‚â•0.01subscriptùúÜùëêùë°ùë†0.01\\\\lambda\\_{cts}\\\\geq 0.01, the performance of CoMAC is also robust to the hyper-parameter settings, falling into a relative margin of 0.5%percent0.50.5\\\\%. Note that all settings of CoMAC surpass the previous SOTA method EATA \\[ [32])\\] by more than 4.8%percent4.84.8\\\\%.\\\n\\\nVisualization of segmentation. To further justify the effectiveness of our proposed CoMAC, we provide some visualization results as shown in Fig. [4]Figure 4 ‚Ä£ 4.2 Overall Results ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"). Specifically, we visualize the 2D and 3D predictions from teacher models and our cross-modal pseudo-labels from xMPF. Compared to single-modal predictions, our cross-modal pseudo-labels can achieve better segmentation results by attending to the reliable modality, such as the first row in Fig. [4]Figure 4 ‚Ä£ 4.2 Overall Results ‚Ä£ 4 Experiments ‚Ä£ Multi-Modal Continual Test-Time Adaptation for 3D Semantic Segmentation\"), where the sidewalk prediction attends more to the 2D image while the car prediction attends to the reliable 3D point cloud.\\\n\\",
            "citations": null
          },
          "5 Conclusion\\": {
            "content": "\\\nIn this paper, we present a new task, named multi-modal continual test-time adaptation (MM-CTTA) for 3D semantic segmentation. We further propose a novel method called CoMAC that tackles MM-CTTA from two perspectives. On one hand, reliable cross-modal pseudo-labels are generated by iMPA and xMPF by adaptively attending to the more reliable modality in a dual-stage manner. On the other hand, CMQs are proposed to leverage pseudo-source features and reliable target features to perform adaptation without catastrophic forgetting. We introduce two new benchmarks for MM-CTTA and our methods outperform previous works by a noticeable margin in both benchmarks. In the future, we hope both our method and benchmarks can facilitate the exploration of MM-CTTA and promote the development of reliable multi-modal systems in altering environments.\\\n\\",
            "citations": null
          }
        },
        "abstract": "Continual Test-Time Adaptation (CTTA) generalizes conventional Test-Time\nAdaptation (TTA) by assuming that the target domain is dynamic over time rather\nthan stationary. In this paper, we explore Multi-Modal Continual Test-Time\nAdaptation (MM-CTTA) as a new extension of CTTA for 3D semantic segmentation.\nThe key to MM-CTTA is to adaptively attend to the reliable modality while\navoiding catastrophic forgetting during continual domain shifts, which is out\nof the capability of previous TTA or CTTA methods. To fulfill this gap, we\npropose an MM-CTTA method called Continual Cross-Modal Adaptive Clustering\n(CoMAC) that addresses this task from two perspectives. On one hand, we propose\nan adaptive dual-stage mechanism to generate reliable cross-modal predictions\nby attending to the reliable modality based on the class-wise feature-centroid\ndistance in the latent space. On the other hand, to perform test-time\nadaptation without catastrophic forgetting, we design class-wise momentum\nqueues that capture confident target features for adaptation while\nstochastically restoring pseudo-source features to revisit source knowledge. We\nfurther introduce two new benchmarks to facilitate the exploration of MM-CTTA\nin the future. Our experimental results show that our method achieves\nstate-of-the-art performance on both benchmarks."
      },
      "bib.bib5": {
        "id": "bib.bib5",
        "citation": "Changpinyo et al. (2021)",
        "authors": "",
        "year": "",
        "title": "Conceptual 12m: Pushing web-scale image-text pre-training to recognize long-tail visual concepts.",
        "venue": "CVPR",
        "pages": "",
        "url": "",
        "arxiv_id": "2102.08981",
        "doi": null,
        "sections": {
          "1 Introduction": {
            "content": "Transfer learning using pre-training and fine-tuning has become a prevalent paradigm in computer vision, natural language processing, and vision-and-language (V+L) research. It has been shown, for instance, that V+L pre-training leads to transferrable joint representations that benefit multiple downstream V+L tasks, including visual question answering, image and text retrieval, and referring expression comprehension \\[ [55]), [49]), [21]), [77]), [3]), [74]), [88]), [48]), [56])\\].\n\nWhat makes V+L pre-training successful? On one hand, this is due to advances in architectures and modeling that are mainly inspired by BERT and similar models in natural language understanding and generation \\[ [25]), [53]), [82]), [46]), [26]), [66])\\].\nIn particular, the idea of using flexible self-attention mechanisms via high-capacity multi-layer Transformers \\[ [78])\\], in combination with self-supervised learning objectives such as masked language modeling \\[ [25])\\], has proven to be effective and widely applicable. On the other hand, the availability of large-scale labeled and weakly-labeled data in the V+L domain \\[ [61]), [20]), [43]), [70])\\] is truly what enables such models to learn associations between the two modalities.\n\nIn _either_ vision _or_ language community, one notable trend is that scaling up training data is useful.\nIn contrast, datasets in V+L research remain relatively limited in terms of scale and diversity.\nThe capability of JFT-300M \\[ [76])\\] and Instagram \\[ [58])\\] over orders-of-magnitude smaller ImageNet \\[ [69])\\] has been put to test on multiple downstream image classification and object detection tasks.\nIn NLP, the size of pre-training data sources for training deep language models rose from the 20GB BooksCorpus \\[ [90])\\]+English Wikipedia in BERT\\[ [25])\\], to the 570GB dataset in GPT-3 \\[ [12])\\] and the 745GB C4 dataset in T5 \\[ [66])\\].\n\nIn contrast, V+L datasets are limited in two ways. First, the _effective_ sizes of popular V+L datasets are low. The number of images in these datasets range from fewer than a few hundred thousands \\[ [84]), [20]), [44]), [28])\\] to several millions \\[ [70])\\], with lower text quality as the scale increases.\nSecond, many of the small-sized datasets share the same, limited visual domain; COCO-Captions \\[ [20])\\], Visual Genome \\[ [44])\\], and VQA2 \\[ [27])\\] are (mostly) based on several hundreds thousand of COCO images \\[ [52])\\].\nThe lack in scale and diversity of visual concepts (with respect to vision/language-only counterparts) makes it hard for V+L models to perform adequately in the wild.\n\nOne major reason for these gaps is the difficulty in collecting such datasets. Unlike in image classification, ‚Äútext‚Äù in V+L datasets is longer and less likely to be agreed upon, making the annotation process more costly and time-consuming. One approach to remedy this is to make use of large amounts of the alt-texts accompanying images on the Web. For instance, Sharma et al. introduced Conceptual Captions (CC3M) \\[ [70])\\], a dataset of 3.3M ‚ü®‚ü®\\\\langleimage, caption‚ü©‚ü©\\\\rangle pairs that result from a filtering and postprocessing pipeline of those alt-texts. Despite being automatically collected, CC3M is shown to be effective in both image captioning in the wild \\[ [70]), [19])\\] and V+L pre-training \\[ [55]), [49]), [21]), [77]), [3]), [74]), [88]), [48]), [56])\\]. In other words, it provides a promising start for large-scale V+L annotations.\n\nIn this paper, we explore pushing the limits of V+L data using this approach.\nOur key insight is that specific downstream V+L tasks (e.g., VQA, image captioning) can be overly restrictive if the goal is to collect large-scale V+L annotations.\nFor instance, CC3M was collected to favor high-precision texts that are fit for the downstream task of image captioning.\nYet, we have witnessed this dataset being increasingly adopted for V+L\npre-training \\[ [55]), [21]), [3]), [74]), [88]), [48]), [56])\\],\narguably beyond its original purpose.\n\nWe hypothesize that the V+L field could benefit from such an insight, and therefore we introduce Conceptual 12M (CC12M), a high(er)-recall V+L dataset for the purpose of V+L pre-training.\nBy relaxing multiple image and text filters used in CC3M, we obtain a less precise but 4x larger V+L set of ‚ü®‚ü®\\\\langleimage, text‚ü©‚ü©\\\\rangle pairs. We perform an analysis of this dataset and show that it covers a wider range of visual concepts.\n\nWe test our hypothesis by benchmarking the effectiveness of CC12M as a pre-training data source on several V+L tasks, in comparison to CC3M. We explore two main pre-training strategies (and more in the Supplementary material): one for vision-to-language generation and the other for vision-and-language matching. Our experiments indicate that scaling up pre-training V+L has a dramatic positive effect on image captioning, novel object captioning, and (zero-shot) image retrieval.\n\nIn summary, our main contributions are:\n\n1. (a)\n\n\nA public larger-scale V+L pre-training dataset that covers a much wider range of concepts than existing ones.\n\n2. (b)\n\n\nEvaluation on downstream vision-to-language generation and vision-and-language matching with an emphasis on long-tail recognition that consistently shows the superiority of this dataset over CC3M.\n\n3. (c)\n\n\nState-of-the-art results on the nocaps (novel object captioning) and Conceptual Captions benchmarks.",
            "citations": null
          },
          "2 Vision-and-Language Pre-Training Data": {
            "content": "We first review the data collection pipeline for the Conceptual Captions 3M (CC3M) outlined in Sect. 3 of \\[ [70])\\], which we followed closely. We then describe a series of relaxation and simplification to the pipeline that results in CC12M, a much larger set of image-text pairs. Finally, we perform an analysis of CC12M in comparison with CC3M and other existing V+L datasets.\n\n### 2.1 Conceptual Captions 3M: Pipeline for extracting and cleaning Image Alt-Text from the Web\n\nThe Conceptual Captions dataset consists of about 3.3M Web images and their corresponding cleaned, hypernymized Alt-texts \\[ [70])\\].\nThis approach leverages a promising source of (weak) supervision for learning correspondance between visual and linguistic concepts:\nonce the pipeline is established, the data collection requires no additional human intervention.\nIt consists of the following 4 steps:\n(i) image-based filtering based on size, aspect ratio, encoding format and offensive content,\n(ii) text-based filtering based on language, captialization, token frequency, pre-defined unwanted phrases, as well as part-of-speech (POS), sentiment/polarity, and adult content detection (using Google Cloud Natural Language APIs),\n(iii) image-text‚Äìbased filtering based on the number of image tags (as predicted by Google Cloud Vision APIs) that overlap with the existing text,\n(iv) text transformations, most notably hypernymization of named entities, including proper names of persons, organizations and locations (e.g., both ‚ÄúHarrison Ford‚Äù and ‚ÄúCalista Flockhart‚Äù are replaced by ‚Äúactor‚Äù), deletion of time-related spans, and digit replacement (using # as a digit abstraction).\n\nThe large scale nature and the high degree of textual and visual diversity make this dataset particularly suited to V+L pre-training \\[ [55]), [21]), [74]), [88]), [48]), [56])\\].\n\n### 2.2 CC12M: Relaxing filters for higher recall\n\nConceptual Captions has been created to work out-of-the-box for training image captioning models, and thus it involves substantial image, text, and image-text filtering and processing to obtain clean, high-precision captions.\nAs a result, this approach comes at the cost of low recall (many potentially useful ‚ü®‚ü®\\\\langleimage, Alt-text‚ü©‚ü©\\\\rangle pairs are discarded).\nHowever, this trade-off may not be optimal if the dataset is to be used primarily for V+L pre-training.\nMotivated by this, we follow a similar procedure as the one described in \\[ [70])\\] but relax some of its filters, and construct the dataset called Conceptual 12M (CC12M), as detailed below.\n\nFiltering.\nAs described above, the construction of CC3M used three main filtering types \\[ [70])\\]: image-based, text-based, and image-text‚Äìbased.\nTo arrive at CC12M, we keep the image-text filtering intact, and relax the unimodal filters only.\nFirst, for image-based filtering, we set the maximum ratio of larger to smaller dimension to 2.5 instead of 2.\nWe still keep only JPEG images with size greater than 400 pixels, and still exclude images that trigger pornography detectors.\nSecond, in text-based filtering, we allow text between 3 and 256 words in the alt-text.\nWe still discard candidates with no noun or no determiner, but permit ones without prepositions.\nWe discard the heuristics regarding high unique-word ratio covering various POS tags and word capitalization.\nWe set the maximum fraction of word repetition allowed to 0.2.\nGiven a larger pool of text due to the above relaxations, the threshold for counting a word type as rare is increased from 5 to 20.\n\nText transformation.\nThe main motivation for CC3M to perform text transformation is that a majority of candidate captions contain ultrafine-grained entities such as proper names (people, venues, locations, etc.), making it extremely difficult to learn as part of the image captioning task.\nIn contrast, we are not restricted by the end task of image caption generation. Our intuition is that relatively more difficult pre-training data would lead to better transferability.\nWe thus do not perform hypernimization or digit substitution as in \\[ [70])\\].\nThe only exception to the ‚Äúkeep alt-texts as raw as possible‚Äù rule is performing person-name substitutions, which we identify as necessary to protect the privacy of the individuals in these images.\nFor this step, we use the Google Cloud Natural Language APIs to detect all named entities of type Person, and substitute them by a special token ‚ü®‚ü®\\\\langlePERSON‚ü©‚ü©\\\\rangle.\nAround 25% of all the alt-texts in CC12M are transformed in this fashion.\n\n![Refer to caption]\n\n![Refer to caption]\n\nFigure 2: Word clouds of top 100 tokens in CC3M (the top cloud) and in CC12M (the bottom cloud).\n\n| Dataset | \\# examples | token/type | caption length |\n| --- | --- | --- | --- |\n| CC3M train | 3,318,333 | 804.8 | 10.3 ¬±plus-or-minus\\\\pm 4.5 |\n| CC12M | 12,423,374 | 370.0 | 20.2 ¬±plus-or-minus\\\\pm 16.3 |\n\nTable 1: Basic statistics of CC12M vs. CC3M\n\n### 2.3 Characteristics of CC12M\n\nWe provide an analysis of CC12M along multiple dimensions, focusing on comparing it to the most relevant CC3M. Additional analyses are in the supplementary material.\n\nBasic statistics.\nAs seen in Table [1]Table 1 ‚Ä£ 2.2 CC12M: Relaxing filters for higher recall ‚Ä£ 2 Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\"),\nCC12M consists of 12.4M image-text pairs222Extracted as of May 2020., about 4x larger than CC3M.\nIt has a much lower token (word count) to type (vocab size) ratio, indicating a longer-tail distribution and a higher diversity degree of the concepts captured.\nLastly, the average caption length of CC12M is much longer.\nThis is overall achieved by our relaxation of the filters, especially the text one.\n\nQuality.\nWe compute a rough estimate of precision on 100 examples by asking two annotators to rate how well the given alt-text fits the image on a 1‚Äì5 scale: 1 (no fit), 2 (barely fit), 3 (somewhat), 4 (good fit, but disfluent language), 5 (perfect).\nWe define precision as the fraction of captions with a score 4 or above. We see a drop in precision, 76.6% vs. 90.3% as reported for CC3M (Table 2 in \\[ [70])\\]).\nThis analysis points to the precision/recall tradeoff in transitioning from CC3M to CC12M.\nFig. [1]Figure 1 ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\") illustrates such a tradeoff: the ‚Äújellyfish‚Äù example would have been filtered out from CC3M (due to a high percentage of nouns and a lack of proprositions), but it is included in CC12M.\n\nVisual concept distribution.\nWe use the caption text tokens to represent the visual concepts. The long tail of visual concepts that emerge in CC12M spans many categories, and can be attributed to\n(1) a dramatic increase in scale, and\n(2) the absence of fine-grained entity hypernymization.\nWe list some of them here to illustrate this point, in the format of ‚Äú‚ü®‚ü®\\\\langleword‚ü©‚ü©\\\\rangle‚ü®‚ü®\\\\langlefrequency in CC3M‚ü©‚ü©\\\\rangle‚Üíabsent‚Üí\\\\xrightarrow{}‚ü®‚ü®\\\\langlefrequency in CC12M‚ü©‚ü©\\\\rangle‚Äù:\nluffy 0 ‚Üíabsent‚Üí\\\\xrightarrow{} 152,\nmangosteen 0 ‚Üíabsent‚Üí\\\\xrightarrow{} 212,\nzanzibar 0 ‚Üíabsent‚Üí\\\\xrightarrow{} 1138,\nsumo 1 ‚Üíabsent‚Üí\\\\xrightarrow{} 661,\npokemon 1 ‚Üíabsent‚Üí\\\\xrightarrow{} 8615,\nchevrolet 1 ‚Üíabsent‚Üí\\\\xrightarrow{} 12181,\nmehndi 3 ‚Üíabsent‚Üí\\\\xrightarrow{} 9218,\npooh 4 ‚Üíabsent‚Üí\\\\xrightarrow{} 7286,\ncyberpunk 5 ‚Üíabsent‚Üí\\\\xrightarrow{} 5247,\nketo 6 ‚Üíabsent‚Üí\\\\xrightarrow{} 6046,\nhound 9 ‚Üíabsent‚Üí\\\\xrightarrow{} 3392,\nquiche 50 ‚Üíabsent‚Üí\\\\xrightarrow{} 1109,\ndurian 61 ‚Üíabsent‚Üí\\\\xrightarrow{} 552,\njellyfish 456 ‚Üíabsent‚Üí\\\\xrightarrow{} 2901.\n\nWe also visualize the head of the distribution in Fig. [2]Figure 2 ‚Ä£ 2.2 CC12M: Relaxing filters for higher recall ‚Ä£ 2 Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\"). We observe that ‚Äúperson‚Äù becomes much more frequent due to person substitution with the token ‚Äú‚ü®‚ü®\\\\langlePERSON‚ü©‚ü©\\\\rangle‚Äù. Moreover, there are fewer ‚Äúactor‚Äù, ‚Äúartist‚Äù, ‚Äú(football) player‚Äù, as a result of removing hypernymization.\n\nFinally, we inspect tokens that are unseen in CC3M. We observe that these tokens may occur very frequently in CC12M if they are fine-grained instances such as locations (‚Äúfrance,‚Äù ‚Äúafrica,‚Äù ‚Äúdc,‚Äù ‚Äútoronto‚Äù) or digits (‚Äú2019‚Äù, ‚Äú10‚Äù, ‚Äú2018‚Äù, ‚Äú2020‚Äù).\nThis is due to the removal of hypernymization and the dropping of time-related span deletion.\n\nBiases.\nWe study the context in which several sensitive terms related to gender, age, race, ethnicity appear such as ‚Äúblack‚Äù/‚Äúwhite‚Äù/‚Äúasian‚Äù/‚Äúafrican‚Äù/‚Äúindian‚Äù, ‚Äúman‚Äù/‚Äùwoman‚Äù, ‚Äúyoung‚Äù/‚Äúold‚Äù, etc. We observe no large biases in the distribution of these terms, either in terms of co-occurrence between sensitive term pairs or with other tokens.\nFurthermore, we check the distribution of web domains and, similar to visual concepts, we find this to be diverse and long-tail: >>100K with >>40K contributing >>10 samples. We take our preliminary study as a positive indication of no severe biases stemming from particular domains or communities. Finally, we provide a Broader Impact statement in the supplementary material.\n\n![Refer to caption]Figure 3: Main Pre-Training Tasks: image captioning (vision-to-language generation) and visual-linguistic matching (vision-and-language understanding).\n\n| Downstream | Downstream datasets |\n| task | Train | Eval |\n| Novel object captioning | COCO Captions | nocaps |\n| Novel object captioning | LocNar COCO | LocNar OID |\n| Image captioning | CC3M |\n| Zero-shot IR | None | Flickr30K |\n| IR | Flickr30K |\n| IR | LocNar Flickr30K |\n\nTable 2: Generation (top) and matching (bottom) tasks and datasets considered in this paper. IR = Image Retrieval.",
            "citations": null
          },
          "3 Evaluating Vision-and-Language Pre-Training Data": {
            "content": "The previous section describes CC3M and our CC12M. In this section, we evaluate both datasets on their ability to benefit V+L downstream tasks, measuring the impact from visual grounding produced under the two settings. For the sake of comparison, we do not include the images that appear in CC3M in CC12M in our experiments.\n\nWe focus on the two most fundamental V+L tasks: vision-to-language generation and vision-and-language matching. In both cases, our emphasis is on\n(i) the simplest setting in which the learning objectives during pre-training and downstream tasks match, and\n(ii) long-tail recognition and out-of-distribution generalization, as we believe this is where pre-training has the most impact. Fig. [3]Figure 3 ‚Ä£ 2.3 Characteristics of CC12M ‚Ä£ 2 Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\") and Table [2]Table 2 ‚Ä£ 2.3 Characteristics of CC12M ‚Ä£ 2 Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\") summarize our experimental setup, in terms of the downstream tasks and the fine-tuning and evaluation datasets.\n\n### 3.1 Vision-to-Language Generation\n\n#### 3.1.1 Pre-Training Tasks\n\nWe use image captioning (ic) as the pre-training task.\nThe task is to predict the target caption given image features.\nTo train the model parameters, we use the standard cross entropy loss given the groundtruth caption.\n\nNote that there exist vision-to-language generation pre-training strategies that are different from ours.\nFor instance, Zhou et al. \\[ [88])\\] adapt BERT \\[ [25])\\] to generate text. As masked language modeling is used for pre-training, there is no decoder and, at inference time, text is generated using the encoder network one token at a time, appending the mask token to the image and the text generated so far. Thus, this approach is inefficient as the number of passes over the input image is linear in the desired caption length. It is also unclear how to incorporate advanced decoding schemes such as beam search, top-k sampling, or nucleus sampling (see, e.g., \\[ [31])\\]) with such an approach.\nFinally, our experiments (see Supplementary material) suggest that the ic pre-training task is superior to its masked variants and justify using the simple ic learning objective.\n\n#### 3.1.2 Downstream Tasks\n\nOur downstream tasks are selected to measure progress toward solving image captioning in the wild.\nThey also stand to benefit from visual grounding, especially since pre-training, by definition, is expected to cover a wider range of (long-tail) visual concepts than fine-tuning datasets.\n\nnocaps \\[ [2])\\] is a recent object-captioning-at-scale benchmark consisting of 4,500 validation and 10,600 test images with 10 hidden reference captions.\nUnlike in the standard image captioning setting, nocaps‚Äôs distributions of images during training (COCO Captions) and evaluation (Open Images) are different: the Open Images dataset \\[ [45]), [42])\\] covers one order of magnitude more objects (600 classes) than COCO \\[ [52])\\] (80 classes).\nThis discrepancy defines the challenge: solutions must be able to learn to describe novel concepts from sources external to the COCO training set, such as text corpora, knowledge bases, or object detection datasets.\nIn the Supplementary material, we provide details on the nocapsleaderboard. In addition, besides CC3M and CC12M, we also explore using the Open Images Localized Narratives dataset (LocNar) \\[ [64])\\], as an alternative ‚Äúin-domain‚Äù (from a visual standpoint) pre-training data source.\n\nLocalized Narratives (LocNar) \\[ [64])\\] is a collection of datasets with images that are paired with captions obtained by converting speech to text via ASR and manual post-processing it333This dataset also contains mouse traces synchronized with the text, but we do not use the traces here.. Inspired by the setting in nocaps, we use the COCO\\[ [52])\\] portion (train split of around 130K images) for training/fine-tuning, and Open Images \\[ [45])\\] portion of evaluation (val split of around 40K images).\nNote that the LocNar captions are much longer than standard captioning datasets (41.8 words/caption), setting it apart from nocaps.\n\nConceptual Captions 3M \\[ [70])\\] is our main reference for V+L pre-training data source.\nAt the same time, the image captioning task on this dataset itself is a valuable benchmark for vision-to-language generation in the wild. Thus, we adopt it as a downstream task for CC12M.\nThis means that, in the case of CC3M, from-scratch and pre-training settings collapse.\n\nEvaluation metrics.\nTo measure the performance on image caption generation, we consider the standard metrics BLEU-1,4 \\[ [62])\\], ROUGE-L \\[ [51])\\], METEOR \\[ [10])\\], CIDEr-D\\[ [79])\\], and SPICE \\[ [4])\\].\n\n### 3.2 Vision-and-Language Matching\n\n#### 3.2.1 Pre-training Tasks\n\nIn visual-linguistic matching (vlm), the task takes as input both image and text features and predicts whether the input image and text are matched.\nTo train the model‚Äôs parameters, we use a contrastive softmax loss, for which the original image-text pairs are used as positive examples, while all other image-text pairs in the mini-batch are used as negative examples \\[ [55]), [77])\\].\n\n#### 3.2.2 Downstream Tasks\n\nThe task of caption-based image retrieval (IR) is to identify a relevant image from a pool given a caption describing its content.\nThe Flickr30K dataset \\[ [63])\\] consists of 31,000 images from Flickr, each associated with five captions.\nFollowing existing work \\[ [47]), [55])\\], we use 1,000 images for validation, 1,000 images for testing, and use the rest of image-text pairs for model training.\n\nWe further consider zero-shot caption-based image retrieval\\[ [55])\\] on the Flickr30K dataset.\nThe term ‚Äúzero-shot‚Äù refers to the setting in which we discard training data and apply pre-trained models ‚Äúas-is‚Äù, i.e., without fine-tuning on the target task.\n\nFinally, we further evaluate our retrieval system on the Localized Narratives dataset \\[ [64])\\] (see Sect. [3.1.2]Downstream Tasks ‚Ä£ 3.1 Vision-to-Language Generation ‚Ä£ 3 Evaluating Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\")). We use the LocNar Flickr30K portion (train split of 30,546 images, and test split of 1000 images) for training and evaluation.\n\nEvaluation metrics.\nTo measure the performance on image retrieval, we consider the standard metrics Recall@1 (R1), Recall@5 (R5), and Recall@10 (R10).\n\n| Pretraining | Train or | nocaps val |\n| data | finetune on | in-domain | near-domain | out-of-domain | overall |\n|  | coco cap? | CIDEr | SPICE | CIDEr | SPICE | CIDEr | SPICE | BLEU1 | BLEU4 | METEOR | ROUGE | CIDEr | SPICE |\n| None | ‚úì | 72.8 | 11.1 | 57.1 | 10.2 | 34.1 | 8.3 | 69.8 | 14.5 | 21.9 | 47.9 | 54.7 | 10.0 |\n| CC3M |  | 29.2 | 7.4 | 27.5 | 6.9 | 37.3 | 7.4 | 36.0 | 2.8 | 12.6 | 29.1 | 29.7 | 7.1 |\n| CC12M |  | 20.7 | 6.9 | 24.1 | 6.9 | 41.6 | 8.0 | 31.8 | 2.9 | 12.1 | 26.8 | 27.1 | 7.2 |\n| CC3M | ‚úì | 81.8 | 11.6 | 73.7 | 11.1 | 65.3 | 10.1 | 74.6 | 19.1 | 24.1 | 51.5 | 73.2 | 11.0 |\n| CC12M | ‚úì | 88.3 | 12.3 | 86.0 | 11.8 | 91.3 | 11.2 | 78.5 | 23.4 | 25.9 | 54.5 | 87.4 | 11.8 |\n| CC3M+CC12M | ‚úì | 92.6 | 12.5 | 88.3 | 12.1 | 94.5 | 11.9 | 79.2 | 24.4 | 26.1 | 55.1 | 90.2 | 12.1 |\n\nTable 3: Automatic metric scores on the nocaps val set: performance of from-scratch (Row 1), pre-trained (Rows 2-3), and fine-tuned (Rows 4-5) models. CC12M outperforms CC3M by a large margin after fine-tuning (Row 4 vs. 5). Together, they achieve a new best, surpassing 90 CIDEr points on nocaps val. Bold indicates best-to-date, underline indicates second-best.\n\n![Refer to caption]\n\n![Refer to caption]\n\n![Refer to caption]\n\nFigure 4: Qualitative results on nocaps. Each example comes with a caption predicted by the model that is trained on COCO Captions without pre-training (very top, right under the image), as well as captions predicted by models pre-trained on CC3M (middle) and CC12M (bottom), where the left/right column indicates if the model is fine-tuned on COCO Captions.\n\n### 3.3 Implementation Details\n\nRepresenting images and texts.\nWe use Graph-RISE \\[ [37]), [38])\\] to featurize the entire image.\nWe train a Faster-RCNN \\[ [68])\\] on Visual Genome \\[ [43])\\], with a ResNet101 \\[ [29])\\] backbone trained on JFT \\[ [30])\\] and fine-tuned on ImageNet \\[ [69])\\].\nWe select top-16 box proposals and featurize each of them with Graph-RISE, similar to \\[ [19])\\].\nInspired by \\[ [50])\\], we obtain up to 16 image tags from the Google Cloud Vision APIs, and treat them as text inputs to our model. These global, regional, and tag features end up being represented as a bag of 1+16+16 vectors, serving as bottom-up features \\[ [7])\\] for our model.\n\nModel and Learning.\nFor ic-based pre-training and downstream tasks, we follow the state-of-the-art architecture that heavily rely on self-attention \\[ [78])\\] or similar mechanisms \\[ [70]), [85]), [19]), [33]), [23])\\]. We implement a Transformer-based encoder-decoder model, using \\[ [19])\\] as a starting point.\nIn addition, we encode each feature vector with a deeper embedding layer and apply layer normalization \\[ [9])\\].\nFollowing \\[ [55])\\], we encode the corners and the area of bounding boxes and apply layer normalization when combining geometric and regional semantic features.\nThese modifications lead to an improved CIDEr score of 100.9 on the CC3M dev benchmark (Table [7]Table 7 ‚Ä£ 3.3 Implementation Details ‚Ä£ 3 Evaluating Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\")), vs. 93.7 as reported by \\[ [19])\\].\nWe describe additional details in the supplementary material, including infrastructure description, runtime, model size, hyperparameter ranges and tuning methods, and the configuration of the best-performing model.\n\nFor the vlm-based pre-training and downstream tasks, we reuse the architecture above but discard the decoder.\nWe use mean pooling to obtain a fixed-length vector for each modality, and compute the product of the transformed (last-layer Transformer encoder representation) image and the transformed text before applying softmax.\n\n|  | nocaps val |\n| Method | in-domain | near-domain | out-of-domain | overall |\n|  | CIDEr | SPICE | CIDEr | SPICE | CIDEr | SPICE | CIDEr | SPICE |\n| UpDown \\[ [2])\\] | 78.1 | 11.6 | 57.7 | 10.3 | 31.3 | 8.3 | 55.3 | 10.1 |\n| UpDown + CBS \\[ [2])\\] | 80.0 | 12.0 | 73.6 | 11.3 | 66.4 | 9.7 | 73.1 | 11.1 |\n| UpDown + ELMo + CBS \\[ [2])\\] | 79.3 | 12.4 | 73.8 | 11.4 | 71.7 | 9.9 | 74.3 | 11.2 |\n| OscarL\\[ [50])\\] | 79.9 | 12.4 | 68.2 | 11.8 | 45.1 | 9.4 | 65.2 | 11.4 |\n| OscarL \\+ CBS \\[ [50])\\] | 78.8 | 12.2 | 78.9 | 12.1 | 77.4 | 10.5 | 78.6 | 11.8 |\n| OscarL \\+ SCST + CBS \\[ [50])\\] | 85.4 | 11.9 | 84.0 | 11.7 | 80.3 | 10.0 | 83.4 | 11.4 |\n| VIVO \\[ [32])\\] | 88.8 | 12.9 | 83.2 | 12.6 | 71.1 | 10.6 | 81.5 | 12.2 |\n| VIVO + CBS \\[ [32])\\] | 90.4 | 13.0 | 84.9 | 12.5 | 83.0 | 10.7 | 85.3 | 12.2 |\n| VIVO + SCST + CBS \\[ [32])\\] | 92.2 | 12.9 | 87.8 | 12.6 | 87.5 | 11.5 | 88.3 | 12.4 |\n| _pretrain ic on CC12M_ | 88.3 | 12.3 | 86.0 | 11.8 | 91.3 | 11.2 | 87.4 | 11.8 |\n| _pretrain ic on CC3M+CC12M_ | 92.6 | 12.5 | 88.3 | 12.1 | 94.5 | 11.9 | 90.2 | 12.1 |\n| Human | 84.4 | 14.3 | 85.0 | 14.3 | 95.7 | 14.0 | 87.1 | 14.2 |\n|  | nocaps test |\n| UpDown \\[ [2])\\] | 74.3 | 11.5 | 56.9 | 10.3 | 30.1 | 8.1 | 54.3 | 10.1 |\n| UpDown + ELMo + CBS \\[ [2])\\] | 76.0 | 11.8 | 74.2 | 11.5 | 66.7 | 9.7 | 73.1 | 11.2 |\n| VIVO + SCST + CBS \\[ [32])\\] | 89.0 | 12.9 | 87.8 | 12.6 | 80.1 | 11.1 | 86.6 | 12.4 |\n| _pretrain ic on CC12M_ | 82.9 | 11.9 | 85.7 | 12.0 | 85.3 | 11.3 | 85.3 | 11.8 |\n| _pretrain ic on CC3M+CC12M_ | 87.2 | 12.3 | 87.4 | 12.1 | 87.2 | 11.4 | 87.3 | 12.0 |\n| Human | 80.6 | 15.0 | 84.6 | 14.7 | 91.6 | 14.2 | 85.3 | 14.7 |\n\nTable 4: Comparison between our best model (in _italics_, pre-trained on CC12M with ic and fine-tuned on COCO Captions) and existing models, on the nocaps val (top) and test (bottom) splits. Bold indicates best-to-date, underline indicates second-best.\n\n|  | COCO | nocaps |\n| Method | val2017 | val |\n|  | CIDEr | CIDEr |\n| UpDown (reference) | 116.2 | 55.3 |\n| UpDown + CBS | 97.7 | 73.1 |\n| UpDown + ELMo + CBS | 95.4 | 74.3 |\n| _no pretrain (reference)_ | 108.5 | 54.7 |\n| _pretrain ic on CC12M_ (5K) | 108.1 | 87.4 |\n| _pretrain ic on CC12M_ (10K) | 110.9 | 87.1 |\n\nTable 5: Performance on the in-domain COCO Captions val2017 split along with the nocaps val split.\nOur methods are in _italics_ with the number of fine-tuning steps in the parentheses.\n\n|     |     |     |     |\n| --- | --- | --- | --- |\n| Pretraining | Finetuning | LocNar | LocNar |\n| data | data | COCO val | OID val |\n|  |  | CIDEr | CIDEr |\n| None | LocNar COCO | 29.6 | 33.8 |\n| CC3M | LocNar COCO | 29.1 | 35.7 |\n| CC12M | LocNar COCO | 30.0 | 38.6 |\n\nTable 6: Novel object captioning on LocNar.\n\n|  | CC3M | CC3M |\n| Method | dev | test |\n|  | CIDEr | CIDEr |\n| FRCNN \\[ [19])\\] | 89.2 | 94.4 |\n| TTIC+BIU (single model) | - | 98.0 |\n| Ultra \\[ [19])\\] | 93.7 | 98.4 |\n| _no pretrain_ | 100.9 | - |\n| _pretrain ic on CC12M (no ft)_ | 39.3 | - |\n| _pretrain ic on CC12M_ | 105.4 | - |\n\nTable 7: Performance on the Conceptual Captions (CC3M) benchmark. Our methods are in _italics_. ‚Äúft‚Äù stands for fine-tuning. The top two CC3M test CIDEr baseline scores are from the Conceptual Captions Leaderboard as of Nov 15, 2020.",
            "citations": null
          },
          "4 Experimental Results": {
            "content": "### 4.1 Vision-to-Language Generation\n\nTable [3]Table 3 ‚Ä£ 3.2.2 Downstream Tasks ‚Ä£ 3.2 Vision-and-Language Matching ‚Ä£ 3 Evaluating Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\") shows our results on nocaps.\nWe report in Row 1 the performance of our baseline model without pre-training.\nRows 2-3 show the performance of off-the-shelf captioning systems trained on CC3M and CC12M, respectively.\nThis indicates the ‚Äúraw‚Äù power (zero-shot setting) of the pre-trained network in generating captions out of the box.\nWe note that, without fine-tuning on COCO Captions, the model underperforms our baseline numbers on all metrics, which is indicative of the need for the model to learn the COCO captioning style, to which the existing automatic metrics are quite sensitive.\nIn addition, we observe a slightly better performance by CC3M except for BLUE4 and SPICE. This illustrates the benefit of data processing and bias toward high-precision captions present in CC3M.\n\nWith a fine-tuned model, the benefit of transfer learning using pre-training on this task is clear (Row 1 vs. Rows 4,5,6), with CC12M outperforming CC3M by +14.2 CIDEr points and another +2.8 with CC3M+CC12M.\nFig. [4]Figure 4 ‚Ä£ 3.2.2 Downstream Tasks ‚Ä£ 3.2 Vision-and-Language Matching ‚Ä£ 3 Evaluating Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\") illustrates this effect;\nscaling up pre-training data benefits learning multimodal correspondences from a much larger pool of concepts, potentially making the model less susceptible to hallucinations (e.g., guessing ‚Äúmicrophone‚Äù as it has not seen ‚Äúbagpipes‚Äù in the training set), and also more informative (e.g. choosing ‚Äúsumo wrestlers‚Äù over ‚Äúmen‚Äù/‚Äúpeople‚Äù).\n\nTable [4]Table 4 ‚Ä£ 3.3 Implementation Details ‚Ä£ 3 Evaluating Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\") compares our best model (ic pre-trained on CC3M+CC12M) to existing state-of-the-art results on nocaps,\nand show that ours achieves state-of-the-art performance on CIDEr, outperforming a concurrent work \\[ [32])\\] that uses a different pre-training approach _directly on the Open Images dataset, which nocaps is based on._\nImportantly, we observe that the gain in the overall score can be largely attributed to the out-of-domain performance (3rd column). This result indicates that, although the annotation protocol for nocaps uses the priming of annotators to mention one or more of displayed fine-grained ground-truth object classes (e.g., ‚Äúred panda‚Äù) present in the image \\[ [2])\\], the large-scale and natural fine-grainedness of CC12M succeeds in correctly learning to generate captions containing such concepts, in spite of being textually out-of-domain.\n\nFollowing \\[ [2])\\], we also report results of our best model on the COCO Captions val2017 split, see Table [5]Table 5 ‚Ä£ 3.3 Implementation Details ‚Ä£ 3 Evaluating Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\"), with 5K and 10K fine-tuning steps.\nWe note that, since we do not rely on techniques such as constrained beam search (CBS) \\[ [5]), [2])\\] that constrain the model outputs, we do not suffer from the large performance trade-offs seen with the previous solutions (degradation on in-domain performance as out-of-domain performance increases, see each model vs. ‚Äúreference‚Äù).\nOur result on out-of-domain data, as we vary the number of fine-tuning steps (last two rows), suggests that over‚Äìfine-tuning on COCO Captions may incur a cost in terms of poor generalization.\n\nA second set of results is reported in Table [6]Table 6 ‚Ä£ 3.3 Implementation Details ‚Ä£ 3 Evaluating Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\").\nWe observe that, even when the task requires the generation of much longer captions for LocNar, CC12M achieves superior performance (as measured by CIDEr) compared to CC3M as pretraining data.\nHowever, the gain is smaller compared to the one observed for nocaps.\nWe attribute this to the fact that injecting novel concepts into longer texts is harder, and also the fact that LocNar does not use priming in their annotation process, leading to more generic terms in their annotation (‚Äúmusical instruments‚Äù vs. ‚Äútrumpets‚Äù).\n\nFinally, we fine-tune our best pre-trained model (ic on CC12M) using CC3M in Table [7]Table 7 ‚Ä£ 3.3 Implementation Details ‚Ä£ 3 Evaluating Vision-and-Language Pre-Training Data ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\"), and then evaluate on the dev split.\nWe find that we improve the CIDEr score on the dev split from 100.9 to 105.4 (+4.5 CIDER points).\nWe note that the model trained on CC12M and evaluated directly on the CC3M dev set (without fine-tuning on the CC3M train split) obtains a low dev CIDEr of 39.3.\nThis again indicates that the additional processing steps done for CC3M (e.g., hypernimization) result in captions that are different enough from the ones in CC12M to require a fine-tuning step.\n\n| Pretraining | Finetuning | Flickr30K |\n| data | data | test |\n|  |  | R1 | R5 | R10 |\n| None | Flickr30K | 43.7 | 74.8 | 84.1 |\n| CC3M | None | 35.4 | 65.2 | 76.2 |\n| CC12M | None | 42.5 | 73.1 | 83.4 |\n| CC3M+CC12M | None | 47.1 | 76.4 | 83.4 |\n| CC3M | Flickr30K | 52.3 | 81.7 | 88.4 |\n| CC12M | Flickr30K | 58.5 | 86.6 | 92.1 |\n| CC3M+CC12M | Flickr30K | 61.5 | 87.5 | 92.8 |\n| Pretraining | Finetuning | LocNar Flickr30K |\n| data | data | test |\n|  |  | R1 | R5 | R10 |\n| None | LocNar Flickr30K | 54.5 | 85.0 | 91.0 |\n| CC3M | LocNar Flickr30K | 61.1 | 88.2 | 93.7 |\n| CC12M | LocNar Flickr30K | 70.2 | 92.1 | 95.6 |\n| CC3M+CC12M | LocNar Flickr30K | 71.0 | 93.0 | 97.0 |\n\nTable 8: Image retrieval on Flickr30K and LocNar Flickr30K\n\n### 4.2 Vision-and-Language Matching\n\nTable [8]Table 8 ‚Ä£ 4.1 Vision-to-Language Generation ‚Ä£ 4 Experimental Results ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\") reports zero-shot and default IR performance on Flickr30K as well as default IR performance on LocNar Flickr30K.\nThe results are consistent with those in vision-to-language generation. First, both CC3M and CC12M are beneficial, improving over ‚Äúfrom-scratch‚Äù training (Pretraining data as ‚ÄúNone‚Äù) by at least 8.6% and 6.6% in R1 on Flickr30K and LocNar Flickr30K, respectively.\nAdditionally, CC12M significantly outperforms CC3M in all cases. Finally, combining the two datasets (CC3M+CC12M) results in even better performance.\nWe provide qualitative results and additional discussion in the supplementary material.\n\nOur zero-shot IR results (the three rows in Table [8]Table 8 ‚Ä£ 4.1 Vision-to-Language Generation ‚Ä£ 4 Experimental Results ‚Ä£ Conceptual 12M: Pushing Web-Scale Image-Text Pre-Training To Recognize Long-Tail Visual Concepts\") with fine-tuning data as ‚ÄúNone‚Äù) are also competitive to the state-of-the-art, despite the fact that our model is much smaller (6 layers of transformers of hidden layer size 512 with 8 attention heads vs. 12 layers of size 768 with 12 attention heads) and uses late fusion instead of early fusion.\nIn particular, our zero-shot IR on CC3M outperforms the one in ViLBERT \\[ [55])\\] (35.4 vs. 31.9 in R1),\nwhile the CC12M performance goes up by +7.1% R1 to 42.5, and an additional +4.6% R1 to 47.1 when using CC3M+CC12M, surpassing the ‚Äúfrom-scratch‚Äù setting.",
            "citations": null
          },
          "5 Related Work": {
            "content": "V+L Pre-training.\nV+L pre-training research makes use existing large-scale datasets with image-text pairs.\nA majority of these resources are image captioning datasets.\nCC3M \\[ [70])\\] has been the most popular for pre-training \\[ [55]), [56]), [3]), [74]), [88]), [48]), [21]), [50])\\].\nSmaller but less noisy SBU Captions \\[ [61])\\] (1ÃÉM) and COCO Captions \\[ [20])\\] (106K) datasets are also of high interest.\nSome work  \\[ [77]), [21]), [50])\\] use V+L resources collected for dense captioning or visual question answering (VQA), such as VG \\[ [44])\\], VQA2 \\[ [27])\\], and GQA \\[ [34])\\].\nIn contrast, CC12M is not collected for specific target tasks, and thus it is order-of-magnitude larger than those datasets.444Recently appearing after we submitted our paper, ALIGN \\[ [36])\\], CLIP \\[ [65])\\], WIT \\[ [72])\\], WenLan \\[ [35])\\] all explore enlarging Web-scale data for V+L pre-training with success (albeit with different focuses), further confirming our intuition that scale is a critical factor.\nFurthermore, it is much more visually diverse, especially given the fact that COCO Captions, VG, VQA2, GQA are built on top of COCO images \\[ [52])\\] or its subsets.\n\nObjectives in V+L pre-training research are largely influenced by BERT \\[ [25])\\].\nMasked language modeling has been extended to visual region inputs, while the next sentence prediction is analogous to vlm. Based directly upon BERT, V+L pre-training research has largely been focused on V+L _understanding_\\[ [55]), [49]), [21]), [77]), [3]), [74]), [48]), [56])\\], with classification or regression tasks that do not involve generation.\nOne exception is UnifiedVL \\[ [88])\\], which pre-trains a unified architecture for both image captioning (generation) and VQA (understanding). Our work focuses on simpler objectives and consider one at a time. This allows for a ‚Äúclean‚Äù study of the effect of pre-training data sources. At the same time, we also pre-train vision-to-language generation and encoder-decoder jointly as opposed to an encoder-only setup.\nOur work also shows that ic is a strong objective for vision-to-language generation with respect to the widely-used masking-based objectives. Consistent with our results, ic is successfully adopted for learning visual representations for lower-level vision tasks \\[ [24])\\].\n\nLong-tail Visual Recognition in V+L.\nAddressing long-tail distributions of visual concepts is an important component of V+L systems that generalize, as long and free-form texts exhibit a large number of compositional, fine-grained categories \\[ [89]), [54]), [19])\\]. Our work focuses on downstream testbeds for V+L research that require this adaptation ability. For example, the train-test distribution discrepancy in nocaps exists in both visual (COCO vs. Open Images) and textual domains (80 to object classes vs. 600 classes). The same can be said for zero-shot image retrieval \\[ [55])\\], in which the model must generalize visually and textually from the pre-training data sources of CC3M or CC12M to Flickr30K. Our work identifies pre-training with large-scale noisy data as a promising solution. In addition, for the task noval object captioning, our approach works more robustly across in- and out-of- domain scenarios and is simpler than the state-of-the-art techniques that utilize constrained beam search (CBS) \\[ [5])\\], finite state machine construction plus CBS \\[ [6])\\], generating slot-filling templates \\[ [57]), [81])\\], and copying mechanisms \\[ [83])\\].",
            "citations": null
          },
          "6 Conclusion": {
            "content": "We introduce the new V+L pre-training resource CC12M, obtained by extending the pipeline in \\[ [70])\\].\nWe show that the scale and diversity of V+L pre-training matters on both generation and matching, especially on benchmarks that require long-tail recognition such as nocaps. Our results indicate leveraging noisy Web-scale image-text pairs as a promising direction for V+L research.\n\nAcknowledgments.\nWe thank Peter Anderson for his feedback on earlier version of the draft, Bo Pang, Zhenhai Zhu for helpful discussions, Sebastian Goodman and Ashish V. Thapliyal for help with model implementation, Chris Alberti for help with the data collection pipeline, and Harsh Agrawal for detail on nocaps.",
            "citations": null
          }
        },
        "abstract": "The availability of large-scale image captioning and visual question\nanswering datasets has contributed significantly to recent successes in\nvision-and-language pre-training. However, these datasets are often collected\nwith overrestrictive requirements inherited from their original target tasks\n(e.g., image caption generation), which limit the resulting dataset scale and\ndiversity. We take a step further in pushing the limits of vision-and-language\npre-training data by relaxing the data collection pipeline used in Conceptual\nCaptions 3M (CC3M) [Sharma et al. 2018] and introduce the Conceptual 12M\n(CC12M), a dataset with 12 million image-text pairs specifically meant to be\nused for vision-and-language pre-training. We perform an analysis of this\ndataset and benchmark its effectiveness against CC3M on multiple downstream\ntasks with an emphasis on long-tail visual recognition. Our results clearly\nillustrate the benefit of scaling up pre-training data for vision-and-language\ntasks, as indicated by the new state-of-the-art results on both the nocaps and\nConceptual Captions benchmarks."
      }
    },
    "key_map": {
      "1812.08658": "bib.bib1",
      "2303.10457": "bib.bib2",
      "2102.08981": "bib.bib5"
    }
  }
}